# GitLab Auto DevOps - VersÃ£o CompatÃ­vel
# IntegrÃ¡vel com .gitlab-ci.yml existente
# Ativa recursos avanÃ§ados de deployment quando necessÃ¡rio

# Este arquivo pode ser incluÃ­do opcionalmente no .gitlab-ci.yml
# para adicionar recursos de Auto DevOps sem conflitos

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURAÃ‡ÃƒO AUTO DEVOPS COMPATÃVEL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# SÃ³ incluir Auto DevOps se explicitamente habilitado
include:
  - template: Auto-DevOps.gitlab-ci.yml
  - local: '.gitlab-ci.yml'  # Manter configuraÃ§Ã£o base

variables:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CONFIGURAÃ‡ÃƒO AUTO DEVOPS (SOMENTE QUANDO HABILITADO)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Plataforma de deploy (obrigatÃ³rio para Auto DevOps)
  AUTO_DEVOPS_PLATFORM_TARGET: "KUBERNETES"

  # DomÃ­nio base (configurar no GitLab > Settings > CI/CD > Variables)
  # Para Minikube: Use o IP do minikube com nip.io
  # Exemplo: 192.168.49.2.nip.io
  # Para GKE: Use seu domÃ­nio real
  # Exemplo: assistente-juridico.com
  KUBE_INGRESS_BASE_DOMAIN: "$KUBE_INGRESS_BASE_DOMAIN"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ESTRATÃ‰GIA DE DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Habilitar staging (ambiente de teste antes da produÃ§Ã£o)
  STAGING_ENABLED: "1"

  # Modo de rollout incremental
  # OpÃ§Ãµes: "manual" ou "timed"
  INCREMENTAL_ROLLOUT_MODE: "manual"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SERVIÃ‡OS (DESABILITAR OS NÃƒO USADOS)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # PostgreSQL (desabilitado - usando Upstash Redis)
  POSTGRES_ENABLED: "false"

  # Redis (desabilitado - usando Upstash Redis)
  REDIS_ENABLED: "false"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CONTAINER REGISTRY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # GitLab Container Registry (automÃ¡tico)
  CI_REGISTRY: "registry.gitlab.com"
  CI_REGISTRY_IMAGE: "registry.gitlab.com/$CI_PROJECT_PATH"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD (CompatÃ­vel com configuraÃ§Ã£o existente)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Node.js version (compatÃ­vel com .gitlab-ci.yml)
  NODE_ENV: "production"

  # Docker buildkit (build mais rÃ¡pido)
  DOCKER_BUILDKIT: "1"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECURITY & TESTING (Complementar ao existente)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # SAST (jÃ¡ habilitado no .gitlab-ci.yml)
  SAST_DISABLED: "false"

  # Dependency Scanning (complementar ao npm audit)
  DEPENDENCY_SCANNING_DISABLED: "false"

  # Container Scanning
  CONTAINER_SCANNING_DISABLED: "false"

  # DAST (Dynamic Application Security Testing)
  DAST_DISABLED: "true"  # Desabilitado por padrÃ£o (requer app rodando)

  # License Scanning
  LICENSE_MANAGEMENT_DISABLED: "false"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PERFORMANCE & MONITORING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Performance testing
  PERFORMANCE_DISABLED: "true"

  # Browser Performance
  BROWSER_PERFORMANCE_DISABLED: "true"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # REVIEW APPS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Habilitar Review Apps (ambientes temporÃ¡rios por MR)
  REVIEW_DISABLED: "false"

  # Tempo de vida das Review Apps (7 dias)
  REVIEW_APP_TTL: "168h"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGES ADICIONAIS (Complementam os stages existentes)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

stages:
  - security      # Do .gitlab-ci.yml
  - test         # Do .gitlab-ci.yml
  - build        # Do .gitlab-ci.yml
  - deploy       # Novo - Auto DevOps
  - review       # Novo - Review Apps
  - dast         # Novo - Dynamic Application Security Testing
  - staging      # Novo - Ambiente de staging
  - canary       # Novo - Canary deployments
  - production   # Novo - ProduÃ§Ã£o
  - incremental rollout 10%   # Novo - Rollout incremental
  - incremental rollout 25%   # Novo - Rollout incremental
  - incremental rollout 50%   # Novo - Rollout incremental
  - incremental rollout 100%  # Novo - Rollout incremental
  - performance  # Novo - Performance testing
  - cleanup      # Novo - Limpeza

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# OVERRIDE DE JOBS PARA COMPATIBILIDADE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Sobrescrever job de build para usar nossa configuraÃ§Ã£o
build:
  extends: .auto-devops-build
  image: node:22
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ—ï¸ Build customizado para React/TypeScript..."
    - npm run build
    - |
      # Preparar para containerizaÃ§Ã£o
      if [ -d "dist" ]; then
        echo "âœ… Build concluÃ­do - pronto para deploy"
      else
        echo "âŒ Build falhou - diretÃ³rio dist nÃ£o encontrado"
        exit 1
      fi

# Sobrescrever job de test para usar nossa configuraÃ§Ã£o
test:
  extends: .auto-devops-test
  image: node:22
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ§ª Executando testes customizados..."
    - npm run test:run
    - npm run test:api
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: coverage/junit-report.xml
    paths:
      - coverage/
    expire_in: 1 week

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOBS ADICIONAIS PARA DEPLOYMENT AVANÃ‡ADO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Deploy para staging (antes da produÃ§Ã£o)
staging:
  extends: .auto-devops-deploy-staging
  environment:
    name: staging
    url: https://staging-assistente-juridico-p.vercel.app
  before_script:
    - echo "ğŸ­ Preparando deploy para staging..."
  script:
    - echo "ğŸš€ Deploying to staging environment..."
    - |
      # Deploy para Vercel staging
      npx vercel --yes --prod=false
      echo "âœ… Staging deploy concluÃ­do"
  dependencies:
    - build
  only:
    - develop
    - main

# Deploy para produÃ§Ã£o com aprovaÃ§Ã£o manual
production:
  extends: .auto-devops-deploy-production
  environment:
    name: production
    url: https://assistente-juridico-p.vercel.app
  before_script:
    - echo "ğŸ¯ Preparando deploy para produÃ§Ã£o..."
  script:
    - echo "ğŸš€ Deploying to production environment..."
    - |
      # Deploy para Vercel produÃ§Ã£o
      npx vercel --prod --yes
      echo "âœ… Production deploy concluÃ­do!"
  dependencies:
    - build
    - staging
  only:
    - main
  when: manual

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KUBERNETES CUSTOMIZATION (Se usar K8s)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Se vocÃª precisa customizar os manifestos K8s gerados automaticamente,
# crie um arquivo: .gitlab/auto-deploy-values.yaml
#
# Exemplo de customizaÃ§Ãµes:
# - Limites de recursos para Node.js
# - VariÃ¡veis de ambiente
# - Health checks especÃ­ficos
# - Ingress annotations

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MONITORAMENTO E NOTIFICAÃ‡Ã•ES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Notificar sucesso/falha do pipeline
.pipeline-success:
  script:
    - echo "ğŸ‰ Pipeline Auto DevOps succeeded!"
    - echo "ğŸ“Š AplicaÃ§Ã£o disponÃ­vel em: https://assistente-juridico-p.vercel.app"
  when: on_success

.pipeline-failure:
  script:
    - echo "âŒ Pipeline Auto DevOps failed!"
    - echo "ğŸ” Verifique os logs para detalhes"
  when: on_failure

# Aplicar notificaÃ§Ãµes aos jobs relevantes
build:
  after_script:
    - !reference [.pipeline-success, script]
    - !reference [.pipeline-failure, script]

production:
  after_script:
    - !reference [.pipeline-success, script]
    - !reference [.pipeline-failure, script]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INSTRUÃ‡Ã•ES DE USO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Para usar este arquivo:
# 1. Renomeie para .gitlab-ci-auto-devops.yml
# 2. No .gitlab-ci.yml, adicione:
#    include:
#      - local: '.gitlab-ci-auto-devops.yml'
# 3. Configure as variÃ¡veis necessÃ¡rias no GitLab CI/CD Settings
# 4. Teste o pipeline em uma branch de desenvolvimento primeiro

# Este arquivo Ã© projetado para ser usado OPCIONALMENTE,
# mantendo a configuraÃ§Ã£o bÃ¡sica funcionando perfeitamente.