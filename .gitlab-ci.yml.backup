# CI/CD Pipeline para Assistente Jur√≠dico PJe
# Pipeline completo usando componentes reutiliz√°veis GitLab CI/CD
# Otimizado para aplica√ß√µes React/TypeScript com foco jur√≠dico

stages:
  - security
  - test
  - build
  - deploy
  - monitor

# Configura√ß√µes globais
variables:
  NODE_VERSION: "22"
  NODE_ENV: "production"
  FF_USE_FASTZIP: "true"
  CACHE_COMPRESSION_LEVEL: "fast"
  GIT_DEPTH: 10
  GIT_LFS_SKIP_SMUDGE: "1"
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: none
  NPM_CACHE_DIR: "$CI_PROJECT_DIR/.npm"

# Cache global para depend√™ncias Node.js
cache:
  key: "npm-cache-v2-${CI_COMMIT_REF_SLUG}"
  paths:
    - .npm/
    - node_modules/

# Componentes CI/CD reutiliz√°veis
include:
  # Componente de Seguran√ßa - Auditoria completa com compliance LGPD
  - component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/templates/security/security-component@1.1.0
    inputs:
      stage: security
      audit_level: "standard"
      fail_on_high: true
      report_format: "json"

  # Componente de Testes - Suite completa para React/TypeScript
  - component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/templates/testing/testing-component@1.1.0
    inputs:
      stage: test
      test_type: "all"
      coverage_threshold: 80
      fail_on_coverage: false
      browser: "chromium"

  # Componente de Deployment - Multi-plataforma com health checks
  - component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/templates/deployment/deployment-component@1.1.0
    inputs:
      stage: deploy
      environment: "staging"
      deploy_target: "vercel"
      health_check_url: "https://assistente-juridico-p.vercel.app"
      rollback_on_failure: true
      monitoring_enabled: true

  # Componente de Monitoramento - Performance e disponibilidade
  - component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/templates/monitoring/monitoring-component@1.1.0
    inputs:
      stage: monitor
      monitoring_type: "advanced"
      alert_on_failure: true
      performance_baseline: 3000
      accessibility_threshold: 90

# Job adicional: Build da aplica√ß√£o
build:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "üèóÔ∏è Construindo aplica√ß√£o React/TypeScript..."
    - npm run build
    - echo "üì¶ Build conclu√≠do com sucesso!"
    - echo "üìä Tamanho do bundle:"
    - du -sh dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop
  dependencies: []

# Job adicional: Lint e formata√ß√£o
lint:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "üîç Executando linting e verifica√ß√µes de c√≥digo..."
    - npm run lint
    - echo "‚úÖ Linting conclu√≠do sem erros!"
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    paths:
      - gl-code-quality-report.json
    expire_in: 1 week
    when: always
  only:
    - merge_requests
    - main
    - develop
  allow_failure: false

# Job adicional: Verifica√ß√µes de seguran√ßa adicionais
security-scan:
  stage: security
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "üîê Executando verifica√ß√µes de seguran√ßa adicionais..."
    - |
      # Verificar se h√° arquivos sens√≠veis no reposit√≥rio
      if find . -name "*.env*" -o -name "*secret*" -o -name "*key*" | grep -v node_modules | grep -v .git; then
        echo "‚ö†Ô∏è Poss√≠veis arquivos sens√≠veis encontrados!"
        exit 1
      else
        echo "‚úÖ Nenhum arquivo sens√≠vel detectado"
      fi
    - |
      # Verificar configura√ß√µes de seguran√ßa no c√≥digo
      if grep -r "console.log\|debugger" src/ --include="*.ts" --include="*.tsx" | grep -v node_modules; then
        echo "‚ö†Ô∏è C√≥digo de debug encontrado em produ√ß√£o!"
        exit 1
      else
        echo "‚úÖ Nenhum c√≥digo de debug encontrado"
      fi
  only:
    - merge_requests
    - main
    - develop
  allow_failure: false

# Job adicional: Testes de carga b√°sicos
load-test:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - echo "‚ö° Executando testes de carga b√°sicos..."
    - |
      # Simula√ß√£o b√°sica de carga
      for i in {1..10}; do
        curl -s -o /dev/null -w "Request $i: %{time_total}s\n" http://localhost:5173 &
      done
      wait
      echo "‚úÖ Testes de carga conclu√≠dos"
  services:
    - name: nginx:alpine
      command: ["nginx", "-c", "/etc/nginx/nginx.conf", "-g", "daemon off;"]
  only:
    - main
    - develop
  allow_failure: true

# Job adicional: Deploy para produ√ß√£o (manual)
deploy-production:
  stage: deploy
  image: node:${NODE_VERSION}
  environment:
    name: production
    url: https://assistente-juridico-p.vercel.app
  script:
    - echo "üöÄ Fazendo deploy para produ√ß√£o..."
    - npm ci --cache .npm --prefer-offline
    - npm run build
    - |
      # Deploy para Vercel produ√ß√£o
      npx vercel --prod --yes
      echo "‚úÖ Deploy para produ√ß√£o conclu√≠do!"
  dependencies:
    - build
  only:
    - main
  when: manual
  allow_failure: false

# Job adicional: Deploy de Review Apps (Aplicativos de Avalia√ß√£o)
deploy-review:
  stage: deploy
  image: node:${NODE_VERSION}
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: https://$CI_COMMIT_REF_SLUG-assistente-juridico-p.vercel.app
    on_stop: stop-review
    auto_stop_in: 1 week
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "üîç Fazendo deploy do Review App para branch: $CI_COMMIT_REF_NAME"
    - echo "üåê URL do Review App: https://$CI_COMMIT_REF_SLUG-assistente-juridico-p.vercel.app"
    - npm run build
    - |
      # Deploy para Vercel com nome √∫nico baseado na branch
      export VERCEL_PROJECT_NAME="assistente-juridico-p-$CI_COMMIT_REF_SLUG"
      npx vercel --yes --prod=false
      echo "‚úÖ Review App deploy conclu√≠do!"
      echo "üîó Acesse: https://$CI_COMMIT_REF_SLUG-assistente-juridico-p.vercel.app"
  dependencies:
    - build
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_BRANCH =~ /^feature\//
      when: always
    - if: $CI_COMMIT_BRANCH =~ /^review\//
      when: always
  allow_failure: true
  artifacts:
    reports:
      dotenv: build.env
    paths:
      - .vercel/
    expire_in: 1 week

# Job adicional: Parar Review Apps manualmente
stop-review:
  stage: deploy
  image: node:${NODE_VERSION}
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  script:
    - echo "üõë Parando Review App para branch: $CI_COMMIT_REF_NAME"
    - |
      # Remover deployment do Vercel
      export VERCEL_PROJECT_NAME="assistente-juridico-p-$CI_COMMIT_REF_SLUG"
      npx vercel rm --yes $VERCEL_PROJECT_NAME || echo "Review App j√° removido ou n√£o encontrado"
      echo "‚úÖ Review App parado com sucesso!"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
    - if: $CI_COMMIT_BRANCH =~ /^feature\//
      when: manual
    - if: $CI_COMMIT_BRANCH =~ /^review\//
      when: manual
  allow_failure: true
  dependencies: []

# Job adicional: Backup de dados (semanal)
backup:
  stage: monitor
  image: node:${NODE_VERSION}
  script:
    - echo "üíæ Executando backup de dados..."
    - |
      # Simula√ß√£o de backup (integrar com Upstash, etc.)
      echo "üì¶ Backup conclu√≠do em $(date)" > backup-log.txt
      echo "‚úÖ Backup executado com sucesso"
  artifacts:
    paths:
      - backup-log.txt
    expire_in: 1 week
  only:
    - schedules
  allow_failure: true

# Job adicional: Relat√≥rio consolidado do pipeline
pipeline-report:
  stage: monitor
  image: node:${NODE_VERSION}
  script:
    - echo "üìä Gerando relat√≥rio consolidado do pipeline..."
    - |
      echo "# Relat√≥rio de Pipeline - Assistente Jur√≠dico PJe" > pipeline-report.md
      echo "" >> pipeline-report.md
      echo "## üìã Informa√ß√µes Gerais" >> pipeline-report.md
      echo "- **Pipeline ID**: $CI_PIPELINE_ID" >> pipeline-report.md
      echo "- **Commit**: $CI_COMMIT_SHA" >> pipeline-report.md
      echo "- **Branch**: $CI_COMMIT_REF_NAME" >> pipeline-report.md
      echo "- **Data**: $(date)" >> pipeline-report.md
      echo "" >> pipeline-report.md
      echo "## ‚úÖ Status dos Stages" >> pipeline-report.md
      echo "- **Security**: Executado" >> pipeline-report.md
      echo "- **Test**: Executado" >> pipeline-report.md
      echo "- **Build**: Executado" >> pipeline-report.md
      echo "- **Deploy**: Executado" >> pipeline-report.md
      echo "- **Monitor**: Executado" >> pipeline-report.md
      echo "" >> pipeline-report.md
      echo "## üîó Links Importantes" >> pipeline-report.md
      echo "- [Pipeline no GitLab]($CI_PIPELINE_URL)" >> pipeline-report.md
      echo "- [Commit]($CI_PROJECT_URL/-/commit/$CI_COMMIT_SHA)" >> pipeline-report.md
      echo "- [MR]($CI_MERGE_REQUEST_TARGET_PROJECT_URL/-/merge_requests/$CI_MERGE_REQUEST_IID)" >> pipeline-report.md
    - cat pipeline-report.md
  artifacts:
    paths:
      - pipeline-report.md
    expire_in: 1 week
  when: always
  dependencies: []

# Configura√ß√µes espec√≠ficas para diferentes branches
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      variables:
        DEPLOY_ENV: "production"
    - if: $CI_COMMIT_BRANCH == "develop"
      variables:
        DEPLOY_ENV: "staging"
    - if: $CI_MERGE_REQUEST_ID
      variables:
        DEPLOY_ENV: "preview"
    - when: always
