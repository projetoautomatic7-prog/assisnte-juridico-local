# ========================================
# ü§ñ Automa√ß√µes GitPod Ona Cloud
# Assistente Jur√≠dico PJe
# ========================================

# Configura√ß√£o do ambiente
environment:
  name: "Assistente Jur√≠dico PJe - Development"
  timezone: "America/Sao_Paulo"
  locale: "pt_BR.UTF-8"

# ========================================
# üì¶ INICIALIZA√á√ÉO DO WORKSPACE
# ========================================
init:
  - name: "Instalar Depend√™ncias"
    command: |
      echo "üì¶ Instalando depend√™ncias do projeto..."
      npm install --legacy-peer-deps
      cd backend && npm install --legacy-peer-deps

  - name: "Configurar Vari√°veis de Ambiente"
    command: |
      echo "üîß Configurando ambiente..."
      if [ ! -f .env ]; then
        cp .env.example .env
        echo "‚úÖ Arquivo .env criado"
      fi

  - name: "Configurar Git"
    command: |
      echo "üîß Configurando Git..."
      git config --global --add safe.directory /workspaces/assistente-jur-dico-principalrepli
      git config pull.rebase false

# ========================================
# üöÄ TAREFAS AUTOM√ÅTICAS
# ========================================
tasks:
  # Desenvolvimento Frontend
  - name: "Dev: Frontend"
    schedule: "startup"
    command: "npm run dev"
    type: "background"
    port: 5173
    description: "Servidor de desenvolvimento Vite"

  # Desenvolvimento Backend
  - name: "Dev: Backend"
    schedule: "startup"
    command: "cd backend && npm run dev"
    type: "background"
    port: 3001
    description: "Servidor backend Express + LangGraph"

  # Verifica√ß√£o de Tipos
  - name: "TypeScript Watch"
    schedule: "startup"
    command: "npx tsc --noEmit --watch"
    type: "background"
    description: "Monitoramento cont√≠nuo de tipos TypeScript"

  # Testes Unit√°rios
  - name: "Testes Watch"
    schedule: "manual"
    command: "npm run test"
    type: "background"
    description: "Execu√ß√£o cont√≠nua de testes Vitest"

  # Lint Auto-Fix (a cada 5 minutos)
  - name: "Auto Lint Fix"
    schedule: "*/5 * * * *"
    command: "npm run lint:fix || true"
    type: "cron"
    description: "Corre√ß√£o autom√°tica de lint a cada 5 minutos"

# ========================================
# üîç MONITORAMENTO E AN√ÅLISE
# ========================================
monitoring:
  # SonarQube Analysis (a cada 30 minutos)
  - name: "SonarQube Auto-An√°lise"
    schedule: "*/30 * * * *"
    command: |
      if [ -f scripts/sonar-auto-analyze.sh ]; then
        chmod +x scripts/sonar-auto-analyze.sh
        ./scripts/sonar-auto-analyze.sh --fix 2>&1 | tee -a .sonar-results/auto-analyze.log
      fi
    type: "cron"

  # Health Check dos Agentes
  - name: "Agentes Health Check"
    schedule: "*/15 * * * *"
    command: |
      if [ -f health-check-agents.sh ]; then
        chmod +x health-check-agents.sh
        ./health-check-agents.sh
      fi
    type: "cron"

# ========================================
# üß™ TESTES E VALIDA√á√ÉO
# ========================================
testing:
  # Testes E2E (Playwright)
  - name: "Testes E2E"
    schedule: "manual"
    command: "npm run test:e2e"
    description: "Executar testes end-to-end com Playwright"

  # Testes de API
  - name: "Testes de API"
    schedule: "manual"
    command: "npm run test:api"
    description: "Executar testes de API"

  # Cobertura de Testes
  - name: "Coverage Report"
    schedule: "manual"
    command: "npm run test:coverage"
    description: "Gerar relat√≥rio de cobertura de testes"

# ========================================
# üî® BUILD E DEPLOY
# ========================================
build:
  # Build de Produ√ß√£o
  - name: "Build Production"
    command: "npm run build:deploy"
    description: "Build completo para produ√ß√£o"

  # Preview Local
  - name: "Preview Production"
    command: "npm run preview"
    type: "background"
    port: 4173
    description: "Preview do build de produ√ß√£o"

  # Teste Local de Produ√ß√£o
  - name: "Test Production Locally"
    command: "npm run start:production"
    type: "background"
    port: 3001
    description: "Testar build em ambiente de produ√ß√£o local"

# ========================================
# üêõ DEBUG E FERRAMENTAS
# ========================================
debug:
  # Debug Auto-Fix
  - name: "Auto Debug Fix"
    schedule: "manual"
    command: |
      if [ -f auto-debug-fix.sh ]; then
        chmod +x auto-debug-fix.sh
        ./auto-debug-fix.sh
      fi

  # Validar Configura√ß√£o
  - name: "Validar Setup"
    schedule: "manual"
    command: |
      echo "üîç Validando configura√ß√£o do projeto..."
      npm run type-check
      npm run lint
      echo "‚úÖ Valida√ß√£o conclu√≠da"

# ========================================
# üìä PORTAS EXPOSTAS
# ========================================
ports:
  - port: 5173
    visibility: "public"
    name: "Frontend (Vite)"
    protocol: "http"

  - port: 3001
    visibility: "public"
    name: "Backend (Express)"
    protocol: "http"

  - port: 4173
    visibility: "public"
    name: "Preview"
    protocol: "http"

  - port: 51204
    visibility: "private"
    name: "Vitest UI"
    protocol: "http"

# ========================================
# üîê SEGURAN√áA E PERMISS√ïES
# ========================================
security:
  workspace_trust: true
  auto_approve_tasks: true
  allow_terminal_access: true

# ========================================
# üéØ COMANDOS R√ÅPIDOS
# ========================================
shortcuts:
  - name: "Verifica√ß√£o Completa"
    command: "npm run type-check && npm run lint && npm run test:run"
    description: "Executa verifica√ß√£o completa do c√≥digo"

  - name: "Limpar Cache"
    command: "rm -rf node_modules/.vite .eslintcache && npm install"
    description: "Limpa cache e reinstala depend√™ncias"

  - name: "Reset Git"
    command: "git reset --hard && git clean -fd"
    description: "‚ö†Ô∏è Reset completo do Git (cuidado!)"

  - name: "Logs Backend"
    command: "tail -f backend/logs/*.log"
    description: "Visualizar logs do backend em tempo real"

# ========================================
# üìù NOTIFICA√á√ïES
# ========================================
notifications:
  on_startup_complete:
    message: "üöÄ Assistente Jur√≠dico PJe est√° pronto!"
    sound: true

  on_build_success:
    message: "‚úÖ Build conclu√≠do com sucesso"

  on_build_fail:
    message: "‚ùå Falha no build - verifique os logs"
    sound: true

  on_test_fail:
    message: "‚ö†Ô∏è Testes falharam - execute `npm run test:run` para detalhes"

# ========================================
# üîÑ PRE-BUILD CACHE
# ========================================
prebuild:
  enabled: true
  schedule: "0 4 * * *" # Diariamente √†s 04:00
  commands:
    - "npm install --legacy-peer-deps"
    - "cd backend && npm install --legacy-peer-deps"
    - "npm run build"
  cache_key: "node-modules-{{ checksum('package-lock.json') }}-{{ checksum('backend/package-lock.json') }}"

# ========================================
# üì¶ EXTENS√ïES RECOMENDADAS
# ========================================
extensions:
  required:
    - "GitHub.copilot"
    - "GitHub.copilot-chat"
    - "dbaeumer.vscode-eslint"
    - "esbenp.prettier-vscode"
    - "bradlc.vscode-tailwindcss"

  recommended:
    - "ms-playwright.playwright"
    - "SonarSource.sonarlint-vscode"
    - "GitHub.vscode-pull-request-github"

# ========================================
# üåê CONFIGURA√á√ïES DE REDE
# ========================================
network:
  proxy: false
  dns:
    - "8.8.8.8"
    - "8.8.4.4"

# ========================================
# üíæ BACKUP E RECUPERA√á√ÉO
# ========================================
backup:
  enabled: true
  schedule: "0 */6 * * *" # A cada 6 horas
  targets:
    - ".env"
    - ".env.local"
    - "backend/.env"
    - "data/**"

# ========================================
# üìà M√âTRICAS E ANALYTICS
# ========================================
metrics:
  enabled: true
  track:
    - build_time
    - test_duration
    - startup_time
    - memory_usage
    - cpu_usage
