<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAG System - Cliente Demo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2em;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    .section h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.3em;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s;
    }
    button:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 1em;
      transition: border-color 0.3s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    .result pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 0.9em;
      color: #333;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: #e8f4f8;
      border-radius: 8px;
    }
    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
    }
    .error {
      background: #fee;
      border-left-color: #f00;
      color: #c00;
    }
    .success {
      background: #efe;
      border-left-color: #0f0;
      color: #060;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ Sistema RAG - Assistente Jur√≠dico</h1>
    <p class="subtitle">Demonstra√ß√£o de integra√ß√£o com Firebase Cloud Functions</p>

    <!-- Login Section -->
    <div id="signin" class="section">
      <h2>üîê Autentica√ß√£o</h2>
      <button id="signinBtn">Entrar com Google</button>
    </div>

    <!-- User Info (hidden initially) -->
    <div id="userInfo" class="user-info" hidden>
      <img id="userAvatar" class="user-avatar" />
      <div>
        <div><strong id="userName"></strong></div>
        <div><small id="userEmail"></small></div>
      </div>
      <button id="signoutBtn" style="margin-left: auto;">Sair</button>
    </div>

    <!-- Indexar Documento -->
    <div id="indexSection" class="section" hidden>
      <h2>üìÑ Indexar Documento</h2>
      <input type="text" id="numeroProcesso" placeholder="N√∫mero do processo (ex: 0001234-56.2024.8.13.0001)" />
      <input type="text" id="tipoDocumento" placeholder="Tipo (ex: peti√ß√£o, senten√ßa)" />
      <textarea id="conteudoDocumento" placeholder="Cole o conte√∫do do documento aqui..."></textarea>
      <button id="indexarBtn">Indexar Documento</button>
      <div id="indexResult"></div>
    </div>

    <!-- Processar PDF -->
    <div id="pdfSection" class="section" hidden>
      <h2>üìë Processar PDF</h2>
      <input type="text" id="pdfUrl" placeholder="URL do PDF (ex: https://exemplo.com/arquivo.pdf)" />
      <input type="text" id="numeroProcessoPdf" placeholder="N√∫mero do processo" />
      <input type="text" id="tipoPdf" placeholder="Tipo (ex: senten√ßa)" />
      <button id="processarPdfBtn">Processar PDF</button>
      <div id="pdfResult"></div>
    </div>

    <!-- Buscar -->
    <div id="searchSection" class="section" hidden>
      <h2>üîç Buscar no Qdrant</h2>
      <input type="text" id="queryBusca" placeholder="Digite sua pergunta..." />
      <input type="text" id="numeroProcessoBusca" placeholder="N√∫mero do processo (opcional)" />
      <button id="buscarBtn">Buscar</button>
      <div id="searchResult"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { 
      getAuth, 
      onAuthStateChanged, 
      GoogleAuthProvider, 
      signInWithPopup,
      signOut 
    } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { 
      getFunctions, 
      httpsCallable 
    } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js';

    // Carregar configura√ß√£o do Firebase
    const firebaseConfig = await fetch('/__/firebase/init.json');
    const app = initializeApp(await firebaseConfig.json());
    
    const auth = getAuth(app);
    const functions = getFunctions(app);

    // Elementos DOM
    const signinEl = document.querySelector('#signin');
    const userInfoEl = document.querySelector('#userInfo');
    const indexSectionEl = document.querySelector('#indexSection');
    const pdfSectionEl = document.querySelector('#pdfSection');
    const searchSectionEl = document.querySelector('#searchSection');

    // Autentica√ß√£o
    document.querySelector('#signinBtn').addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
      } catch (error) {
        alert('Erro ao fazer login: ' + error.message);
      }
    });

    document.querySelector('#signoutBtn').addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Usu√°rio logado
        signinEl.hidden = true;
        userInfoEl.hidden = false;
        indexSectionEl.hidden = false;
        pdfSectionEl.hidden = false;
        searchSectionEl.hidden = false;
        
        document.querySelector('#userName').textContent = user.displayName;
        document.querySelector('#userEmail').textContent = user.email;
        document.querySelector('#userAvatar').src = user.photoURL;
      } else {
        // Usu√°rio deslogado
        signinEl.hidden = false;
        userInfoEl.hidden = true;
        indexSectionEl.hidden = true;
        pdfSectionEl.hidden = true;
        searchSectionEl.hidden = true;
      }
    });

    // Indexar Documento
    document.querySelector('#indexarBtn').addEventListener('click', async () => {
      const btn = document.querySelector('#indexarBtn');
      const resultEl = document.querySelector('#indexResult');
      
      btn.disabled = true;
      btn.innerHTML = 'Indexando...<span class="loading"></span>';
      resultEl.innerHTML = '';

      try {
        const indexDocument = httpsCallable(functions, 'indexDocument');
        const result = await indexDocument({
          content: document.querySelector('#conteudoDocumento').value,
          metadata: {
            numeroProcesso: document.querySelector('#numeroProcesso').value,
            tipo: document.querySelector('#tipoDocumento').value,
          }
        });

        resultEl.innerHTML = `
          <div class="result success">
            <strong>‚úÖ Sucesso!</strong>
            <pre>${JSON.stringify(result.data, null, 2)}</pre>
          </div>
        `;
      } catch (error) {
        resultEl.innerHTML = `
          <div class="result error">
            <strong>‚ùå Erro:</strong>
            <pre>${error.message}</pre>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Indexar Documento';
      }
    });

    // Processar PDF
    document.querySelector('#processarPdfBtn').addEventListener('click', async () => {
      const btn = document.querySelector('#processarPdfBtn');
      const resultEl = document.querySelector('#pdfResult');
      
      btn.disabled = true;
      btn.innerHTML = 'Processando...<span class="loading"></span>';
      resultEl.innerHTML = '';

      try {
        const processPDF = httpsCallable(functions, 'processPDF');
        const result = await processPDF({
          pdfUrl: document.querySelector('#pdfUrl').value,
          numeroProcesso: document.querySelector('#numeroProcessoPdf').value,
          tipo: document.querySelector('#tipoPdf').value,
        });

        resultEl.innerHTML = `
          <div class="result success">
            <strong>‚úÖ PDF Processado!</strong>
            <pre>${JSON.stringify(result.data, null, 2)}</pre>
          </div>
        `;
      } catch (error) {
        resultEl.innerHTML = `
          <div class="result error">
            <strong>‚ùå Erro:</strong>
            <pre>${error.message}</pre>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Processar PDF';
      }
    });

    // Buscar
    document.querySelector('#buscarBtn').addEventListener('click', async () => {
      const btn = document.querySelector('#buscarBtn');
      const resultEl = document.querySelector('#searchResult');
      
      btn.disabled = true;
      btn.innerHTML = 'Buscando...<span class="loading"></span>';
      resultEl.innerHTML = '';

      try {
        const searchQdrant = httpsCallable(functions, 'searchQdrant');
        const result = await searchQdrant({
          query: document.querySelector('#queryBusca').value,
          numeroProcesso: document.querySelector('#numeroProcessoBusca').value || undefined,
          limit: 5,
        });

        resultEl.innerHTML = `
          <div class="result">
            <strong>üîç Resultados encontrados:</strong>
            <pre>${JSON.stringify(result.data, null, 2)}</pre>
          </div>
        `;
      } catch (error) {
        resultEl.innerHTML = `
          <div class="result error">
            <strong>‚ùå Erro:</strong>
            <pre>${error.message}</pre>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Buscar';
      }
    });
  </script>
</body>
</html>
