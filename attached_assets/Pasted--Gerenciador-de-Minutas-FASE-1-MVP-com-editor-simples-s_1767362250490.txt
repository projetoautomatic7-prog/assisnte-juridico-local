"""
üìù Gerenciador de Minutas
========================

FASE 1: MVP com editor simples (st.text_area)
Pr√≥ximos passos: Substituir por streamlit-quill para editor WYSIWYG
"""

from datetime import datetime
from typing import Any, Dict, List, Optional

import streamlit as st
from lib.backend_client import BackendClient

# ===========================
# CONSTANTES
# ===========================

TIPOS_MINUTA = ["peticao", "contrato", "parecer", "recurso", "procuracao", "outro"]
STATUS_MINUTA = [
    "rascunho",
    "em-revisao",
    "pendente-revisao",
    "finalizada",
    "arquivada",
]
MSG_EDITOR_VAZIO = "‚ö†Ô∏è O editor est√° vazio."

# ===========================
# FUN√á√ïES AUXILIARES
# ===========================


def buscar_minutas() -> List[Dict[str, Any]]:
    """Busca minutas do backend"""
    try:
        backend = BackendClient()
        return backend.get("/minutas")
    except Exception as e:
        st.error(f"‚ö†Ô∏è Erro ao buscar minutas: {str(e)}")
        return []


def salvar_minuta(minuta: Dict[str, Any]) -> bool:
    """Salva minuta no backend"""
    try:
        backend = BackendClient()
        if minuta.get("id"):
            # Atualizar existente
            backend.put(f"/minutas/{minuta['id']}", minuta)
        else:
            # Criar nova
            backend.post("/minutas", minuta)
        return True
    except Exception as e:
        st.error(f"Erro ao salvar: {str(e)}")
        return False


def deletar_minuta(minuta_id: str) -> bool:
    """Deleta minuta do backend"""
    try:
        response = requests.delete(f"{BACKEND_URL}/api/minutas/{minuta_id}", timeout=5)
        response.raise_for_status()
        return True
    except Exception as e:
        st.error(f"‚ö†Ô∏è Erro ao deletar minuta: {str(e)}")
        return False


def filtrar_minutas(
    minutas: List[Dict[str, Any]],
    status: Optional[str] = None,
    tipo: Optional[str] = None,
    busca: Optional[str] = None,
) -> List[Dict[str, Any]]:
    """Aplica filtros √†s minutas"""
    resultado = minutas.copy()

    if status and status != "Todos":
        resultado = [m for m in resultado if m.get("status") == status]

    if tipo and tipo != "Todos":
        resultado = [m for m in resultado if m.get("tipo") == tipo]

    if busca:
        busca_lower = busca.lower()
        resultado = [
            m
            for m in resultado
            if busca_lower in m.get("titulo", "").lower()
            or busca_lower in m.get("conteudo", "").lower()
            or busca_lower in m.get("autor", "").lower()
        ]

    # Ordenar por data de atualiza√ß√£o (mais recente primeiro)
    resultado.sort(
        key=lambda m: m.get("atualizadoEm", m.get("criadoEm", "")), reverse=True
    )

    return resultado


def get_status_badge(status: str) -> str:
    """Retorna emoji para o status"""
    badges = {
        "rascunho": "üìù",
        "em-revisao": "üëÅÔ∏è",
        "pendente-revisao": "‚è≥",
        "finalizada": "‚úÖ",
        "arquivada": "üì¶",
    }
    return badges.get(status, "üìÑ")


def get_tipo_icon(tipo: str) -> str:
    """Retorna emoji para o tipo"""
    icons = {
        "peticao": "‚öñÔ∏è",
        "contrato": "üìú",
        "parecer": "üíº",
        "recurso": "üîÑ",
        "procuracao": "ü§ù",
        "outro": "üìÑ",
    }
    return icons.get(tipo, "üìÑ")


# ===========================
# STATE MANAGEMENT
# ===========================

# Inicializar session state
if "editing_minuta" not in st.session_state:
    st.session_state.editing_minuta = None

if "refresh_trigger" not in st.session_state:
    st.session_state.refresh_trigger = 0


# ===========================
# T√çTULO E HEADER
# ===========================

st.title("üìù Gerenciador de Minutas")
st.caption("Cria√ß√£o e edi√ß√£o de documentos jur√≠dicos com aux√≠lio de IA")

st.divider()

# ===========================
# SIDEBAR: FILTROS
# ===========================

with st.sidebar:
    st.header("üîç Filtros")

    status_filter = st.selectbox(
        "Status", ["Todos"] + STATUS_MINUTA, key="status_filter"
    )

    tipo_filter = st.selectbox("Tipo", ["Todos"] + TIPOS_MINUTA, key="tipo_filter")

    search_query = st.text_input(
        "Buscar", placeholder="T√≠tulo, conte√∫do, autor...", key="search_query"
    )

    st.divider()

    # Bot√£o de atualizar
    if st.button("üîÑ Atualizar Lista", use_container_width=True):
        st.session_state.refresh_trigger += 1
        st.rerun()

# ===========================
# BUSCAR E FILTRAR MINUTAS
# ===========================

minutas = buscar_minutas()
minutas_filtradas = filtrar_minutas(
    minutas, status=status_filter, tipo=tipo_filter, busca=search_query
)

# ===========================
# LAYOUT MASTER-DETAIL
# ===========================

col_lista, col_editor = st.columns([1, 2])

# ===========================
# COLUNA 1: LISTA DE MINUTAS
# ===========================

with col_lista:
    st.subheader(f"Minutas ({len(minutas_filtradas)})")

    # Bot√£o Nova Minuta
    if st.button("‚ûï Nova Minuta", type="primary", use_container_width=True):
        nova_minuta = {
            "id": None,  # Backend vai gerar o ID
            "titulo": "Nova minuta",
            "tipo": "peticao",
            "conteudo": "",
            "status": "rascunho",
            "autor": "Usu√°rio",
            "criadoEm": datetime.now().isoformat(),
            "atualizadoEm": datetime.now().isoformat(),
            "criadoPorAgente": False,
        }
        st.session_state.editing_minuta = nova_minuta
        st.rerun()

    st.divider()

    # Lista de minutas
    if not minutas_filtradas:
        st.info("üì≠ Nenhuma minuta encontrada com os filtros aplicados.")
    else:
        for minuta in minutas_filtradas:
            with st.container():
                # Header da minuta
                col_icon, col_content = st.columns([1, 8])

                with col_icon:
                    st.markdown(
                        f"<div style='font-size: 2em; text-align: center;'>"
                        f"{get_tipo_icon(minuta.get('tipo', 'outro'))}</div>",
                        unsafe_allow_html=True,
                    )

                with col_content:
                    st.markdown(f"**{minuta.get('titulo', 'Sem t√≠tulo')}**")

                    # Badges
                    badge_status = get_status_badge(minuta.get("status", "rascunho"))
                    st.caption(
                        f"{badge_status} {minuta.get('status', 'rascunho')} ‚Ä¢ "
                        f"{get_tipo_icon(minuta.get('tipo', 'outro'))} {minuta.get('tipo', 'outro')}"
                    )

                    # Se foi criada por agente
                    if minuta.get("criadoPorAgente"):
                        st.caption(f"ü§ñ Criada por: {minuta.get('agenteId', 'IA')}")
                    else:
                        st.caption(f"üë§ Autor: {minuta.get('autor', 'Desconhecido')}")

                # Bot√µes de a√ß√£o
                col_edit, col_delete = st.columns(2)

                with col_edit:
                    if st.button(
                        "‚úèÔ∏è Editar",
                        key=f"edit_{minuta.get('id')}",
                        use_container_width=True,
                    ):
                        st.session_state.editing_minuta = minuta
                        st.rerun()

                with col_delete:
                    if st.button(
                        "üóëÔ∏è Excluir",
                        key=f"delete_{minuta.get('id')}",
                        use_container_width=True,
                    ):
                        result = deletar_minuta(minuta["id"])
                        if result:
                            st.success("‚úÖ Minuta exclu√≠da!")
                            st.session_state.refresh_trigger += 1
                            st.rerun()

                st.divider()

# ===========================
# COLUNA 2: EDITOR
# ===========================

with col_editor:
    if st.session_state.editing_minuta:
        minuta = st.session_state.editing_minuta

        st.subheader("‚úèÔ∏è Editor")

        # Tabs: Editor | Preview | IA | Vari√°veis | Google Docs
        tab_editor, tab_preview, tab_ai, tab_vars, tab_gdocs = st.tabs(
            [
                "üìù Editor",
                "üëÅÔ∏è Preview",
                "ü§ñ Comandos IA",
                "üîß Vari√°veis",
                "üìÑ Google Docs",
            ]
        )

        with tab_editor:
            # Formul√°rio
            titulo = st.text_input(
                "T√≠tulo *", value=minuta.get("titulo", ""), key="edit_titulo"
            )

            col_tipo, col_status = st.columns(2)

            with col_tipo:
                tipo = st.selectbox(
                    "Tipo *",
                    TIPOS_MINUTA,
                    index=TIPOS_MINUTA.index(minuta.get("tipo", "peticao")),
                    key="edit_tipo",
                )

            with col_status:
                status = st.selectbox(
                    "Status *",
                    STATUS_MINUTA,
                    index=STATUS_MINUTA.index(minuta.get("status", "rascunho")),
                    key="edit_status",
                )

            # Badges de Colabora√ß√£o (Simulado)
            if minuta.get("criadoPorAgente"):
                st.info(
                    "ü§ñ **Colabora√ß√£o:** Esta minuta foi iniciada por um Agente de IA."
                )
            else:
                st.info("üë§ **Colabora√ß√£o:** Esta minuta foi iniciada por um Humano.")

            # Editor de conte√∫do
            st.markdown("**Conte√∫do da Minuta**")

            # Importar streamlit-quill
            try:
                from streamlit_quill import st_quill

                # Configura√ß√£o da toolbar
                toolbar_config = [
                    ["bold", "italic", "underline", "strike"],
                    ["blockquote", "code-block"],
                    [{"header": 1}, {"header": 2}],
                    [{"list": "ordered"}, {"list": "bullet"}],
                    [{"script": "sub"}, {"script": "super"}],
                    [{"indent": "-1"}, {"indent": "+1"}],
                    [{"direction": "rtl"}],
                    [{"size": ["small", False, "large", "huge"]}],
                    [{"header": [1, 2, 3, 4, 5, 6, False]}],
                    [{"color": []}, {"background": []}],
                    [{"font": []}],
                    [{"align": []}],
                    ["clean"],
                ]

                conteudo = st_quill(
                    value=minuta.get("conteudo", ""),
                    html=True,
                    key="quill_editor",
                    toolbar=toolbar_config,
                    placeholder="Digite o conte√∫do da minuta aqui...",
                )
            except ImportError:
                st.warning(
                    "‚ö†Ô∏è Biblioteca streamlit-quill n√£o encontrada. Usando editor simples."
                )
                conteudo = st.text_area(
                    "Conte√∫do",
                    value=minuta.get("conteudo", ""),
                    height=400,
                    key="edit_conteudo",
                    label_visibility="collapsed",
                )

            # Info sobre editor
            st.caption("üí° Editor WYSIWYG (Rich Text) ativado via streamlit-quill")

            # Contadores
            palavras = len(conteudo.split())
            caracteres = len(conteudo)
            st.caption(f"üìä {palavras} palavras ‚Ä¢ {caracteres} caracteres")

        with tab_preview:
            st.markdown("### Preview do Documento")
            st.divider()

            # Preview simples
            st.markdown(f"**{titulo}**")
            st.caption(f"Tipo: {tipo} | Status: {status}")
            st.divider()
            st.markdown(conteudo)

        with tab_ai:
            st.markdown("### ü§ñ Comandos de IA")
            st.caption("Use a IA para gerar, melhorar ou formatar o texto da minuta.")

            # Importar comandos de IA
            try:
                import asyncio

                from lib.ai_commands import AIMinutaCommands

                # Inicializar IA (cacheado na sess√£o se poss√≠vel, mas aqui instanciamos direto)
                ai_commands = AIMinutaCommands()

                # √Årea de resultado da IA
                if "ai_result" not in st.session_state:
                    st.session_state.ai_result = ""

                col_cmd1, col_cmd2 = st.columns(2)

                async def run_ai_command(command_type: str, text: str):
                    """Executa comando de IA com streaming"""
                    placeholder = st.empty()
                    full_response = ""

                    try:
                        if command_type == "continuar":
                            stream = ai_commands.continuar(text)
                        elif command_type == "expandir":
                            stream = ai_commands.expandir(text)
                        elif command_type == "revisar":
                            stream = ai_commands.revisar(text)
                        elif command_type == "formalizar":
                            stream = ai_commands.formalizar(text)
                        else:
                            return

                        async for chunk in stream:
                            full_response += chunk
                            placeholder.markdown(f"**Gerando...**\n\n{full_response}‚ñå")

                        placeholder.markdown(f"**‚úÖ Resultado:**\n\n{full_response}")
                        st.session_state.ai_result = full_response

                    except Exception as e:
                        st.error(f"Erro na IA: {str(e)}")

                with col_cmd1:
                    if st.button(
                        "‚ö° Continuar Texto",
                        use_container_width=True,
                        help="Continua escrevendo a partir do final",
                    ):
                        if not conteudo:
                            st.warning(
                                "‚ö†Ô∏è O editor est√° vazio. Digite algo para continuar."
                            )
                        else:
                            asyncio.run(run_ai_command("continuar", conteudo))

                    if st.button(
                        "üìù Expandir Conte√∫do",
                        use_container_width=True,
                        help="Desenvolve e detalha o texto",
                    ):
                        if not conteudo:
                            st.warning(MSG_EDITOR_VAZIO)
                        else:
                            asyncio.run(run_ai_command("expandir", conteudo))

                with col_cmd2:
                    if st.button(
                        "‚ú® Revisar Texto",
                        use_container_width=True,
                        help="Melhora gram√°tica e coes√£o",
                    ):
                        if not conteudo:
                            st.warning(MSG_EDITOR_VAZIO)
                        else:
                            asyncio.run(run_ai_command("revisar", conteudo))

                    if st.button(
                        "üé© Formalizar (Jur√≠dico)",
                        use_container_width=True,
                        help="Reescreve em linguagem formal",
                    ):
                        if not conteudo:
                            st.warning(MSG_EDITOR_VAZIO)
                        else:
                            asyncio.run(run_ai_command("formalizar", conteudo))

                # Exibir resultado e bot√£o de aplicar
                if st.session_state.ai_result:
                    st.divider()
                    st.markdown("#### üìã Resultado da IA")
                    st.info(
                        "Copie o texto abaixo e cole no editor, ou use o bot√£o para substituir tudo."
                    )
                    st.code(st.session_state.ai_result, language="html")

                    if st.button("üì• Substituir Conte√∫do do Editor", type="primary"):
                        # Atualizar minuta no state
                        minuta["conteudo"] = st.session_state.ai_result
                        st.session_state.ai_result = ""  # Limpar resultado
                        st.success(
                            "Conte√∫do atualizado! V√° para a aba 'Editor' para ver."
                        )
                        st.rerun()

            except ImportError:
                st.error("‚ö†Ô∏è M√≥dulo lib.ai_commands n√£o encontrado.")
            except Exception as e:
                st.error(f"‚ö†Ô∏è Erro ao carregar IA: {str(e)}")

        with tab_vars:
            st.markdown("### üîß Vari√°veis Din√¢micas")
            st.caption("Vari√°veis detectadas no texto (formato {{variavel}})")

            import re

            # Detectar vari√°veis
            variaveis = list(set(re.findall(r"\{\{(.*?)\}\}", conteudo)))

            if not variaveis:
                st.info("Nenhuma vari√°vel detectada no texto.")
            else:
                st.write(f"**{len(variaveis)} vari√°veis encontradas:**")

                # Simular preenchimento
                valores = {}
                for var in variaveis:
                    valores[var] = st.text_input(f"Valor para {var}", key=f"var_{var}")

                if st.button("üëÅÔ∏è Visualizar com Valores"):
                    texto_preenchido = conteudo
                    for var, val in valores.items():
                        if val:
                            texto_preenchido = texto_preenchido.replace(
                                f"{{{{{var}}}}}", val
                            )

                    st.markdown("#### Preview Preenchido")
                    st.markdown(texto_preenchido)

        with tab_gdocs:
            st.markdown("### üìÑ Google Docs Integration")
            st.caption("Cole o link de um documento Google Docs para visualizar aqui.")

            gdoc_url = st.text_input(
                "URL do Google Docs",
                placeholder="https://docs.google.com/document/d/...",
            )

            if gdoc_url:
                if "docs.google.com" in gdoc_url:
                    st.components.v1.iframe(gdoc_url, height=600, scrolling=True)
                else:
                    st.error(
                        "URL inv√°lida. Certifique-se de que √© um link do Google Docs."
                    )
            else:
                st.info("Cole a URL acima para carregar o documento.")

        st.divider()

        # Aviso de altera√ß√µes n√£o salvas (Simples compara√ß√£o)
        if minuta.get("conteudo") != conteudo:
            st.warning("‚ö†Ô∏è **Aten√ß√£o:** Existem altera√ß√µes n√£o salvas no conte√∫do!")

        # Bot√µes de a√ß√£o
        col_save, col_cancel, col_duplicate = st.columns(3)

        with col_save:
            if st.button("üíæ Salvar", type="primary", use_container_width=True):
                # Valida√ß√£o
                if not titulo.strip():
                    st.error("‚ùå T√≠tulo √© obrigat√≥rio!")
                else:
                    # Atualizar dados
                    minuta_atualizada = minuta.copy()
                    minuta_atualizada["titulo"] = titulo
                    minuta_atualizada["tipo"] = tipo
                    minuta_atualizada["status"] = status
                    minuta_atualizada["conteudo"] = conteudo
                    minuta_atualizada["atualizadoEm"] = datetime.now().isoformat()

                    # Salvar
                    if salvar_minuta(minuta_atualizada):
                        st.success("‚úÖ Minuta salva com sucesso!")
                        st.session_state.editing_minuta = None
                        st.session_state.refresh_trigger += 1
                        st.rerun()

        with col_cancel:
            if st.button("‚ùå Cancelar", use_container_width=True):
                st.session_state.editing_minuta = None
                st.rerun()

        with col_duplicate:
            if st.button("üìã Duplicar", use_container_width=True):
                minuta_duplicada = minuta.copy()
                minuta_duplicada["id"] = None  # Novo ID
                minuta_duplicada["titulo"] = f"C√≥pia de {minuta['titulo']}"
                minuta_duplicada["criadoEm"] = datetime.now().isoformat()
                minuta_duplicada["atualizadoEm"] = datetime.now().isoformat()

                st.session_state.editing_minuta = minuta_duplicada
                st.rerun()

    else:
        # Nenhuma minuta selecionada
        st.info("üëà Selecione uma minuta na lista ao lado ou crie uma nova")

        # Estat√≠sticas
        st.divider()
        st.subheader("üìä Estat√≠sticas")

        if minutas:
            # M√©tricas
            col_m1, col_m2, col_m3 = st.columns(3)

            with col_m1:
                st.metric("Total de Minutas", len(minutas))

            with col_m2:
                rascunhos = len([m for m in minutas if m.get("status") == "rascunho"])
                st.metric("Rascunhos", rascunhos)

            with col_m3:
                criadas_ia = len([m for m in minutas if m.get("criadoPorAgente")])
                st.metric("Criadas por IA", criadas_ia)

            # Gr√°fico de status
            import pandas as pd

            df_status = pd.DataFrame(
                [
                    {
                        "Status": s,
                        "Quantidade": len([m for m in minutas if m.get("status") == s]),
                    }
                    for s in STATUS_MINUTA
                ]
            )

            st.bar_chart(df_status.set_index("Status"))

# ===========================
# FOOTER
# ===========================

st.divider()
st.caption(
    "üí° **Dica:** Use os comandos de IA (pr√≥xima fase) para gerar, "
    "continuar e melhorar seus documentos automaticamente."
)
