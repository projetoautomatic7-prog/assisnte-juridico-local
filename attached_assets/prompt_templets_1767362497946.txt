"""
Dynamic Prompt Templates - Templates Reutiliz√°veis e Version√°veis.

Implementa sistema de templates de prompts com vari√°veis, versionamento e A/B testing.
"""

import logging
from datetime import datetime
from typing import Any, Dict, List, Optional, Union

from langchain_core.prompts import (
    ChatPromptTemplate,
    HumanMessagePromptTemplate,
    SystemMessagePromptTemplate,
    MessagesPlaceholder,
    PromptTemplate
)

logger = logging.getLogger(__name__)


# ============================================
# Templates Base para Dom√≠nio Jur√≠dico
# ============================================

class LegalPromptTemplates:
    """Reposit√≥rio de templates para dom√≠nio jur√≠dico."""

    # Sistema base
    SYSTEM_BASE = """Voc√™ √© um assistente jur√≠dico s√™nior altamente qualificado.

Caracter√≠sticas:
- Dom√≠nio profundo de direito brasileiro
- Linguagem t√©cnica e precisa
- An√°lise criteriosa e fundamentada
- Refer√™ncias a legisla√ß√£o quando aplic√°vel

Legisla√ß√µes principais:
- Constitui√ß√£o Federal de 1988 (CF/88)
- C√≥digo Civil de 2002 (CC/02)
- C√≥digo de Processo Civil de 2015 (CPC/15)
- C√≥digo de Processo Penal (CPP)
- Consolida√ß√£o das Leis do Trabalho (CLT)
"""

    # Templates de an√°lise
    ANALISE_INTIMACAO = ChatPromptTemplate.from_messages([
        ("system", SYSTEM_BASE + """
Especializa√ß√£o: An√°lise de intima√ß√µes e prazos processuais.

Sua tarefa:
1. Identificar o tipo de intima√ß√£o
2. Extrair prazos e datas relevantes
3. Avaliar urg√™ncia e prioridade
4. Listar a√ß√µes necess√°rias
5. Identificar partes envolvidas
"""),
        ("human", """Analise a seguinte intima√ß√£o:

{texto_intimacao}

{format_instructions}
""")
    ])

    ANALISE_CONTRATO = ChatPromptTemplate.from_messages([
        ("system", SYSTEM_BASE + """
Especializa√ß√£o: An√°lise e revis√£o de contratos.

Sua tarefa:
1. Identificar tipo e objeto do contrato
2. Analisar cl√°usulas principais
3. Identificar riscos potenciais
4. Avaliar equil√≠brio contratual
5. Fornecer recomenda√ß√µes
"""),
        ("human", """Analise o seguinte contrato:

{texto_contrato}

Aspectos a considerar: {aspectos}

{format_instructions}
""")
    ])

    ANALISE_SENTENCA = ChatPromptTemplate.from_messages([
        ("system", SYSTEM_BASE + """
Especializa√ß√£o: An√°lise de senten√ßas e decis√µes judiciais.

Sua tarefa:
1. Resumir o dispositivo da decis√£o
2. Identificar fundamentos jur√≠dicos
3. Avaliar chances de reforma
4. Sugerir estrat√©gia recursal
5. Identificar pontos fortes e fracos
"""),
        ("human", """Analise a seguinte senten√ßa:

{texto_sentenca}

Perspectiva: {perspectiva}

{format_instructions}
""")
    ])

    # Templates de gera√ß√£o
    GERAR_PETICAO = ChatPromptTemplate.from_messages([
        ("system", SYSTEM_BASE + """
Especializa√ß√£o: Reda√ß√£o de peti√ß√µes e pe√ßas processuais.

Diretrizes:
- Estrutura formal adequada
- Fundamenta√ß√£o jur√≠dica s√≥lida
- Linguagem t√©cnica e persuasiva
- Pedidos claros e objetivos
- Refer√™ncias legais precisas
"""),
        ("human", """Redija {tipo_peca} com os seguintes dados:

Partes:
Autor: {autor}
R√©u: {reu}

Fatos: {fatos}

Fundamentos: {fundamentos}

Pedidos: {pedidos}

{instrucoes_adicionais}
""")
    ])

    GERAR_PARECER = ChatPromptTemplate.from_messages([
        ("system", SYSTEM_BASE + """
Especializa√ß√£o: Elabora√ß√£o de pareceres jur√≠dicos.

Estrutura do parecer:
1. Consulta
2. An√°lise dos fatos
3. Fundamenta√ß√£o jur√≠dica
4. Conclus√£o
5. Recomenda√ß√µes
"""),
        ("human", """Elabore parecer jur√≠dico sobre:

Consulta: {consulta}

Contexto: {contexto}

Quest√µes espec√≠ficas: {questoes}

{format_instructions}
""")
    ])

    # Templates com hist√≥rico
    CHAT_COM_MEMORIA = ChatPromptTemplate.from_messages([
        ("system", SYSTEM_BASE + """
Voc√™ est√° em uma conversa cont√≠nua com um advogado.
Mantenha contexto das mensagens anteriores.
"""),
        MessagesPlaceholder(variable_name="chat_history"),
        ("human", "{input}")
    ])

    # Templates de pesquisa
    PESQUISA_JURISPRUDENCIA = ChatPromptTemplate.from_messages([
        ("system", SYSTEM_BASE + """
Especializa√ß√£o: Pesquisa de jurisprud√™ncia e precedentes.

Sua tarefa:
- Identificar teses relevantes
- Citar n√∫meros de processos
- Resumir ementas principais
- Avaliar aplicabilidade ao caso
"""),
        ("human", """Pesquise jurisprud√™ncia sobre:

Tema: {tema}
Tribunal: {tribunal}
Per√≠odo: {periodo}

{criterios_adicionais}
""")
    ])


# ============================================
# Template Manager com Versionamento
# ============================================

class PromptTemplateManager:
    """
    Gerenciador de templates com versionamento e A/B testing.
    """

    def __init__(self):
        self._templates: Dict[str, Dict[str, ChatPromptTemplate]] = {}
        self._active_versions: Dict[str, str] = {}
        self._usage_stats: Dict[str, Dict[str, int]] = {}

    def register_template(
        self,
        name: str,
        template: ChatPromptTemplate,
        version: str = "v1"
    ):
        """
        Registra um template com vers√£o.

        Args:
            name: Nome do template
            template: Template do prompt
            version: Vers√£o do template
        """
        if name not in self._templates:
            self._templates[name] = {}
            self._active_versions[name] = version
            self._usage_stats[name] = {}

        self._templates[name][version] = template
        self._usage_stats[name][version] = 0

        logger.info(f"üìù Template '{name}' vers√£o {version} registrado")

    def get_template(
        self,
        name: str,
        version: Optional[str] = None
    ) -> ChatPromptTemplate:
        """
        Recupera template por nome e vers√£o.

        Args:
            name: Nome do template
            version: Vers√£o espec√≠fica (ou usa a ativa)
        """
        if name not in self._templates:
            raise ValueError(f"Template '{name}' n√£o encontrado")

        version = version or self._active_versions.get(name)

        if version not in self._templates[name]:
            raise ValueError(f"Vers√£o '{version}' do template '{name}' n√£o encontrada")

        # Incrementar contador
        self._usage_stats[name][version] += 1

        return self._templates[name][version]

    def set_active_version(self, name: str, version: str):
        """Define vers√£o ativa de um template."""
        if name not in self._templates:
            raise ValueError(f"Template '{name}' n√£o encontrado")

        if version not in self._templates[name]:
            raise ValueError(f"Vers√£o '{version}' n√£o encontrada")

        self._active_versions[name] = version
        logger.info(f"‚úÖ Template '{name}' agora usa vers√£o {version}")

    def list_templates(self) -> List[str]:
        """Lista todos os templates dispon√≠veis."""
        return list(self._templates.keys())

    def list_versions(self, name: str) -> List[str]:
        """Lista vers√µes de um template."""
        if name not in self._templates:
            return []
        return list(self._templates[name].keys())

    def get_stats(self, name: str) -> Dict[str, int]:
        """Retorna estat√≠sticas de uso de um template."""
        return self._usage_stats.get(name, {})


# ============================================
# Prompt Builder Fluente
# ============================================

class LegalPromptBuilder:
    """
    Builder fluente para criar prompts complexos.
    """

    def __init__(self):
        self._messages = []
        self._variables = set()

    def system(self, content: str) -> "LegalPromptBuilder":
        """Adiciona mensagem de sistema."""
        self._messages.append(("system", content))
        return self

    def human(self, content: str) -> "LegalPromptBuilder":
        """Adiciona mensagem humana."""
        self._messages.append(("human", content))
        # Extrair vari√°veis {var}
        import re
        vars_found = re.findall(r'\{(\w+)\}', content)
        self._variables.update(vars_found)
        return self

    def ai(self, content: str) -> "LegalPromptBuilder":
        """Adiciona exemplo de resposta da IA."""
        self._messages.append(("ai", content))
        return self

    def placeholder(self, name: str) -> "LegalPromptBuilder":
        """Adiciona placeholder para mensagens."""
        self._messages.append(MessagesPlaceholder(variable_name=name))
        self._variables.add(name)
        return self

    def with_examples(
        self,
        examples: List[Dict[str, str]]
    ) -> "LegalPromptBuilder":
        """Adiciona exemplos few-shot."""
        for ex in examples:
            self._messages.append(("human", ex.get("input", "")))
            self._messages.append(("ai", ex.get("output", "")))
        return self

    def build(self) -> ChatPromptTemplate:
        """Constr√≥i o template final."""
        return ChatPromptTemplate.from_messages(self._messages)

    def get_variables(self) -> List[str]:
        """Retorna vari√°veis necess√°rias."""
        return list(self._variables)


# ============================================
# Templates Pr√©-configurados
# ============================================

# Criar manager global
prompt_manager = PromptTemplateManager()

# Registrar templates padr√£o
prompt_manager.register_template(
    "analise_intimacao",
    LegalPromptTemplates.ANALISE_INTIMACAO,
    "v1"
)

prompt_manager.register_template(
    "analise_contrato",
    LegalPromptTemplates.ANALISE_CONTRATO,
    "v1"
)

prompt_manager.register_template(
    "gerar_peticao",
    LegalPromptTemplates.GERAR_PETICAO,
    "v1"
)

prompt_manager.register_template(
    "chat_com_memoria",
    LegalPromptTemplates.CHAT_COM_MEMORIA,
    "v1"
)


# ============================================
# Helpers
# ============================================

def create_few_shot_prompt(
    instruction: str,
    examples: List[Dict[str, str]],
    input_key: str = "input"
) -> ChatPromptTemplate:
    """
    Cria prompt few-shot facilmente.

    Args:
        instruction: Instru√ß√£o base
        examples: Lista de exemplos com input/output
        input_key: Nome da vari√°vel de input
    """
    builder = LegalPromptBuilder()
    builder.system(instruction)
    builder.with_examples(examples)
    builder.human(f"{{{input_key}}}")
    return builder.build()


def get_legal_template(name: str) -> ChatPromptTemplate:
    """Helper para pegar template rapidamente."""
    return prompt_manager.get_template(name)


# Example usage
"""
# Usar template registrado
template = get_legal_template("analise_intimacao")
prompt = template.format_messages(
    texto_intimacao="...",
    format_instructions="Retorne JSON com tipo e prazo"
)

# Criar template customizado com builder
custom_template = (
    LegalPromptBuilder()
    .system("Voc√™ √© um especialista em direito trabalhista")
    .human("Analise: {caso}")
    .build()
)

# Few-shot
few_shot = create_few_shot_prompt(
    "Classifique o tipo de a√ß√£o",
    examples=[
        {"input": "dano moral", "output": "A√ß√£o indenizat√≥ria"},
        {"input": "revis√£o contrato", "output": "A√ß√£o revisional"}
    ]
)
"""
