import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import { Textarea } from "@/components/ui/textarea";
import { useAutonomousAgents } from "@/hooks/use-autonomous-agents";
import { useKV } from "@/hooks/use-kv";
import { createInvokeAgentSpan } from "@/lib/sentry-gemini-integration-v2";
import * as Sentry from "@sentry/react";
import { useCallback, useEffect, useMemo, useRef, useState } from "react";

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import type { AgentTask } from "@/lib/agents";
import {
  createLocalAppointmentFromAnalysis,
  syncDeadlineToGoogleCalendar,
  type IntimationAnalysisResult,
} from "@/lib/deadline-calendar-integration";
import type { Appointment, Expediente } from "@/types";
import { toast } from "sonner";

// Verifica se um expediente precisa de re-an√°lise (tem mensagem de erro/placeholder)
function needsReanalysis(exp: Expediente): boolean {
  if (!exp.analyzed) return false;
  const summary = exp.summary?.toLowerCase() || "";
  return (
    summary.includes("indispon√≠vel") ||
    summary.includes("manualmente") ||
    summary.includes("revisar documento") ||
    summary === "" ||
    !exp.summary
  );
}

// Verifica se um expediente precisa ser analisado
function needsAnalysis(exp: Expediente): boolean {
  return !exp.analyzed || needsReanalysis(exp);
}

/**
 * Verifica se as a√ß√µes sugeridas indicam necessidade de resposta/peti√ß√£o
 */
function checkNeedsResponse(suggestedActions?: string[]): boolean {
  if (!suggestedActions) return false;
  const responseKeywords = ["resposta", "manifestar", "peti√ß√£o", "contestar", "recurso"];
  return suggestedActions.some((a) =>
    responseKeywords.some((keyword) => a.toLowerCase().includes(keyword))
  );
}

/**
 * Verifica se as a√ß√µes sugeridas indicam necessidade de pesquisa
 */
function checkNeedsResearch(suggestedActions?: string[]): boolean {
  if (!suggestedActions) return false;
  const researchKeywords = ["jurisprud√™ncia", "precedente", "pesquisar"];
  return suggestedActions.some((a) =>
    researchKeywords.some((keyword) => a.toLowerCase().includes(keyword))
  );
}

/**
 * Determina a prioridade da tarefa baseada na prioridade da an√°lise
 */
function getTaskPriority(
  priority: string,
  defaultPriority: "low" | "medium" | "high" = "medium"
): "low" | "medium" | "high" {
  const normalizedPriority = priority.toLowerCase();
  if (normalizedPriority === "alta" || normalizedPriority === "urgente") return "high";
  return defaultPriority;
}

// Determina quais agentes devem receber tarefas com base na an√°lise
function getAgentTasksFromAnalysis(
  exp: Expediente,
  analysisData: {
    priority?: string;
    deadline?: { days?: number; type?: string; endDate?: string };
    suggestedActions?: string[];
    documentType?: string;
  }
): Partial<AgentTask>[] {
  const tasks: Partial<AgentTask>[] = [];
  const priority = analysisData.priority?.toLowerCase() || "m√©dia";
  const hasPrazo = analysisData.deadline?.days && analysisData.deadline.days > 0;

  // 1. Gest√£o de Prazos - sempre que h√° prazo identificado
  if (hasPrazo) {
    tasks.push({
      agentId: "gestao-prazos",
      type: "CALCULATE_DEADLINE",
      priority: getTaskPriority(priority, "medium"),
      data: {
        expedienteId: exp.id,
        processNumber: exp.numeroProcesso,
        deadlineDays: analysisData.deadline?.days,
        deadlineType: analysisData.deadline?.type,
        deadlineDate: analysisData.deadline?.endDate,
        source: "auto-analysis",
      },
    });
  }

  // 2. Monitor DJEN - registrar que foi processado
  tasks.push({
    agentId: "monitor-djen",
    type: "MONITOR_DJEN",
    priority: "low",
    data: {
      expedienteId: exp.id,
      processNumber: exp.numeroProcesso,
      tribunal: exp.tribunal,
      action: "register-processed",
      source: "auto-analysis",
    },
  });

  // 3. An√°lise de Risco - para prioridades altas
  if (getTaskPriority(priority) === "high") {
    tasks.push({
      agentId: "analise-risco",
      type: "RISK_ANALYSIS",
      priority: "high",
      data: {
        expedienteId: exp.id,
        processNumber: exp.numeroProcesso,
        summary: exp.summary,
        priority: priority,
        source: "auto-analysis",
      },
    });
  }

  // 4. Reda√ß√£o de Peti√ß√µes - se a√ß√µes sugerem resposta
  if (checkNeedsResponse(analysisData.suggestedActions)) {
    tasks.push({
      agentId: "redacao-peticoes",
      type: "DRAFT_PETITION",
      priority: getTaskPriority(priority, "medium"),
      data: {
        expedienteId: exp.id,
        processNumber: exp.numeroProcesso,
        documentType: analysisData.documentType,
        suggestedActions: analysisData.suggestedActions,
        source: "auto-analysis",
      },
    });
  }

  // 5. Pesquisa de Jurisprud√™ncia - para casos complexos
  if (checkNeedsResearch(analysisData.suggestedActions) || getTaskPriority(priority) === "high") {
    tasks.push({
      agentId: "pesquisa-juris",
      type: "RESEARCH_PRECEDENTS",
      priority: "medium",
      data: {
        expedienteId: exp.id,
        processNumber: exp.numeroProcesso,
        summary: exp.summary,
        source: "auto-analysis",
      },
    });
  }

  // 6. Estrat√©gia Processual - sempre gera sugest√£o estrat√©gica automaticamente
  tasks.push({
    agentId: "estrategia-processual",
    type: "CASE_STRATEGY",
    priority: getTaskPriority(priority, "medium"),
    data: {
      expedienteId: exp.id,
      processNumber: exp.numeroProcesso,
      tribunal: exp.tribunal,
      summary: exp.summary,
      documentType: analysisData.documentType,
      priority: priority,
      deadline: analysisData.deadline,
      suggestedActions: analysisData.suggestedActions,
      source: "auto-analysis",
    },
  });

  return tasks;
}

/**
 * Tipo para dados de an√°lise do expediente
 */
interface AnalysisData {
  summary?: string;
  documentType?: string;
  processType?: string; // Tipo do processo (Invent√°rio, A√ß√£o C√≠vel, etc)
  priority?: string;
  deadline?: {
    days?: number;
    type?: "√∫teis" | "corridos";
    startDate?: string;
    endDate?: string;
    description?: string;
  };
  suggestedActions?: string[];
  nextSteps?: string[];
}

/**
 * Faz parse da resposta JSON da an√°lise ou retorna fallback
 */
function parseAnalysisResponse(responseText: string, exp: Expediente): AnalysisData {
  try {
    const jsonText = responseText
      .replaceAll(/```json\n?/g, "")
      .replaceAll(/```\n?/g, "")
      .trim();
    const parsed = JSON.parse(jsonText) as AnalysisData;

    // ‚úÖ VALIDA√á√ÉO: Detectar diverg√™ncias entre conte√∫do e a√ß√£o sugerida
    const content = (exp.content || exp.teor || "").toLowerCase();
    const isInventario = content.includes("invent√°rio") || content.includes("inventariante");
    const isPrimeirasDeclaracoes = content.includes("primeiras declara√ß√µes");
    const suggestedAction = (parsed.suggestedActions?.[0] || "").toLowerCase();

    // Corrigir a√ß√£o incorreta para invent√°rio
    if (isInventario && isPrimeirasDeclaracoes && suggestedAction.includes("rol de testemunhas")) {
      console.warn(
        "‚ö†Ô∏è DIVERG√äNCIA DETECTADA: Processo de INVENT√ÅRIO com a√ß√£o incorreta. Corrigindo..."
      );
      parsed.suggestedActions = ["Apresentar Primeiras Declara√ß√µes de Invent√°rio"];
      parsed.summary = `ALERTA: A tarefa sugerida anteriormente estava INCORRETA. Este √© um processo de INVENT√ÅRIO que determina apresentar as Primeiras Declara√ß√µes. ${
        parsed.summary || ""
      }`;
      parsed.documentType = "Intima√ß√£o - Invent√°rio";
    }

    // ‚úÖ VALIDA√á√ÉO: Corrigir ano da data (deve ser 2025, n√£o anos anteriores)
    if (parsed.deadline?.endDate) {
      const dataParts = /(\d{2})\/(\d{2})\/(\d{4})/.exec(parsed.deadline.endDate);
      if (dataParts && Number.parseInt(dataParts[3], 10) < 2025) {
        const day = dataParts[1];
        const month = dataParts[2];
        parsed.deadline.endDate = `${day}/${month}/2025`;
        console.warn(`‚ö†Ô∏è ANO INCORRETO DETECTADO: Corrigido para 2025`);
      }
    }

    return parsed;
  } catch {
    return {
      summary: responseText || "An√°lise conclu√≠da",
      documentType: exp.type || "Intima√ß√£o",
      priority: "m√©dia",
      deadline: { days: 15, type: "√∫teis", endDate: "Verificar" },
      suggestedActions: ["Verificar prazo processual", "Analisar provid√™ncias"],
      nextSteps: ["Revisar intima√ß√£o", "Preparar resposta se necess√°rio"],
    };
  }
}

/**
 * Gera o texto do rascunho de peti√ß√£o
 */
function buildDraftPetition(analysisData: AnalysisData, exp: Expediente): string {
  const actionsText = (analysisData.suggestedActions || [])
    .map((a: string, i: number) => `${i + 1}. ${a}`)
    .join("\n");
  const stepsText = (analysisData.nextSteps || [])
    .map((s: string, i: number) => `${i + 1}. ${s}`)
    .join("\n");

  return (
    `AN√ÅLISE AUTOM√ÅTICA - Mrs. Justin-e\n\n` +
    `üìã RESUMO:\n${analysisData.summary || "N/A"}\n\n` +
    `‚öñÔ∏è TIPO: ${analysisData.documentType || exp.type}\n` +
    `üö® PRIORIDADE: ${analysisData.priority || "m√©dia"}\n\n` +
    `üìÖ PRAZO: ${analysisData.deadline?.days || "N/A"} dias ${
      analysisData.deadline?.type || ""
    }\n` +
    `   Data limite: ${analysisData.deadline?.endDate || "N/A"}\n\n` +
    `‚úÖ A√á√ïES SUGERIDAS:\n${actionsText}\n\n` +
    `üìù PR√ìXIMOS PASSOS:\n${stepsText}`
  );
}

/**
 * Cria resultado de an√°lise para integra√ß√£o com calend√°rio
 */
function buildCalendarAnalysisResult(
  analysisData: AnalysisData,
  exp: Expediente
): IntimationAnalysisResult {
  // Converter deadline para o formato esperado por IntimationAnalysisResult
  const deadline =
    analysisData.deadline?.days === undefined
      ? undefined
      : {
          days: analysisData.deadline.days,
          type: analysisData.deadline.type || "√∫teis",
          endDate: analysisData.deadline.endDate || "",
          description: analysisData.deadline.description,
        };

  const result: IntimationAnalysisResult = {
    summary: analysisData.summary || "Intima√ß√£o analisada",
    deadline,
    priority: (analysisData.priority?.toLowerCase() || "m√©dia") as
      | "baixa"
      | "m√©dia"
      | "alta"
      | "cr√≠tica",
    nextSteps: analysisData.nextSteps || analysisData.suggestedActions,
    suggestedAction: analysisData.suggestedActions?.[0],
    processNumber: exp.numeroProcesso,
    court: exp.tribunal,
    documentType: analysisData.documentType || exp.type,
  };

  // Calcular data limite se n√£o estiver presente
  if (result.deadline && !result.deadline.endDate && result.deadline.days) {
    const hoje = new Date();
    const diasParaAdicionar = result.deadline.days;
    const dataLimite = new Date(hoje);
    dataLimite.setDate(dataLimite.getDate() + diasParaAdicionar);
    result.deadline.endDate = dataLimite.toISOString();
  }

  return result;
}

export default function ExpedientePanel() {
  const [expedientes, setExpedientes] = useKV<Expediente[]>("expedientes", []);
  const [appointments, setAppointments] = useKV<Appointment[]>("appointments", []);
  const [selectedExp, setSelectedExp] = useState<Expediente | null>(null);
  const [analyzing, setAnalyzing] = useState(false);
  const [showMichaelRossDialog, setShowMichaelRossDialog] = useState(false);
  const [loading, setLoading] = useState(false);
  const [lastSync, setLastSync] = useState<string | null>(null);

  // Estado para an√°lise autom√°tica
  const [autoAnalyzing, setAutoAnalyzing] = useState(false);
  const [analysisProgress, setAnalysisProgress] = useState({ current: 0, total: 0 });
  const [tasksCreated, setTasksCreated] = useState(0);
  const [deadlinesCreated, setDeadlinesCreated] = useState(0);
  const autoAnalysisRanRef = useRef(false);

  // Hook dos agentes aut√¥nomos para criar tarefas
  const { addTask, agents } = useAutonomousAgents();

  // Fun√ß√£o para buscar expedientes da API
  const fetchExpedientes = useCallback(async () => {
    setLoading(true);
    try {
      const response = await fetch("/api/expedientes");
      const data = await response.json();

      if (data.success && data.expedientes?.length > 0) {
        setExpedientes(data.expedientes);
        setLastSync(data.lastCheck);
        toast.success(`${data.expedientes.length} expediente(s) carregado(s)`);
      } else if (data.lawyersConfigured === 0) {
        toast.info("Nenhum advogado configurado para monitoramento");
      }
    } catch (error) {
      console.error("Erro ao buscar expedientes:", error);
      // Silently fail - API may not be available in dev
    } finally {
      setLoading(false);
    }
  }, [setExpedientes]);

  // Busca expedientes ao montar componente
  useEffect(() => {
    fetchExpedientes();
  }, [fetchExpedientes]);

  // Ensure expedientes is always an array to prevent runtime errors
  const safeExpedientes = useMemo(
    () => (Array.isArray(expedientes) ? expedientes : []),
    [expedientes]
  );

  // Helper para mapear prioridade PT -> EN
  const mapPriority = (
    priority: string | undefined
  ): "low" | "medium" | "high" | "urgent" | undefined => {
    if (!priority) return "medium";
    const map: Record<string, "low" | "medium" | "high" | "urgent"> = {
      baixa: "low",
      low: "low",
      m√©dia: "medium",
      media: "medium",
      medium: "medium",
      alta: "high",
      high: "high",
      urgente: "urgent",
      urgent: "urgent",
    };
    return map[priority.toLowerCase()] || "medium";
  };

  /**
   * Cria prazo no calend√°rio com base na an√°lise do expediente
   */
  const createCalendarDeadline = useCallback(
    (exp: Expediente, analysisData: AnalysisData): void => {
      try {
        const analysisResult = buildCalendarAnalysisResult(analysisData, exp);
        const localAppointment = createLocalAppointmentFromAnalysis(
          analysisResult,
          `${exp.type || "Intima√ß√£o"} - ${exp.numeroProcesso || "Processo"}`
        );

        if (!localAppointment) return;

        // Verificar se j√° existe
        const existingAppt = (appointments || []).find(
          (apt) =>
            apt.date === localAppointment.date &&
            apt.title.includes(exp.numeroProcesso?.substring(0, 15) || "")
        );

        if (existingAppt) return;

        setAppointments((current) => [...(current || []), localAppointment]);
        setDeadlinesCreated((prev) => prev + 1);
        console.log("[ExpedientePanel] Prazo adicionado ao calend√°rio:", localAppointment.title);

        // Tentar sincronizar com Google Calendar em background
        syncDeadlineToGoogleCalendar(
          analysisResult,
          `${exp.type || "Intima√ß√£o"} - ${exp.numeroProcesso || "Processo"}`
        ).catch((err) => console.warn("[ExpedientePanel] Sync com Google Calendar falhou:", err));
      } catch (calendarError) {
        console.warn("[ExpedientePanel] Erro ao criar prazo no calend√°rio:", calendarError);
      }
    },
    [appointments, setAppointments, setDeadlinesCreated]
  );

  // Fun√ß√£o para analisar um √∫nico expediente (retorna o expediente analisado)
  // üî• INSTRUMENTADO COM SENTRY AI MONITORING V2
  const analyzeExpediente = useCallback(
    async (exp: Expediente): Promise<Expediente> => {
      // Session ID √∫nico por expediente
      const sessionId = `expediente-${exp.id}-${Date.now()}`;

      return createInvokeAgentSpan(
        {
          agentName: "Mrs. Justin-e",
          system: "gcp.gemini",
          model: "gemini-2.5-pro",
          temperature: 0.3,
          maxTokens: 2000,
        },
        {
          sessionId,
          turn: 1,
          messages: [
            {
              role: "user",
              content: `Analise intima√ß√£o do processo ${exp.numeroProcesso || "desconhecido"}`,
            },
          ],
        },
        async (span: Sentry.Span | undefined) => {
          try {
            // Atributos espec√≠ficos da tarefa
            span?.setAttribute("expediente.id", exp.id);
            span?.setAttribute("expediente.processo", exp.numeroProcesso || "unknown");
            span?.setAttribute("expediente.tribunal", exp.tribunal || "unknown");
            span?.setAttribute("task.type", "ANALYZE_INTIMATION");

            const response = await fetch("/api/llm-proxy", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                model: "gemini-2.5-pro",
                messages: [
                  {
                    role: "system",
                    content: `Voc√™ √© Mrs. Justin-e, especialista em an√°lise de intima√ß√µes judiciais brasileiras.

INSTRU√á√ïES CR√çTICAS:
1. Identifique EXATAMENTE o tipo de processo (ex: Invent√°rio, A√ß√£o C√≠vel, Execu√ß√£o)
2. Identifique a A√á√ÉO ESPEC√çFICA solicitada (ex: "Apresentar Primeiras Declara√ß√µes de Invent√°rio", n√£o "Apresentar rol de testemunhas")
3. Calcule a data do prazo com base na DATA DE RECEBIMENTO + n√∫mero de dias (√∫teis ou corridos)
4. Use SEMPRE o ano atual (2025) para c√°lculo de prazos - NUNCA use anos anteriores
5. Se a intima√ß√£o pedir "Primeiras Declara√ß√µes", N√ÉO sugira "rol de testemunhas"

Retorne APENAS JSON neste formato:
{
  "summary": "Resumo claro identificando: processo de [TIPO] + a√ß√£o solicitada + prazo",
  "documentType": "Tipo exato do documento",
  "processType": "Tipo do processo (Invent√°rio, A√ß√£o C√≠vel, etc)",
  "priority": "alta" | "m√©dia" | "baixa",
  "deadline": {
    "days": n√∫mero de dias do prazo,
    "type": "√∫teis" | "corridos",
    "endDate": "DD/MM/2025" (calcular a partir da data de recebimento)
  },
  "suggestedActions": ["A√ß√£o EXATA solicitada na intima√ß√£o"],
  "nextSteps": ["Pr√≥ximos passos espec√≠ficos para a a√ß√£o solicitada"]
}`,
                  },
                  {
                    role: "user",
                    content: `Analise esta intima√ß√£o:

PROCESSO: ${exp.numeroProcesso || "N√£o informado"}
TRIBUNAL: ${exp.tribunal || "N√£o informado"}
DATA DE RECEBIMENTO: ${exp.receivedAt || exp.dataRecebimento || new Date().toISOString()}

CONTE√öDO DA INTIMA√á√ÉO:
${exp.content || exp.teor || "Sem conte√∫do"}

IMPORTANTE:
- Se a intima√ß√£o mencionar "invent√°rio" ou "inventariante", √© processo de INVENT√ÅRIO
- Se mencionar "Primeiras Declara√ß√µes", a a√ß√£o √© "Apresentar Primeiras Declara√ß√µes de Invent√°rio"
- Calcule a data final considerando APENAS dias √öTEIS (segunda a sexta, excluindo feriados)
- Use o ANO 2025 para calcular a data limite`,
                  },
                ],
              }),
            });

            const data = await response.json();
            const responseText = data.choices?.[0]?.message?.content || data.message?.content || "";
            const analysisData = parseAnalysisResponse(responseText, exp);

            const analyzedExp: Expediente = {
              ...exp,
              analyzed: true,
              summary: analysisData.summary || "An√°lise conclu√≠da pela Mrs. Justin-e",
              suggestedAction: analysisData.suggestedActions?.[0] || "Verificar prazo",
              pendingDocs: analysisData.nextSteps || [],
              deadline: analysisData.deadline,
              priority: mapPriority(analysisData.priority),
              draftPetition: buildDraftPetition(analysisData, exp),
            };

            // Criar tarefas para outros agentes com base na an√°lise
            const agentTasks = getAgentTasksFromAnalysis(analyzedExp, analysisData);
            let createdTasks = 0;

            for (const taskData of agentTasks) {
              // S√≥ cria tarefa se o agente estiver habilitado
              const agent = agents.find((a) => a.id === taskData.agentId);
              if (agent?.enabled) {
                const task: AgentTask = {
                  id: `task-${Date.now()}-${Math.random().toString(36).slice(2, 11)}`,
                  agentId: taskData.agentId!,
                  type: taskData.type!,
                  priority: taskData.priority as "low" | "medium" | "high" | "critical",
                  status: "queued",
                  createdAt: new Date().toISOString(),
                  data: taskData.data as Record<string, unknown>,
                };
                addTask(task);
                createdTasks++;
              }
            }

            if (createdTasks > 0) {
              setTasksCreated((prev) => prev + createdTasks);
            }

            // Atributos de conclus√£o para Sentry
            span?.setAttribute("analysis.completed", true);
            span?.setAttribute("tasks.created", createdTasks);
            span?.setAttribute("priority", analyzedExp.priority || "medium");

            // Deadline pode ser string ou objeto
            const deadlineDays =
              typeof analyzedExp.deadline === "object" ? analyzedExp.deadline?.days : 0;
            span?.setAttribute("deadline.days", deadlineDays || 0);
            span?.setAttribute(
              "suggested_actions",
              JSON.stringify(analysisData.suggestedActions || [])
            );

            // üìÖ INTEGRA√á√ÉO COM CALEND√ÅRIO: Criar prazo automaticamente
            if (analysisData.deadline?.endDate || analysisData.deadline?.days) {
              createCalendarDeadline(exp, analysisData);
            }

            return analyzedExp;
          } catch (error) {
            console.error("Erro ao analisar expediente:", error);
            // Sentry captura erro automaticamente via span
            throw error;
          }
        }
      );
    },
    [addTask, agents, createCalendarDeadline]
  );

  // An√°lise autom√°tica de todos os expedientes pendentes
  const runAutoAnalysis = useCallback(async () => {
    const pending = safeExpedientes.filter(needsAnalysis);
    if (pending.length === 0) return;

    setAutoAnalyzing(true);
    setAnalysisProgress({ current: 0, total: pending.length });
    setTasksCreated(0);

    toast.info(
      `ü§ñ Mrs. Justin-e iniciando an√°lise autom√°tica de ${pending.length} intima√ß√£o(√µes)...`
    );

    let analyzed = 0;
    for (const exp of pending) {
      try {
        const result = await analyzeExpediente(exp);
        setExpedientes((current) => (current || []).map((e) => (e.id === exp.id ? result : e)));
        analyzed++;
        setAnalysisProgress({ current: analyzed, total: pending.length });

        // Pequeno delay entre an√°lises para n√£o sobrecarregar a API
        if (analyzed < pending.length) {
          await new Promise((resolve) => setTimeout(resolve, 1000));
        }
      } catch (error) {
        console.error(`Erro ao analisar expediente ${exp.id}:`, error);
      }
    }

    setAutoAnalyzing(false);
    if (analyzed > 0) {
      const deadlineMsg =
        deadlinesCreated > 0 ? ` e criou ${deadlinesCreated} prazo(s) na agenda` : "";
      toast.success(
        `‚úÖ Mrs. Justin-e analisou ${analyzed} intima√ß√£o(√µes)${deadlineMsg} e distribuiu tarefas para os agentes!`,
        { duration: 5000 }
      );
    }
  }, [safeExpedientes, setExpedientes, analyzeExpediente, deadlinesCreated]);

  // Dispara an√°lise autom√°tica quando expedientes s√£o carregados
  useEffect(() => {
    // S√≥ executa uma vez por sess√£o e se houver expedientes pendentes
    if (autoAnalysisRanRef.current) return;
    if (safeExpedientes.length === 0) return;
    if (loading) return;

    const pending = safeExpedientes.filter(needsAnalysis);
    if (pending.length > 0) {
      autoAnalysisRanRef.current = true;
      // Delay de 2 segundos para garantir que a UI j√° carregou
      setTimeout(() => {
        runAutoAnalysis();
      }, 2000);
    }
  }, [safeExpedientes, loading, runAutoAnalysis]);

  // An√°lise com IA real via API Gemini direta (mantida para uso manual)
  const handleAnalyze = async (exp: Expediente) => {
    setAnalyzing(true);
    setSelectedExp(exp);

    try {
      // Usa API Gemini diretamente para an√°lise mais confi√°vel
      const response = await fetch("/api/llm-proxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "gemini-2.5-pro",
          messages: [
            {
              role: "system",
              content: `Voc√™ √© Mrs. Justin-e, uma especialista em an√°lise de intima√ß√µes judiciais brasileiras.
Analise a intima√ß√£o abaixo e retorne um JSON com a seguinte estrutura:
{
  "summary": "Resumo claro da intima√ß√£o em 2-3 frases",
  "documentType": "Tipo do documento (intima√ß√£o, cita√ß√£o, despacho, etc)",
  "priority": "alta" | "m√©dia" | "baixa",
  "deadline": {
    "days": n√∫mero de dias do prazo,
    "type": "√∫teis" | "corridos",
    "endDate": "data limite no formato DD/MM/YYYY"
  },
  "suggestedActions": ["lista de a√ß√µes recomendadas"],
  "nextSteps": ["pr√≥ximos passos a seguir"]
}
Responda APENAS com o JSON, sem texto adicional.`,
            },
            {
              role: "user",
              content: `Analise esta intima√ß√£o:

PROCESSO: ${exp.numeroProcesso || "N√£o informado"}
TRIBUNAL: ${exp.tribunal || "N√£o informado"}
DATA: ${exp.receivedAt || exp.dataRecebimento || "N√£o informada"}

CONTE√öDO:
${exp.content || exp.teor || "Sem conte√∫do"}`,
            },
          ],
        }),
      });

      const data = await response.json();

      // Extrai o conte√∫do da resposta
      const responseText = data.choices?.[0]?.message?.content || data.message?.content || "";

      // Tenta fazer parse do JSON da resposta
      let analysisData;
      try {
        // Remove poss√≠veis marcadores de c√≥digo
        const jsonText = responseText
          .replaceAll(/```json\n?/g, "")
          .replaceAll(/```\n?/g, "")
          .trim();
        analysisData = JSON.parse(jsonText);
      } catch {
        // Se n√£o conseguir parse, cria estrutura b√°sica com a resposta
        analysisData = {
          summary: responseText || "An√°lise conclu√≠da",
          documentType: exp.type || "Intima√ß√£o",
          priority: "m√©dia",
          deadline: { days: 15, type: "√∫teis", endDate: "Verificar" },
          suggestedActions: ["Verificar prazo processual", "Analisar provid√™ncias"],
          nextSteps: ["Revisar intima√ß√£o", "Preparar resposta se necess√°rio"],
        };
      }

      const analyzed: Expediente = {
        ...exp,
        analyzed: true,
        summary: analysisData.summary || "An√°lise conclu√≠da pela Mrs. Justin-e",
        suggestedAction: analysisData.suggestedActions?.[0] || "Verificar prazo",
        pendingDocs: analysisData.nextSteps || [],
        deadline: analysisData.deadline,
        priority: mapPriority(analysisData.priority),
        draftPetition:
          `AN√ÅLISE AUTOM√ÅTICA - Mrs. Justin-e\n\n` +
          `üìã RESUMO:\n${analysisData.summary || "N/A"}\n\n` +
          `‚öñÔ∏è TIPO: ${analysisData.documentType || exp.type}\n` +
          `üö® PRIORIDADE: ${analysisData.priority || "m√©dia"}\n\n` +
          `üìÖ PRAZO: ${analysisData.deadline?.days || "N/A"} dias ${
            analysisData.deadline?.type || ""
          }\n` +
          `   Data limite: ${analysisData.deadline?.endDate || "N/A"}\n\n` +
          `‚úÖ A√á√ïES SUGERIDAS:\n${(analysisData.suggestedActions || [])
            .map((a: string, i: number) => `${i + 1}. ${a}`)
            .join("\n")}\n\n` +
          `üìù PR√ìXIMOS PASSOS:\n${(analysisData.nextSteps || [])
            .map((s: string, i: number) => `${i + 1}. ${s}`)
            .join("\n")}`,
      };

      setExpedientes((current) => (current || []).map((e) => (e.id === exp.id ? analyzed : e)));
      setSelectedExp(analyzed);
      toast.success("Mrs. Justin-e concluiu a an√°lise!");
    } catch (error) {
      console.error("Erro na an√°lise:", error);
      toast.error("Erro na an√°lise com IA. Tente novamente.");
      // N√ÉO salvar como analisado se falhou - permite tentar novamente
    } finally {
      setAnalyzing(false);
    }
  };

  const handleActivateMichaelRoss = () => {
    setShowMichaelRossDialog(true);
  };

  // An√°lise com Mrs. Justin-e (tarefa espec√≠fica)
  const handleSelectTask = async (task: string) => {
    setAnalyzing(true);

    try {
      if (selectedExp) {
        // Usa API Gemini diretamente
        const response = await fetch("/api/llm-proxy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "gemini-2.5-pro",
            messages: [
              {
                role: "system",
                content: `Voc√™ √© Mrs. Justin-e, especialista em controladoria jur√≠dica.
Crie um workflow detalhado para a tarefa solicitada.
Retorne um JSON:
{
  "summary": "Resumo da tarefa e contexto",
  "deadline": { "days": n√∫mero, "type": "√∫teis" | "corridos", "endDate": "DD/MM/YYYY" },
  "checklist": ["itens do checklist para executar a tarefa"],
  "nextSteps": ["pr√≥ximos passos ap√≥s a tarefa"],
  "observations": "observa√ß√µes importantes"
}
Responda APENAS com o JSON.`,
              },
              {
                role: "user",
                content: `TAREFA: ${task}

PROCESSO: ${selectedExp.numeroProcesso || "N√£o informado"}
TRIBUNAL: ${selectedExp.tribunal || "N√£o informado"}

CONTEXTO DA INTIMA√á√ÉO:
${selectedExp.content || selectedExp.teor || "Sem conte√∫do"}

Crie o workflow de controladoria para esta tarefa.`,
              },
            ],
          }),
        });

        const data = await response.json();
        const responseText = data.choices?.[0]?.message?.content || data.message?.content || "";

        let analysisData;
        try {
          const jsonText = responseText
            .replaceAll(/```json\n?/g, "")
            .replaceAll(/```\n?/g, "")
            .trim();
          analysisData = JSON.parse(jsonText);
        } catch {
          analysisData = {
            summary: `Workflow criado para: ${task}`,
            deadline: { days: 15, type: "√∫teis", endDate: "Calcular" },
            checklist: ["Verificar prazo", "Elaborar documento", "Protocolar"],
            nextSteps: ["Acompanhar andamento", "Aguardar manifesta√ß√£o"],
            observations: responseText || "Sem observa√ß√µes adicionais",
          };
        }

        const analyzed: Expediente = {
          ...selectedExp,
          analyzed: true,
          summary: analysisData.summary || `Mrs. Justin-e analisou a intima√ß√£o para: ${task}`,
          suggestedAction: `Executar: ${task}`,
          pendingDocs: analysisData.checklist || analysisData.nextSteps || ["Documento Principal"],
          deadline: analysisData.deadline,
          priority: "high",
          draftPetition:
            `WORKFLOW DE CONTROLADORIA - Mrs. Justin-e\n\n` +
            `üéØ TAREFA: ${task}\n\n` +
            `üìã RESUMO:\n${analysisData.summary || "Workflow em processamento"}\n\n` +
            `üìÖ PRAZO: ${analysisData.deadline?.days || 15} dias ${
              analysisData.deadline?.type || "√∫teis"
            }\n` +
            `   Data limite: ${analysisData.deadline?.endDate || "Calcular"}\n\n` +
            `‚úÖ CHECKLIST:\n${(analysisData.checklist || analysisData.nextSteps || [])
              .map((s: string, i: number) => `‚òê ${i + 1}. ${s}`)
              .join("\n")}\n\n` +
            `üìù OBSERVA√á√ïES:\n${analysisData.observations || "Nenhuma"}`,
        };

        setExpedientes((current) =>
          (current || []).map((e) => (e.id === selectedExp.id ? analyzed : e))
        );
        setSelectedExp(analyzed);
        toast.success("Mrs. Justin-e criou o workflow de controladoria!");
      }
    } catch (error) {
      console.error("Erro no workflow:", error);
      toast.error("Erro ao criar workflow. Tente novamente.");
    } finally {
      setAnalyzing(false);
      setShowMichaelRossDialog(false);
    }
  };

  // Limpar an√°lises antigas com erro para permitir re-an√°lise
  const handleClearFailedAnalysis = () => {
    const needsReanalysisList = safeExpedientes.filter(needsReanalysis);
    if (needsReanalysisList.length === 0) {
      toast.info("Nenhum expediente com an√°lise inv√°lida encontrado");
      return;
    }

    setExpedientes((current) =>
      (current || []).map((exp) =>
        needsReanalysis(exp)
          ? {
              ...exp,
              analyzed: false,
              summary: undefined,
              suggestedAction: undefined,
              pendingDocs: undefined,
            }
          : exp
      )
    );
    toast.success(`${needsReanalysisList.length} expediente(s) liberado(s) para re-an√°lise`);
  };

  const suggestedTasks = [
    "Apresentar alega√ß√µes finais",
    "Juntar documentos complementares",
    "Manifestar sobre documentos juntados",
    "Especificar provas",
    "Cumprir dilig√™ncia determinada",
    "Apresentar rol de testemunhas",
  ];

  return (
    <>
      <div className="p-6 space-y-6">
        <div className="flex items-start justify-between">
          <div>
            <h1 className="text-3xl font-bold text-foreground">Painel de Expedientes</h1>
            <p className="text-muted-foreground mt-1">
              Caixa de entrada inteligente com an√°lise de IA
            </p>
            <p className="text-xs text-muted-foreground mt-2">
              <span className="font-medium">Advogado:</span> Thiago Bodevan Veiga - OAB/MG 184.404
              {lastSync && (
                <span className="ml-2">
                  ‚Ä¢ √öltima verifica√ß√£o: {new Date(lastSync).toLocaleString("pt-BR")}
                </span>
              )}
            </p>
          </div>
          <div className="flex gap-2">
            {safeExpedientes.some(needsReanalysis) && (
              <Button
                onClick={handleClearFailedAnalysis}
                variant="outline"
                size="sm"
                title="Limpar an√°lises com erro para permitir re-an√°lise"
              >
                Limpar An√°lises Inv√°lidas
              </Button>
            )}
            <Button
              onClick={fetchExpedientes}
              disabled={loading}
              variant="outline"
              size="sm"
              data-testid="expedientes-sync-btn"
            >
              {loading ? "Atualizando..." : "Atualizar"}
            </Button>
          </div>
        </div>

        {/* Barra de progresso da an√°lise autom√°tica */}
        {autoAnalyzing && (
          <Card className="border-primary/50 bg-primary/5">
            <CardContent className="py-4">
              <div className="flex items-center gap-4">
                <div className="shrink-0"></div>
                <div className="flex-1">
                  <div className="flex items-center justify-between mb-2">
                    <p className="text-sm font-medium text-foreground">
                      ü§ñ Mrs. Justin-e analisando intima√ß√µes e distribuindo tarefas...
                    </p>
                    <span className="text-sm text-muted-foreground">
                      {analysisProgress.current}/{analysisProgress.total}
                    </span>
                  </div>
                  <Progress
                    value={(analysisProgress.current / analysisProgress.total) * 100}
                    className="h-2"
                  />
                  {tasksCreated > 0 && (
                    <p className="text-xs text-muted-foreground mt-2">
                      {tasksCreated} tarefa(s) distribu√≠da(s) para agentes
                      {deadlinesCreated > 0 && (
                        <span className="ml-2">{deadlinesCreated} prazo(s) na agenda</span>
                      )}
                    </p>
                  )}
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Status de an√°lises conclu√≠das */}
        {!autoAnalyzing &&
          safeExpedientes.length > 0 &&
          safeExpedientes.every((e) => e.analyzed && !needsReanalysis(e)) && (
            <Card className="border-green-500/50 bg-green-50 dark:bg-green-950/20">
              <CardContent className="py-3">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <p className="text-sm text-green-700 dark:text-green-400">
                      ‚úÖ Todas as {safeExpedientes.length} intima√ß√µes analisadas pela Mrs. Justin-e
                    </p>
                  </div>
                  {tasksCreated > 0 && (
                    <Badge variant="secondary" className="bg-blue-100 text-blue-700">
                      {tasksCreated} tarefas na fila dos agentes
                    </Badge>
                  )}
                  {deadlinesCreated > 0 && (
                    <Badge variant="secondary" className="bg-green-100 text-green-700">
                      {deadlinesCreated} prazos na agenda
                    </Badge>
                  )}
                </div>
              </CardContent>
            </Card>
          )}

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-1 space-y-4">
            <Card>
              <CardHeader>
                <CardTitle className="text-base flex items-center justify-between">
                  Expedientes Recentes
                  <Badge variant="secondary">{safeExpedientes.length}</Badge>
                </CardTitle>
                <CardDescription>Intima√ß√µes do DJEN aguardando an√°lise</CardDescription>
              </CardHeader>
              <CardContent className="space-y-2">
                {safeExpedientes.length === 0 ? (
                  <div className="text-center py-8 space-y-3">
                    <p className="text-sm text-muted-foreground">Nenhuma publica√ß√£o encontrada</p>
                    <p className="text-xs text-muted-foreground">
                      O monitor DJEN verifica automaticamente √†s 9h (UTC)
                    </p>
                    <Button
                      onClick={fetchExpedientes}
                      disabled={loading}
                      variant="outline"
                      size="sm"
                      className="mt-2"
                    >
                      Verificar Agora
                    </Button>
                  </div>
                ) : (
                  safeExpedientes.map((exp) => (
                    <button
                      key={exp.id}
                      className={`p-3 rounded-lg border cursor-pointer transition-colors ${
                        selectedExp?.id === exp.id
                          ? "bg-primary/10 border-primary"
                          : "bg-card border-border hover:bg-muted"
                      }`}
                      onClick={() => setSelectedExp(exp)}
                      type="button"
                    >
                      <div className="flex items-start justify-between gap-2">
                        <div className="flex-1 min-w-0">
                          <p className="text-sm font-medium line-clamp-1">{exp.type || exp.tipo}</p>
                          <p className="text-xs text-muted-foreground mt-1">
                            {new Date(
                              (exp.receivedAt ||
                                exp.dataRecebimento ||
                                new Date().toISOString()) as string
                            ).toLocaleDateString("pt-BR")}
                            {exp.tribunal && <span className="ml-1">‚Ä¢ {exp.tribunal}</span>}
                          </p>
                        </div>
                        {exp.analyzed ? (
                          <Badge variant="default">Analisado</Badge>
                        ) : (
                          <Badge variant="outline">Pendente</Badge>
                        )}
                      </div>
                    </button>
                  ))
                )}
              </CardContent>
            </Card>
          </div>

          <div className="lg:col-span-2 space-y-4">
            {selectedExp ? (
              <Card key="selected-expediente">
                <CardHeader>
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <CardTitle>{selectedExp.type}</CardTitle>
                      <CardDescription className="mt-1">
                        Recebido em{" "}
                        {new Date(
                          (selectedExp.receivedAt ||
                            selectedExp.dataRecebimento ||
                            new Date().toISOString()) as string
                        ).toLocaleDateString("pt-BR")}
                      </CardDescription>
                    </div>
                    {!selectedExp.analyzed && (
                      <div className="flex gap-2">
                        <Button
                          onClick={() => handleActivateMichaelRoss()}
                          disabled={analyzing}
                          variant="default"
                        >
                          {analyzing ? "Analisando..." : "Ativar Michael Ross"}
                        </Button>
                        <Button
                          onClick={() => handleAnalyze(selectedExp)}
                          disabled={analyzing}
                          variant="outline"
                        >
                          An√°lise Padr√£o
                        </Button>
                      </div>
                    )}
                    {selectedExp.analyzed && needsReanalysis(selectedExp) && (
                      <Button
                        onClick={() => handleAnalyze(selectedExp)}
                        disabled={analyzing}
                        variant="outline"
                        size="sm"
                      >
                        {analyzing ? "Re-analisando..." : "Re-analisar com IA"}
                      </Button>
                    )}
                  </div>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <h3 className="text-sm font-semibold mb-2">Conte√∫do Original</h3>
                    <div className="p-4 bg-muted rounded-lg">
                      <p className="text-sm whitespace-pre-wrap document-content">
                        {selectedExp.content}
                      </p>
                    </div>
                  </div>

                  {selectedExp.analyzed && (
                    <>
                      <div>
                        <h3 className="text-sm font-semibold mb-2 flex items-center gap-2">
                          Resumo Inteligente
                        </h3>
                        <div className="p-4 bg-accent/10 border border-accent/20 rounded-lg">
                          <p className="text-sm">{selectedExp.summary}</p>
                        </div>
                      </div>

                      <div>
                        <h3 className="text-sm font-semibold mb-2">A√ß√£o Sugerida</h3>
                        <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                          <p className="text-sm text-blue-900">{selectedExp.suggestedAction}</p>
                        </div>
                      </div>

                      {selectedExp.pendingDocs && selectedExp.pendingDocs.length > 0 && (
                        <div>
                          <h3 className="text-sm font-semibold mb-2">Documentos Pendentes</h3>
                          <div className="flex flex-wrap gap-2">
                            {selectedExp.pendingDocs.map((doc, _idx) => (
                              <Badge key={doc} variant="outline">
                                {doc}
                              </Badge>
                            ))}
                          </div>
                        </div>
                      )}

                      {selectedExp.draftPetition && (
                        <div>
                          <div className="flex items-center justify-between mb-2">
                            <h3 className="text-sm font-semibold flex items-center gap-2">
                              Minuta de Peti√ß√£o Gerada
                            </h3>
                            <Button variant="outline" size="sm">
                              Exportar
                            </Button>
                          </div>
                          <Textarea
                            value={selectedExp.draftPetition}
                            className="min-h-[200px] document-content"
                            readOnly
                          />
                        </div>
                      )}
                    </>
                  )}
                </CardContent>
              </Card>
            ) : (
              <Card key="empty-selection">
                <CardContent className="flex flex-col items-center justify-center py-16">
                  <p className="text-lg font-medium text-foreground">Selecione um expediente</p>
                  <p className="text-sm text-muted-foreground mt-1">
                    Escolha um expediente da lista para visualizar e analisar
                  </p>
                </CardContent>
              </Card>
            )}
          </div>
        </div>
      </div>

      <Dialog open={showMichaelRossDialog} onOpenChange={setShowMichaelRossDialog}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle className="text-2xl flex items-center gap-2">
              Mrs. Michael Ross - An√°lise de Intima√ß√£o
            </DialogTitle>
            <DialogDescription>
              Resumo: {selectedExp?.summary || "Intima√ß√£o recebida aguardando an√°lise detalhada"}
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="bg-accent/10 p-4 rounded-lg border border-accent/30">
              <p className="text-sm font-medium text-foreground mb-2">
                üìä An√°lise R√°pida (95% de precis√£o em menos de 1 minuto)
              </p>
              <p className="text-xs text-muted-foreground">
                Identifiquei que esta intima√ß√£o requer a√ß√£o. Selecione a tarefa mais pertinente ao
                caso:
              </p>
            </div>

            <div>
              <h4 className="text-sm font-semibold text-foreground mb-3">Tarefas Sugeridas:</h4>
              <div className="grid grid-cols-1 gap-2">
                {suggestedTasks.map((task, index) => (
                  <button
                    key={task}
                    onClick={() => handleSelectTask(task)}
                    disabled={analyzing}
                    className="p-3 text-left rounded-lg border border-border hover:border-primary hover:bg-primary/5 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center shrink-0">
                        <span className="text-xs font-bold text-primary">{index + 1}</span>
                      </div>
                      <span className="text-sm font-medium text-foreground">{task}</span>
                    </div>
                  </button>
                ))}
              </div>
            </div>

            <div className="bg-muted/50 p-3 rounded-lg">
              <p className="text-xs text-muted-foreground">
                üí° Ap√≥s selecionar, Mrs. Michael Ross ir√°:
                <br />‚Ä¢ Calcular prazos automaticamente (D-1, D-2 ou D-n)
                <br />‚Ä¢ Criar workflow de controladoria
                <br />‚Ä¢ Preparar atendimento
                <br />‚Ä¢ Gerar minuta de peti√ß√£o
              </p>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </>
  );
}
