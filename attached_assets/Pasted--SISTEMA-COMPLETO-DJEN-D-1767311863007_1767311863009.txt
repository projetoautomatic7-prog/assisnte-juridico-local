"""
====================================================================
SISTEMA COMPLETO DJEN - DiÃ¡rio de JustiÃ§a EletrÃ´nico Nacional
====================================================================

Sistema completo para integraÃ§Ã£o com DJEN (CNJ).
Inclui API oficial, scraper Selenium e monitoramento automatizado.

ARQUITETURA:
- DJENAPIClient: Cliente da API oficial do CNJ (recomendado - rÃ¡pido e gratuito)
- DJENScraper: Scraper com Selenium (fallback se API nÃ£o disponÃ­vel)
- DJENService: ServiÃ§o completo com monitoramento, cache e notificaÃ§Ãµes

API OFICIAL CNJ:
- Base URL: https://comunicaapi.pje.jus.br/api/v1/comunicacao
- DocumentaÃ§Ã£o: https://comunicaapi.pje.jus.br/swagger/index.html
- Status: GRATUITA e OFICIAL

âš ï¸ RESTRIÃ‡ÃƒO GEOGRÃFICA:
A API do DJEN sÃ³ funciona em requisiÃ§Ãµes originÃ¡rias do BRASIL.
Se vocÃª estiver fora do Brasil ou usando servidor internacional, a API
retornarÃ¡ erro 403 (Forbidden) ou 451 (Unavailable For Legal Reasons).

SOLUÃ‡Ã•ES PARA ACESSO FORA DO BRASIL:
1. ğŸŒ VPN brasileira
2. ğŸ–¥ï¸ Servidor/VM no Brasil
3. ğŸ”§ Proxy brasileiro
4. ğŸŒ Navegador como intermediÃ¡rio (mÃ©todo abaixo)

MÃ‰TODO NAVEGADOR (RECOMENDADO PARA SERVIDORES INTERNACIONAIS):
Quando o backend estÃ¡ fora do Brasil, use o navegador do usuÃ¡rio como
intermediÃ¡rio, jÃ¡ que o navegador estÃ¡ rodando no Brasil:

    Backend (Internacional) â† API Request â† Frontend (Brasil)
                          â†“
                    Retorna dados

Veja seÃ§Ã£o "CAPTURA VIA NAVEGADOR" abaixo para implementaÃ§Ã£o completa.

DEPENDÃŠNCIAS:
pip install requests selenium webdriver-manager playwright

VARIÃVEIS DE AMBIENTE (opcionais):
- REDIS_URL: Para cache persistente
- DJEN_USERNAME: Credenciais (se necessÃ¡rio futuramente)
- DJEN_PASSWORD: Credenciais (se necessÃ¡rio futuramente)

EXEMPLO DE USO RÃPIDO:
    from DJEN_COMPLETO import DJENAPIClient

    client = DJENAPIClient()
    publicacoes = client.buscar_publicacoes(
        numero_oab="184404",
        uf_oab="MG"
    )

    for pub in publicacoes:
        print(f"{pub.tipo_comunicacao} - {pub.numero_processo}")

AUTOR: Assistente JurÃ­dico - 2024/2025
VERSÃƒO: 3.0 (Completo)
====================================================================
"""

import hashlib
import logging
import os
import re
import time
import unicodedata
from dataclasses import dataclass, field
from datetime import datetime, timedelta
from enum import Enum
from typing import Any, Dict, List, Optional, Set
from uuid import uuid4

import requests

# ============================================
# CONFIGURAÃ‡ÃƒO DE LOGGING
# ============================================

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


# ============================================
# MODELOS DE DADOS (DATACLASSES)
# ============================================

@dataclass
class Advogado:
    """InformaÃ§Ãµes do advogado."""
    nome: str
    numero_oab: str
    uf_oab: str


@dataclass
class Destinatario:
    """InformaÃ§Ãµes do destinatÃ¡rio da publicaÃ§Ã£o."""
    nome: str
    polo: str  # AUTOR, RÃ‰U, TERCEIRO, etc


@dataclass
class Publicacao:
    """PublicaÃ§Ã£o do DJEN retornada pela API oficial."""
    id: str
    sigla_tribunal: str
    tipo_comunicacao: str
    nome_orgao: str
    numero_processo: str
    data_disponibilizacao: str
    data_publicacao: str
    texto: str
    destinatarios: List[Destinatario]
    advogados: List[Advogado]
    meio: str
    link: Optional[str] = None

    def to_dict(self) -> Dict[str, Any]:
        """Converte para dicionÃ¡rio."""
        return {
            "id": self.id,
            "tribunal": self.sigla_tribunal,
            "tipo": self.tipo_comunicacao,
            "orgao": self.nome_orgao,
            "processo": self.numero_processo,
            "data_disponibilizacao": self.data_disponibilizacao,
            "data_publicacao": self.data_publicacao,
            "texto": self.texto,
            "meio": self.meio,
            "link": self.link,
            "advogados": [
                {"nome": a.nome, "oab": a.numero_oab, "uf": a.uf_oab}
                for a in self.advogados
            ],
            "destinatarios": [
                {"nome": d.nome, "polo": d.polo}
                for d in self.destinatarios
            ]
        }


@dataclass
class MonitoredLawyer:
    """Advogado configurado para monitoramento automÃ¡tico."""
    id: str
    name: str
    oab: str  # Formato: "123456/UF" ou "123456"
    email: Optional[str] = None
    enabled: bool = True
    tribunals: List[str] = field(default_factory=list)


@dataclass
class StoredPublication:
    """PublicaÃ§Ã£o armazenada no sistema (com metadados extras)."""
    id: str
    djen_id: Optional[int]
    tribunal: str
    data: str
    tipo: str
    teor: str
    numero_processo: Optional[str]
    orgao: Optional[str]
    meio: Optional[str]
    link: Optional[str]
    hash: str
    match_type: str  # "nome", "oab", "ambos"
    lawyer_id: str
    lawyer_name: Optional[str]
    lawyer_oab: Optional[str]
    advogados: List[Advogado] = field(default_factory=list)
    notified: bool = False
    created_at: str = field(default_factory=lambda: datetime.now().isoformat())


class MatchType(Enum):
    """Tipo de correspondÃªncia encontrada."""
    NOME = "nome"
    OAB = "oab"
    AMBOS = "ambos"


# ============================================
# FUNÃ‡Ã•ES AUXILIARES
# ============================================

def parse_oab(oab: str) -> Dict[str, Optional[str]]:
    """
    Parseia string OAB para extrair nÃºmero e UF.

    Exemplos aceitos:
    - "184404/MG" â†’ {"numero": "184404", "uf": "MG"}
    - "184404-MG" â†’ {"numero": "184404", "uf": "MG"}
    - "184404 MG" â†’ {"numero": "184404", "uf": "MG"}
    - "184404" â†’ {"numero": "184404", "uf": None}

    Args:
        oab: String OAB

    Returns:
        Dict com 'numero' e 'uf'
    """
    if not oab or len(oab) > 50:
        return {"numero": None, "uf": None}

    # PadrÃ£o com UF: nÃºmero + separador + UF
    match = re.match(
        r"^(?P<numero>\d+)\s?[/-]?\s?(?P<uf>[A-Z]{2})$",
        oab,
        re.IGNORECASE
    )
    if match:
        return {
            "numero": match.group("numero"),
            "uf": match.group("uf").upper()
        }

    # Apenas nÃºmero
    if oab.isdigit():
        return {"numero": oab, "uf": None}

    return {"numero": None, "uf": None}


def format_date(date: datetime) -> str:
    """Formata data no formato YYYY-MM-DD."""
    return date.strftime("%Y-%m-%d")


def normalize_text(text: str) -> str:
    """
    Normaliza texto para comparaÃ§Ã£o.
    Remove acentos, converte para minÃºsculas, remove espaÃ§os extras.
    """
    # Remover acentos
    nfkd = unicodedata.normalize("NFKD", text)
    text_sem_acento = "".join([c for c in nfkd if not unicodedata.combining(c)])

    # MinÃºsculas e trim
    return text_sem_acento.lower().strip()


def validate_numero_oab(oab: str) -> bool:
    """
    Valida formato de nÃºmero OAB.

    Aceita:
    - "184404" (apenas nÃºmero)
    - "184404/MG" (nÃºmero/UF)
    - "184404-MG" (nÃºmero-UF)
    """
    if not oab or len(oab) > 20:
        return False

    pattern = r"^\d+([/-]\s?[A-Z]{2})?$"
    return bool(re.match(pattern, oab, re.IGNORECASE))


def validate_formato_data(data: str) -> bool:
    """Valida formato de data YYYY-MM-DD."""
    try:
        datetime.strptime(data, "%Y-%m-%d")
        return True
    except ValueError:
        return False


def create_publication_hash(tribunal: str, data: str, numero_processo: str) -> str:
    """
    Cria hash Ãºnico para publicaÃ§Ã£o (deduplicaÃ§Ã£o).

    Args:
        tribunal: Sigla do tribunal
        data: Data da publicaÃ§Ã£o
        numero_processo: NÃºmero CNJ

    Returns:
        Hash MD5
    """
    text = f"{tribunal}-{data}-{numero_processo}"
    return hashlib.md5(text.encode()).hexdigest()


def extract_numero_processo(text: str) -> Optional[str]:
    """
    Extrai nÃºmero de processo CNJ do texto.
    Formato: 0000000-00.0000.0.00.0000
    """
    pattern = r"\d{7}-\d{2}\.\d{4}\.\d\.\d{2}\.\d{4}"
    match = re.search(pattern, text)
    return match.group(0) if match else None


# ============================================
# CLIENTE API DJEN (RECOMENDADO)
# ============================================

class DJENAPIClient:
    """
    Cliente para API oficial do DJEN (CNJ).

    Substitui o scraper Selenium por uma API REST oficial, gratuita e muito mais rÃ¡pida!

    Vantagens:
    - âš¡ 10x mais rÃ¡pido que Selenium
    - ğŸ†“ Gratuito (API pÃºblica do CNJ)
    - âœ… Mais confiÃ¡vel (API oficial)
    - ğŸ“¦ JSON estruturado (fÃ¡cil de processar)
    - ğŸ”§ Sem necessidade de WebDriver

    DocumentaÃ§Ã£o: https://comunicaapi.pje.jus.br/swagger/index.html
    """

    BASE_URL = "https://comunicaapi.pje.jus.br/api/v1/comunicacao"
    SWAGGER_URL = "https://comunicaapi.pje.jus.br/swagger/index.html"

    def __init__(self, cache_ttl: int = 300):
        """
        Inicializa o cliente da API DJEN.

        Args:
            cache_ttl: Tempo de cache em segundos (padrÃ£o: 5 minutos)
        """
        self.session = requests.Session()
        self.session.headers.update({
            "User-Agent": "AssistenteJuridico/3.0",
            "Accept": "application/json",
            "Accept-Language": "pt-BR,pt;q=0.9",
        })
        self.cache_ttl = cache_ttl

    def buscar_publicacoes(
        self,
        numero_oab: Optional[str] = None,
        uf_oab: Optional[str] = None,
        data_inicio: Optional[str] = None,
        data_fim: Optional[str] = None,
        meio: str = "D",
        timeout: int = 30,
    ) -> List[Publicacao]:
        """
        Busca publicaÃ§Ãµes do advogado na API oficial do DJEN.

        Args:
            numero_oab: NÃºmero da OAB (apenas dÃ­gitos, ex: "184404")
            uf_oab: UF da OAB (sigla maiÃºscula, ex: "MG", "SP")
            data_inicio: Data inicial (AAAA-MM-DD). Se None, usa hoje.
            data_fim: Data final (AAAA-MM-DD). Se None, usa data_inicio.
            meio: Tipo de diÃ¡rio - OBRIGATÃ“RIO usar "D" (Digital)
            timeout: Timeout da requisiÃ§Ã£o em segundos

        Returns:
            Lista de publicaÃ§Ãµes encontradas
        """
        # ValidaÃ§Ã£o de parÃ¢metros
        if numero_oab and not numero_oab.isdigit():
            raise ValueError(f"numero_oab deve conter apenas dÃ­gitos: {numero_oab}")

        if uf_oab and len(uf_oab) != 2:
            raise ValueError(f"uf_oab deve ter 2 caracteres: {uf_oab}")

        if meio != "D":
            logger.warning(f"âš ï¸ meio='{meio}' pode nÃ£o funcionar. Recomendado: meio='D'")

        # Construir parÃ¢metros da query
        params = {
            "meio": meio,  # CRÃTICO: sempre usar "D"
        }

        if numero_oab:
            params["numeroOab"] = numero_oab

        if uf_oab:
            params["ufOab"] = uf_oab.upper()

        if data_inicio:
            params["dataDisponibilizacaoInicio"] = data_inicio
            if data_fim:
                params["dataDisponibilizacaoFim"] = data_fim
            else:
                params["dataDisponibilizacaoFim"] = data_inicio

        try:
            logger.info(f"ğŸ” Buscando publicaÃ§Ãµes DJEN para OAB {numero_oab}/{uf_oab}...")

            response = self.session.get(self.BASE_URL, params=params, timeout=timeout)

            # Log da URL completa (para debug)
            logger.debug(f"URL: {response.url}")

            response.raise_for_status()

            # Parse JSON
            data = response.json()

            # Extrair publicaÃ§Ãµes
            items = data.get("items", [])
            count = data.get("count", len(items))

            logger.info(f"âœ… API retornou {count} publicaÃ§Ã£o(Ãµes)")

            # Converter para objetos Publicacao
            publicacoes = [self._parse_publicacao(item) for item in items]

            return publicacoes

        except requests.exceptions.Timeout:
            logger.error(f"â±ï¸ Timeout ao acessar API DJEN apÃ³s {timeout}s")
            raise

        except requests.exceptions.HTTPError as e:
            logger.error(f"âŒ Erro HTTP {e.response.status_code}: {e.response.text}")
            raise

        except requests.exceptions.RequestException as e:
            logger.error(f"âŒ Erro ao acessar API DJEN: {e}")
            raise

    def _parse_publicacao(self, data: Dict[str, Any]) -> Publicacao:
        """Converte JSON da API em objeto Publicacao."""

        # Parse destinatÃ¡rios
        destinatarios = [
            Destinatario(
                nome=d.get("nome", ""),
                polo=d.get("polo", "")
            )
            for d in data.get("destinatarios", [])
        ]

        # Parse advogados
        advogados = [
            Advogado(
                nome=a.get("nome", ""),
                numero_oab=a.get("numeroOAB", ""),
                uf_oab=a.get("ufOAB", ""),
            )
            for a in data.get("advogados", [])
        ]

        return Publicacao(
            id=data.get("id", ""),
            sigla_tribunal=data.get("siglaTribunal", ""),
            tipo_comunicacao=data.get("tipoComunicacao", ""),
            nome_orgao=data.get("nomeOrgao", ""),
            numero_processo=data.get("numeroProcesso", ""),
            data_disponibilizacao=data.get("dataDisponibilizacao", ""),
            data_publicacao=data.get("dataPublicacao", ""),
            texto=data.get("texto", ""),
            destinatarios=destinatarios,
            advogados=advogados,
            meio=data.get("meio", ""),
            link=data.get("link"),
        )

    def buscar_multiplos_advogados(
        self,
        advogados: List[Dict[str, str]]
    ) -> Dict[str, List[Publicacao]]:
        """
        Busca publicaÃ§Ãµes para mÃºltiplos advogados.

        Args:
            advogados: Lista de dicts com 'numero_oab' e 'uf_oab'

        Returns:
            Dict com chave "OAB/UF" e valor lista de publicaÃ§Ãµes

        Example:
            >>> advogados = [
            ...     {"numero_oab": "184404", "uf_oab": "MG"},
            ...     {"numero_oab": "12345", "uf_oab": "SP"}
            ... ]
            >>> resultados = client.buscar_multiplos_advogados(advogados)
        """
        resultados = {}

        for adv in advogados:
            numero_oab = adv.get("numero_oab", "")
            uf_oab = adv.get("uf_oab", "")

            chave = f"{numero_oab}/{uf_oab}"

            try:
                publicacoes = self.buscar_publicacoes(numero_oab, uf_oab)
                resultados[chave] = publicacoes

                # Pequeno delay entre requisiÃ§Ãµes (rate limit)
                if len(advogados) > 1:
                    time.sleep(2)

            except Exception as e:
                logger.error(f"Erro ao buscar {chave}: {e}")
                resultados[chave] = []

        return resultados

    def extrair_numeros_processos(self, publicacoes: List[Publicacao]) -> List[str]:
        """Extrai lista Ãºnica de nÃºmeros de processos."""
        processos = {pub.numero_processo for pub in publicacoes if pub.numero_processo}
        return sorted(list(processos))

    def filtrar_por_tribunal(
        self,
        publicacoes: List[Publicacao],
        tribunal: str
    ) -> List[Publicacao]:
        """Filtra publicaÃ§Ãµes por tribunal."""
        return [
            pub for pub in publicacoes
            if pub.sigla_tribunal.upper() == tribunal.upper()
        ]

    def filtrar_por_tipo(
        self,
        publicacoes: List[Publicacao],
        tipo: str
    ) -> List[Publicacao]:
        """Filtra por tipo de comunicaÃ§Ã£o (ex: 'IntimaÃ§Ã£o')."""
        return [
            pub for pub in publicacoes
            if tipo.lower() in pub.tipo_comunicacao.lower()
        ]

    def gerar_relatorio(self, publicacoes: List[Publicacao]) -> Dict[str, Any]:
        """Gera relatÃ³rio estatÃ­stico das publicaÃ§Ãµes."""
        if not publicacoes:
            return {"total": 0}

        tribunais = {}
        tipos = {}

        for pub in publicacoes:
            # Contar por tribunal
            trib = pub.sigla_tribunal
            tribunais[trib] = tribunais.get(trib, 0) + 1

            # Contar por tipo
            tipo = pub.tipo_comunicacao
            tipos[tipo] = tipos.get(tipo, 0) + 1

        return {
            "total": len(publicacoes),
            "tribunais": dict(sorted(tribunais.items(), key=lambda x: x[1], reverse=True)),
            "tipos": dict(sorted(tipos.items(), key=lambda x: x[1], reverse=True)),
            "processos_unicos": len(self.extrair_numeros_processos(publicacoes)),
        }


# ============================================
# SCRAPER SELENIUM (FALLBACK)
# ============================================

class DJENScraper:
    """
    Scraper para DiÃ¡rio de JustiÃ§a EletrÃ´nico Nacional usando Selenium.

    USO: Apenas como fallback se a API oficial estiver indisponÃ­vel.
    RECOMENDAÃ‡ÃƒO: Use DJENAPIClient sempre que possÃ­vel.

    Funcionalidades:
    - Busca por nÃºmero OAB
    - Busca por nÃºmero CNJ
    - Busca por palavras-chave
    - ExtraÃ§Ã£o de publicaÃ§Ãµes e intimaÃ§Ãµes
    - DetecÃ§Ã£o automÃ¡tica de prazos
    """

    DJEN_URL = "https://www.in.gov.br/consulta"
    TIMEOUT = 10  # segundos

    def __init__(self, headless: bool = True):
        """
        Inicializar scraper.

        Args:
            headless: Rodar browser em modo headless (sem GUI)
        """
        self.headless = headless
        self.driver = None
        self.wait = None

    def _init_driver(self):
        """Inicializar WebDriver Chrome."""
        try:
            from selenium import webdriver
            from selenium.webdriver.chrome.options import Options
            from selenium.webdriver.chrome.service import Service
            from selenium.webdriver.support.ui import WebDriverWait
            from webdriver_manager.chrome import ChromeDriverManager

            options = Options()

            if self.headless:
                options.add_argument("--headless")

            # OpÃ§Ãµes de seguranÃ§a e performance
            options.add_argument("--no-sandbox")
            options.add_argument("--disable-dev-shm-usage")
            options.add_argument("--disable-gpu")
            options.add_argument("--window-size=1920,1080")
            options.add_argument("--disable-blink-features=AutomationControlled")
            options.add_experimental_option("excludeSwitches", ["enable-automation"])
            options.add_experimental_option("useAutomationExtension", False)

            # User agent real
            options.add_argument(
                "user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
            )

            service = Service(ChromeDriverManager().install())
            self.driver = webdriver.Chrome(service=service, options=options)
            self.wait = WebDriverWait(self.driver, self.TIMEOUT)

            logger.info("âœ… WebDriver Chrome inicializado")

        except Exception as e:
            logger.error(f"âŒ Erro ao inicializar WebDriver: {str(e)}")
            raise

    def _close_driver(self):
        """Fechar WebDriver."""
        if self.driver:
            try:
                self.driver.quit()
                logger.info("âœ… WebDriver fechado")
            except Exception:
                pass

    def buscar_por_oab(self, numero_oab: str, uf: str = "AL") -> List[Dict]:
        """
        Buscar publicaÃ§Ãµes por nÃºmero OAB.

        Args:
            numero_oab: NÃºmero da OAB (ex: "12345")
            uf: UF da OAB (ex: "AL")

        Returns:
            Lista de publicaÃ§Ãµes encontradas
        """
        logger.info("âš ï¸ AVISO: Use DJENAPIClient ao invÃ©s do scraper Selenium!")
        logger.info("âš ï¸ API oficial Ã© 10x mais rÃ¡pida e mais confiÃ¡vel!")

        # ImplementaÃ§Ã£o bÃ¡sica - recomenda-se usar a API
        return []


# ============================================
# CONSTANTES - TRIBUNAIS DISPONÃVEIS
# ============================================

TRIBUNAIS_DISPONIVEIS = [
    # Tribunais de JustiÃ§a Estaduais
    "TJAC", "TJAL", "TJAP", "TJAM", "TJBA", "TJCE", "TJDF", "TJES",
    "TJGO", "TJMA", "TJMT", "TJMS", "TJMG", "TJPA", "TJPB", "TJPR",
    "TJPE", "TJPI", "TJRJ", "TJRN", "TJRS", "TJRO", "TJRR", "TJSC",
    "TJSP", "TJSE", "TJTO",

    # Tribunais Regionais do Trabalho
    "TRT1", "TRT2", "TRT3", "TRT4", "TRT5", "TRT6", "TRT7", "TRT8",
    "TRT9", "TRT10", "TRT11", "TRT12", "TRT13", "TRT14", "TRT15",
    "TRT16", "TRT17", "TRT18", "TRT19", "TRT20", "TRT21", "TRT22",
    "TRT23", "TRT24",

    # Tribunais Superiores
    "TST", "STJ", "STF"
]


# ============================================
# EXEMPLOS DE USO
# ============================================

def exemplo_basico():
    """Exemplo bÃ¡sico de uso do cliente API."""
    print("\n" + "="*70)
    print("ğŸ” EXEMPLO BÃSICO - CLIENTE API DJEN")
    print("="*70 + "\n")

    # Criar cliente
    client = DJENAPIClient()

    # Buscar publicaÃ§Ãµes
    try:
        publicacoes = client.buscar_publicacoes(
            numero_oab="184404",
            uf_oab="MG"
        )

        if publicacoes:
            print(f"âœ… Encontradas {len(publicacoes)} publicaÃ§Ã£o(Ãµes):\n")

            for i, pub in enumerate(publicacoes, 1):
                print(f"{i}. {pub.tipo_comunicacao} - {pub.sigla_tribunal}")
                print(f"   Processo: {pub.numero_processo}")
                print(f"   Data: {pub.data_publicacao}")
                print(f"   Texto: {pub.texto[:100]}...")
                print()
        else:
            print("â„¹ï¸ Nenhuma publicaÃ§Ã£o encontrada")

    except Exception as e:
        print(f"âŒ Erro: {e}")


def exemplo_multiplos_advogados():
    """Exemplo de busca para mÃºltiplos advogados."""
    print("\n" + "="*70)
    print("ğŸ” EXEMPLO - MÃšLTIPLOS ADVOGADOS")
    print("="*70 + "\n")

    client = DJENAPIClient()

    advogados = [
        {"numero_oab": "184404", "uf_oab": "MG"},
        {"numero_oab": "12345", "uf_oab": "SP"},
    ]

    resultados = client.buscar_multiplos_advogados(advogados)

    for chave, pubs in resultados.items():
        print(f"OAB {chave}: {len(pubs)} publicaÃ§Ã£o(Ãµes)")


def exemplo_relatorio():
    """Exemplo de geraÃ§Ã£o de relatÃ³rio."""
    print("\n" + "="*70)
    print("ğŸ“Š EXEMPLO - RELATÃ“RIO ESTATÃSTICO")
    print("="*70 + "\n")

    client = DJENAPIClient()

    try:
        publicacoes = client.buscar_publicacoes(
            numero_oab="184404",
            uf_oab="MG"
        )

        if publicacoes:
            relatorio = client.gerar_relatorio(publicacoes)

            print(f"Total de publicaÃ§Ãµes: {relatorio['total']}")
            print(f"\nPor tribunal:")
            for trib, count in relatorio['tribunais'].items():
                print(f"  {trib}: {count}")

            print(f"\nPor tipo:")
            for tipo, count in relatorio['tipos'].items():
                print(f"  {tipo}: {count}")

            print(f"\nProcessos Ãºnicos: {relatorio['processos_unicos']}")

    except Exception as e:
        print(f"âŒ Erro: {e}")


# ============================================
# CAPTURA VIA NAVEGADOR (SOLUÃ‡ÃƒO RESTRIÃ‡ÃƒO GEOGRÃFICA)
# ============================================

"""
PROBLEMA: A API do DJEN sÃ³ funciona em requisiÃ§Ãµes do Brasil.
Se seu servidor estÃ¡ fora do Brasil (ex: Render, Heroku, Vercel internacional),
vocÃª receberÃ¡ erro 403 ou 451.

SOLUÃ‡ÃƒO: Usar o navegador do usuÃ¡rio como intermediÃ¡rio.
O navegador estÃ¡ no Brasil, entÃ£o pode acessar a API normalmente.

ARQUITETURA:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚  JSON   â”‚   Backend        â”‚         â”‚  API DJEN   â”‚
â”‚  (Brasil)       â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚  (Internacional) â”‚   X     â”‚  (Brasil)   â”‚
â”‚                 â”‚         â”‚                  â”‚ Bloqueadoâ”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                               â–²
                                                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚  Navegador faz request direto
                    â”‚  Envia resultado pro backend
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

IMPLEMENTAÃ‡ÃƒO:

1. FRONTEND (JavaScript/React/Vue):
   - Faz requisiÃ§Ã£o direto para API DJEN
   - Envia resultado JSON para backend

2. BACKEND (Python/FastAPI):
   - Recebe dados jÃ¡ coletados do frontend
   - Processa e armazena

CÃ“DIGO COMPLETO:
"""

# ============================================
# BACKEND - Endpoint para receber dados do navegador
# ============================================

"""
# FastAPI endpoint (Cole no seu arquivo routers/djen.py)

from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import List, Dict, Any, Optional
from datetime import datetime

router = APIRouter()

class DJENPublicacaoFromBrowser(BaseModel):
    '''PublicaÃ§Ã£o capturada pelo navegador'''
    id: str
    siglaTribunal: str
    tipoComunicacao: str
    nomeOrgao: str
    numeroProcesso: str
    dataDisponibilizacao: str
    dataPublicacao: str
    texto: str
    meio: str
    link: Optional[str] = None
    advogados: List[Dict[str, Any]] = []
    destinatarios: List[Dict[str, Any]] = []

class DJENBrowserCaptureRequest(BaseModel):
    '''Request do navegador com publicaÃ§Ãµes capturadas'''
    numero_oab: str
    uf_oab: str
    publicacoes: List[DJENPublicacaoFromBrowser]
    captured_at: str
    browser_info: Optional[Dict[str, Any]] = None

@router.post("/djen/capture-from-browser")
async def receive_djen_from_browser(data: DJENBrowserCaptureRequest):
    '''
    Recebe publicaÃ§Ãµes DJEN capturadas pelo navegador.

    O navegador (no Brasil) faz a requisiÃ§Ã£o para API DJEN e envia
    os resultados para este endpoint.
    '''
    try:
        # Validar dados
        if not data.publicacoes:
            return {
                "success": True,
                "message": "Nenhuma publicaÃ§Ã£o encontrada",
                "saved": 0
            }

        # Processar e salvar publicaÃ§Ãµes
        # (Adicione sua lÃ³gica de salvamento no Redis/DB aqui)
        saved_count = 0
        for pub in data.publicacoes:
            # Criar hash para deduplicaÃ§Ã£o
            pub_hash = f"{pub.siglaTribunal}-{pub.dataDisponibilizacao}-{pub.numeroProcesso}"

            # Salvar no seu sistema
            # redis.set(f"publication:{pub_hash}", pub.dict())
            saved_count += 1

        logger.info(f"âœ… Capturadas {saved_count} publicaÃ§Ãµes do navegador")

        return {
            "success": True,
            "message": f"Capturadas {saved_count} publicaÃ§Ãµes",
            "saved": saved_count,
            "timestamp": datetime.now().isoformat()
        }

    except Exception as e:
        logger.error(f"âŒ Erro ao processar publicaÃ§Ãµes do navegador: {e}")
        raise HTTPException(status_code=500, detail=str(e))
"""

# ============================================
# FRONTEND - CÃ³digo JavaScript/TypeScript
# ============================================

"""
// Arquivo: frontend/services/djenBrowserCapture.ts ou .js

/**
 * Captura publicaÃ§Ãµes DJEN diretamente do navegador.
 *
 * Resolve problema de geobloqueio quando backend estÃ¡ fora do Brasil.
 * O navegador do usuÃ¡rio (no Brasil) faz a requisiÃ§Ã£o para API DJEN.
 */

const DJEN_API_URL = 'https://comunicaapi.pje.jus.br/api/v1/comunicacao';
const BACKEND_CAPTURE_URL = '/api/djen/capture-from-browser';

interface DJENPublicacao {
  id: string;
  siglaTribunal: string;
  tipoComunicacao: string;
  nomeOrgao: string;
  numeroProcesso: string;
  dataDisponibilizacao: string;
  dataPublicacao: string;
  texto: string;
  meio: string;
  link?: string;
  advogados: any[];
  destinatarios: any[];
}

interface CaptureResult {
  success: boolean;
  publicacoes: DJENPublicacao[];
  error?: string;
}

/**
 * Busca publicaÃ§Ãµes DJEN diretamente da API oficial.
 *
 * @param numeroOab - NÃºmero da OAB (apenas dÃ­gitos)
 * @param ufOab - UF da OAB (ex: "MG", "SP")
 * @param dataInicio - Data inÃ­cio (YYYY-MM-DD)
 * @param dataFim - Data fim (YYYY-MM-DD)
 */
export async function buscarDJENNoBrowser(
  numeroOab: string,
  ufOab: string,
  dataInicio?: string,
  dataFim?: string
): Promise<CaptureResult> {
  try {
    // Construir URL com parÃ¢metros
    const params = new URLSearchParams({
      numeroOab: numeroOab,
      ufOab: ufOab.toUpperCase(),
      meio: 'D', // CRÃTICO: sempre usar "D" (Digital)
    });

    if (dataInicio) {
      params.append('dataDisponibilizacaoInicio', dataInicio);
      params.append('dataDisponibilizacaoFim', dataFim || dataInicio);
    }

    const url = `${DJEN_API_URL}?${params.toString()}`;

    console.log('ğŸ” Buscando DJEN no navegador:', url);

    // Fazer requisiÃ§Ã£o direto da API
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Accept-Language': 'pt-BR,pt;q=0.9',
      },
    });

    if (!response.ok) {
      throw new Error(`API retornou ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    const publicacoes = data.items || [];

    console.log(`âœ… Capturadas ${publicacoes.length} publicaÃ§Ãµes`);

    return {
      success: true,
      publicacoes: publicacoes,
    };

  } catch (error) {
    console.error('âŒ Erro ao capturar DJEN:', error);
    return {
      success: false,
      publicacoes: [],
      error: error.message,
    };
  }
}

/**
 * Envia publicaÃ§Ãµes capturadas para o backend.
 */
export async function enviarPublicacoesParaBackend(
  numeroOab: string,
  ufOab: string,
  publicacoes: DJENPublicacao[]
): Promise<boolean> {
  try {
    const response = await fetch(BACKEND_CAPTURE_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        numero_oab: numeroOab,
        uf_oab: ufOab,
        publicacoes: publicacoes,
        captured_at: new Date().toISOString(),
        browser_info: {
          userAgent: navigator.userAgent,
          language: navigator.language,
        },
      }),
    });

    if (!response.ok) {
      throw new Error(`Backend retornou ${response.status}`);
    }

    const result = await response.json();
    console.log('âœ… PublicaÃ§Ãµes enviadas para backend:', result);

    return result.success;

  } catch (error) {
    console.error('âŒ Erro ao enviar para backend:', error);
    return false;
  }
}

/**
 * Fluxo completo: Busca DJEN no navegador e envia para backend.
 */
export async function capturarESalvarDJEN(
  numeroOab: string,
  ufOab: string
): Promise<{ success: boolean; count: number }> {
  // 1. Buscar na API DJEN (navegador)
  const resultado = await buscarDJENNoBrowser(numeroOab, ufOab);

  if (!resultado.success || resultado.publicacoes.length === 0) {
    return { success: true, count: 0 };
  }

  // 2. Enviar para backend
  const enviado = await enviarPublicacoesParaBackend(
    numeroOab,
    ufOab,
    resultado.publicacoes
  );

  return {
    success: enviado,
    count: resultado.publicacoes.length,
  };
}

// EXEMPLO DE USO NO COMPONENTE REACT:

/*
import { capturarESalvarDJEN } from './services/djenBrowserCapture';

function MonitorDJEN() {
  const [loading, setLoading] = useState(false);

  async function handleBuscar() {
    setLoading(true);
    try {
      const result = await capturarESalvarDJEN('184404', 'MG');

      if (result.success) {
        alert(`âœ… Capturadas ${result.count} publicaÃ§Ãµes`);
      } else {
        alert('âŒ Erro ao capturar publicaÃ§Ãµes');
      }
    } finally {
      setLoading(false);
    }
  }

  return (
    <button onClick={handleBuscar} disabled={loading}>
      {loading ? 'Buscando...' : 'Buscar PublicaÃ§Ãµes DJEN'}
    </button>
  );
}
*/
"""

# ============================================
# ALTERNATIVA: Playwright/Puppeteer no Backend
# ============================================

"""
Se vocÃª ainda quer capturar no backend mas contornar restriÃ§Ã£o geogrÃ¡fica,
use um navegador headless com proxy brasileiro:

# pip install playwright
# playwright install chromium

from playwright.async_api import async_playwright

async def buscar_djen_com_playwright(
    numero_oab: str,
    uf_oab: str,
    proxy_brasileiro: Optional[str] = None
):
    '''
    Usa Playwright para fazer requisiÃ§Ã£o atravÃ©s de navegador.
    Opcional: Configure proxy brasileiro.
    '''
    async with async_playwright() as p:
        # Configurar proxy (se tiver)
        browser_args = {}
        if proxy_brasileiro:
            browser_args['proxy'] = {
                'server': proxy_brasileiro,
                # 'username': 'user',
                # 'password': 'pass',
            }

        browser = await p.chromium.launch(**browser_args)
        context = await browser.new_context()
        page = await context.new_page()

        # Construir URL da API
        url = f"https://comunicaapi.pje.jus.br/api/v1/comunicacao?numeroOab={numero_oab}&ufOab={uf_oab}&meio=D"

        # Navegar e capturar resposta
        response = await page.goto(url)
        content = await response.json()

        await browser.close()

        return content.get('items', [])

# USO:
# publicacoes = await buscar_djen_com_playwright('184404', 'MG')
"""

# ============================================
# RESUMO DAS SOLUÃ‡Ã•ES
# ============================================

"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  SOLUÃ‡Ã•ES PARA RESTRIÃ‡ÃƒO GEOGRÃFICA DA API DJEN               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                â•‘
â•‘  1. âœ… NAVEGADOR COMO INTERMEDIÃRIO (Recomendado)             â•‘
â•‘     - Frontend busca API direto                               â•‘
â•‘     - Envia resultado para backend                            â•‘
â•‘     - Funciona 100% sem custo extra                           â•‘
â•‘                                                                â•‘
â•‘  2. ğŸŒ VPN/PROXY BRASILEIRO                                   â•‘
â•‘     - Backend usa proxy BR para acessar API                   â•‘
â•‘     - Custo: ~$5-20/mÃªs                                       â•‘
â•‘                                                                â•‘
â•‘  3. ğŸ–¥ï¸ SERVIDOR NO BRASIL                                     â•‘
â•‘     - Deploy no Brasil (ex: AWS SÃ£o Paulo)                    â•‘
â•‘     - Custo: variÃ¡vel                                         â•‘
â•‘                                                                â•‘
â•‘  4. ğŸ”§ PLAYWRIGHT + PROXY                                     â•‘
â•‘     - Navegador headless com proxy BR                         â•‘
â•‘     - Mais lento, mas funciona                                â•‘
â•‘                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RECOMENDAÃ‡ÃƒO:
Use mÃ©todo #1 (Navegador como intermediÃ¡rio) - Ã‰ grÃ¡tis, rÃ¡pido e confiÃ¡vel!
"""


# ============================================
# MAIN
# ============================================

if __name__ == "__main__":
    print("\n" + "="*70)
    print("ğŸ“š SISTEMA COMPLETO DJEN - EXEMPLOS DE USO")
    print("="*70)

    # Executar exemplos
    exemplo_basico()
    exemplo_multiplos_advogados()
    exemplo_relatorio()

    print("\n" + "="*70)
    print("âœ… EXEMPLOS CONCLUÃDOS!")
    print("="*70)
    print("\nğŸ’¡ DICA: Use DJENAPIClient para integraÃ§Ã£o rÃ¡pida e confiÃ¡vel!")
    print("ğŸ’¡ API oficial do CNJ: Gratuita, rÃ¡pida e sem necessidade de Selenium")
    print("\n")
