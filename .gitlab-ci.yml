# GitLab CI/CD - ConfiguraÃ§Ã£o Simplificada e CompatÃ­vel
# Resolve conflitos entre mÃºltiplas configuraÃ§Ãµes CI/CD
# Foco: SAST (Static Application Security Testing) funcional

stages:
  - security
  - test
  - build

# ConfiguraÃ§Ãµes globais para Node.js/React
variables:
  NODE_VERSION: "22"
  NODE_ENV: "production"
  PROJECT_TYPE: "nodejs"
  PROJECT_LANGUAGE: "typescript"
  PROJECT_FRAMEWORK: "react"

# Cache para dependÃªncias Node.js
cache:
  key: "npm-cache-${CI_COMMIT_REF_SLUG}"
  paths:
    - .npm/
    - node_modules/

# ===== SAST (Static Application Security Testing) =====
# ConfiguraÃ§Ã£o especÃ­fica para resolver "No valid project detected"

include:
  # SAST padrÃ£o do GitLab para projetos Node.js
  - template: Security/SAST.gitlab-ci.yml
  # Auto DevOps opcional (descomente se quiser usar)
  - local: '.gitlab-ci-auto-devops.yml'

# Job adicional: SAST customizado para React/TypeScript
sast-custom:
  stage: security
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ” Executando SAST customizado para React/TypeScript..."
    - |
      # Verificar vulnerabilidades de seguranÃ§a no cÃ³digo
      if grep -r "eval(\|innerHTML\|document\.write" src/ --include="*.ts" --include="*.tsx" | grep -v node_modules; then
        echo "ğŸš¨ CÃ³digo perigoso detectado (XSS potencial)!"
        exit 1
      else
        echo "âœ… Nenhum cÃ³digo XSS detectado"
      fi
    - |
      # Verificar uso de bibliotecas desatualizadas
      OUTDATED=$(npm outdated --json 2>/dev/null | jq 'length' 2>/dev/null || echo "0")
      if [ "$OUTDATED" -gt "10" ]; then
        echo "âš ï¸ Muitas dependÃªncias desatualizadas: $OUTDATED"
        npm outdated
      else
        echo "âœ… DependÃªncias atualizadas"
      fi
  artifacts:
    reports:
      sast: sast-report.json
    paths:
      - sast-report.json
    expire_in: 1 week
  allow_failure: true

# ===== TESTES =====

test:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ§ª Executando testes..."
    - npm run test:run
    - npm run test:api
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: coverage/junit-report.xml
    paths:
      - coverage/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# ===== BUILD =====

build:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ—ï¸ Construindo aplicaÃ§Ã£o..."
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop
# ===== CONFIGURAÃ‡Ã•ES DE PROJETO =====
# Para ajudar o GitLab a detectar corretamente o tipo de projeto

# Indicador explÃ­cito do tipo de projeto (jÃ¡ definido nas variÃ¡veis globais acima)
# PROJECT_TYPE: nodejs
# PROJECT_LANGUAGE: typescript
# PROJECT_FRAMEWORK: react
