name: Deploy Automatizado com Rollback

on:
  push:
    branches: [ main, staging ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      force_deploy:
        description: 'ForÃ§ar deploy mesmo com falhas'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-${{ github.ref }}-v2
  cancel-in-progress: true

jobs:
  # ==========================================
  # ðŸš€ DEPLOY STAGING
  # ==========================================

  deploy-staging:
    name: 'ðŸš€ Deploy Staging'
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    outputs:
      url: ${{ steps.deploy-staging.outputs.url }}
    environment:
      name: staging
      url: ${{ steps.deploy-staging.outputs.url }}

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: ðŸ“¦ Instalar dependÃªncias
      run: npm ci

    - name: ðŸ“Š Verificar limites Serverless (Pro)
      run: |
        FUNCTION_COUNT=$(find api -type f -name "*.ts" | wc -l)
        LIMIT=100  # Pro plan limit
        echo "ðŸ“Š Serverless functions detected: $FUNCTION_COUNT"

        if [ "$FUNCTION_COUNT" -gt "$LIMIT" ]; then
          echo "::warning::Function count ($FUNCTION_COUNT) exceeds the Pro limit ($LIMIT)."
        fi

        echo "## ðŸ“Š Function Count Report" >> $GITHUB_STEP_SUMMARY
        echo "- **Total functions:** $FUNCTION_COUNT/100 (Pro)" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ¤– Verificar arquivos dos Agentes
      run: |
        echo "ðŸ¤– Verificando integridade dos Agentes..."
        REQUIRED_FILES=("api/agents.ts" "src/hooks/use-autonomous-agents.ts")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Arquivo obrigatÃ³rio faltando: $file"
            exit 1
          fi
        done
        echo "âœ… Todos os arquivos de agentes presentes"

    - name: ðŸ§ª Executar testes rÃ¡pidos
      run: |
        echo "ðŸ§ª Executando testes rÃ¡pidos..."
        npm run test -- --run --reporter=verbose || exit 1
        echo "âœ… Testes passaram"
      env:
        VITE_GITHUB_OAUTH_CLIENT_ID: mock_client_id
        GITHUB_OAUTH_CLIENT_SECRET: mock_secret
        VITE_GOOGLE_CLIENT_ID: mock_google_client
        VITE_GOOGLE_API_KEY: mock_google_api_key
        VITE_APP_ENV: test

    - name: ðŸ—ï¸  Build staging
      run: |
        echo "ðŸ—ï¸  Executando build para staging..."
        npm run build
        echo "ðŸ“¦ Build staging concluÃ­do"

    - name: ðŸ” Verificar configuraÃ§Ã£o do Vercel
      run: |
        echo "ðŸ” Verificando secrets do Vercel..."
        MISSING=0
        
        if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
          echo "âŒ VERCEL_TOKEN nÃ£o configurado"
          MISSING=$((MISSING + 1))
        else
          echo "âœ… VERCEL_TOKEN configurado"
        fi
        
        if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
          echo "âŒ VERCEL_ORG_ID nÃ£o configurado"
          MISSING=$((MISSING + 1))
        else
          echo "âœ… VERCEL_ORG_ID configurado"
        fi
        
        if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
          echo "âŒ VERCEL_PROJECT_ID nÃ£o configurado"
          MISSING=$((MISSING + 1))
        else
          echo "âœ… VERCEL_PROJECT_ID configurado"
        fi
        
        if [ $MISSING -gt 0 ]; then
          echo ""
          echo "ðŸ“– Configure os secrets em: Settings â†’ Secrets and variables â†’ Actions"
          echo "   Veja: CONFIGURACAO_VERCEL_TOKEN.md para instruÃ§Ãµes"
          exit 1
        fi

    - name: ðŸ”§ Configurar projeto Vercel
      run: |
        mkdir -p .vercel
        echo '{"orgId":"${{ secrets.VERCEL_ORG_ID }}","projectId":"${{ secrets.VERCEL_PROJECT_ID }}"}' > .vercel/project.json
        cat .vercel/project.json

    - name: ðŸš€ Deploy para Vercel Staging
      id: deploy-staging
      run: |
        echo "ðŸš€ Deploy para Vercel Staging..."
        DEPLOY_URL=$(npx vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --yes 2>&1 | tee /dev/stderr | grep -E "^https://" | tail -1)
        if [ -z "$DEPLOY_URL" ]; then
          echo "âŒ Falha ao obter URL do deploy"
          exit 1
        fi
        echo "âœ… Deploy staging concluÃ­do: $DEPLOY_URL"
        echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    - name: ðŸ§ª Testes de smoke no staging
      run: |
        echo "ðŸ§ª Executando testes de smoke..."
        sleep 30  # Aguardar deploy
        curl -f ${{ steps.deploy-staging.outputs.url }} > /dev/null && echo "âœ… Staging responde" || exit 1

    - name: ðŸ·ï¸  Criar tag de staging
      run: |
        echo "ðŸ·ï¸  Criando tag de staging..."
        git tag "staging-$(date +%Y%m%d-%H%M%S)" || echo "Tag jÃ¡ existe"

  # ==========================================
  # ðŸŽ¯ DEPLOY PRODUCTION COM ROLLBACK
  # ==========================================

  deploy-production:
    name: 'ðŸŽ¯ Deploy Production com Rollback'
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: (github.ref == 'refs/heads/main' && needs.deploy-staging.result == 'success') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    outputs:
      url: ${{ steps.deploy-production.outputs.url }}
    environment:
      name: production
      url: ${{ steps.deploy-production.outputs.url }}

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: ðŸ“¦ Instalar dependÃªncias
      run: npm ci

    - name: ðŸ§ª Testes completos antes do deploy
      run: |
        echo "ðŸ§ª Executando testes completos..."
        npm run test -- --run --coverage || exit 1
        npm run test:e2e || exit 1
        echo "âœ… Todos os testes passaram"

    - name: ðŸ—ï¸  Build production otimizado
      run: |
        echo "ðŸ—ï¸  Build production otimizado..."
        npm run build
        echo "ðŸ“¦ Build production concluÃ­do"
        echo "ðŸ“Š Tamanho: $(du -sh dist/)"

    - name: ðŸ’¾ Backup da versÃ£o atual
      run: |
        echo "ðŸ’¾ Criando backup da versÃ£o atual..."
        # Aqui vocÃª pode implementar backup da versÃ£o atual
        VERSION=$(date +%Y%m%d-%H%M%S)
        echo "BACKUP_VERSION=$VERSION" >> $GITHUB_ENV
        echo "âœ… Backup criado: $VERSION"

    - name: ðŸ”§ Configurar projeto Vercel (Production)
      run: |
        mkdir -p .vercel
        echo '{"orgId":"${{ secrets.VERCEL_ORG_ID }}","projectId":"${{ secrets.VERCEL_PROJECT_ID }}"}' > .vercel/project.json

    - name: ðŸš€ Deploy para Vercel Production
      id: deploy-production
      run: |
        echo "ðŸš€ Deploy para Vercel Production..."
        DEPLOY_URL=$(npx vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --yes 2>&1 | tee /dev/stderr | grep -E "^https://" | tail -1)
        if [ -z "$DEPLOY_URL" ]; then
          echo "âŒ Falha ao obter URL do deploy"
          exit 1
        fi
        echo "âœ… Deploy production concluÃ­do: $DEPLOY_URL"
        echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    - name: ðŸ§ª Testes de produÃ§Ã£o
      id: production-tests
      run: |
        echo "ðŸ§ª Executando testes de produÃ§Ã£o..."
        sleep 60  # Aguardar deploy completo

        # Teste bÃ¡sico de conectividade
        if curl -f --max-time 30 ${{ steps.deploy-production.outputs.url }} > /dev/null; then
          echo "âœ… AplicaÃ§Ã£o responde"
        else
          echo "âŒ AplicaÃ§Ã£o nÃ£o responde"
          exit 1
        fi

        # Teste de funcionalidades crÃ­ticas
        # Adicione mais testes conforme necessÃ¡rio
        echo "âœ… Testes de produÃ§Ã£o passaram"

    - name: ðŸ“Š Health check avanÃ§ado
      run: |
        echo "ðŸ“Š Executando health check avanÃ§ado..."
        # Verificar performance bÃ¡sica
        curl -w "@curl-format.txt" -o /dev/null -s ${{ steps.deploy-production.outputs.url }} > response-time.txt || echo "Health check bÃ¡sico falhou"

        # Verificar se APIs respondem
        # Adicione verificaÃ§Ãµes especÃ­ficas da sua aplicaÃ§Ã£o
        echo "âœ… Health check concluÃ­do"

    - name: ðŸ·ï¸  Criar release tag
      run: |
        echo "ðŸ·ï¸  Criando release tag..."
        git tag "release-$(date +%Y%m%d-%H%M%S)"
        git push origin --tags

  # ==========================================
  # ðŸ”„ MONITORAMENTO PÃ“S-DEPLOY
  # ==========================================

  post-deploy-monitoring:
    name: 'ðŸ”„ Monitoramento PÃ³s-Deploy'
    runs-on: ubuntu-latest
    needs: deploy-production
    if: needs.deploy-production.result == 'success'

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ“Š Monitoramento inicial
      run: |
        echo "ðŸ“Š Iniciando monitoramento pÃ³s-deploy..."
        PRODUCTION_URL="${{ needs.deploy-production.outputs.url }}"

        # Verificar uptime nos primeiros minutos
        for i in {1..5}; do
          if curl -f --max-time 10 $PRODUCTION_URL > /dev/null; then
            echo "âœ… Minuto $i: OK"
          else
            echo "âŒ Minuto $i: FALHA"
            exit 1
          fi
          sleep 60
        done

        echo "âœ… Monitoramento inicial concluÃ­do"

    - name: ðŸƒ Lighthouse pÃ³s-deploy
      run: |
        echo "ðŸƒ Executando Lighthouse pÃ³s-deploy..."
        npx lighthouse ${{ needs.deploy-production.outputs.url }} \
          --output=json \
          --output-path=./post-deploy-lighthouse.json \
          --only-categories=performance \
          --chrome-flags="--headless --disable-gpu --no-sandbox"

    - name: ðŸ“¤ Upload relatÃ³rios de monitoramento
      uses: actions/upload-artifact@v4
      with:
        name: post-deploy-monitoring
        path: |
          post-deploy-lighthouse.json
          response-time.txt

  # ==========================================
  # ðŸ”™ ROLLBACK AUTOMÃTICO
  # ==========================================

  rollback-on-failure:
    name: 'ðŸ”™ Rollback AutomÃ¡tico'
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deploy-monitoring]
    if: failure() && (needs.deploy-production.result == 'success' || needs.post-deploy-monitoring.result == 'failure')

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”™ Iniciar rollback
      run: |
        echo "ðŸ”™ Iniciando rollback automÃ¡tico..."
        echo "âŒ Deploy falhou, executando rollback"

        # Identificar versÃ£o anterior estÃ¡vel
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E "^release-" | head -2 | tail -1)
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "âŒ Nenhuma versÃ£o anterior encontrada para rollback"
          exit 1
        fi

        echo "ðŸ”„ Fazendo rollback para: $PREVIOUS_TAG"
        git checkout $PREVIOUS_TAG

    - name: ðŸ”§ Configurar projeto Vercel (Rollback)
      run: |
        mkdir -p .vercel
        echo '{"orgId":"${{ secrets.VERCEL_ORG_ID }}","projectId":"${{ secrets.VERCEL_PROJECT_ID }}"}' > .vercel/project.json

    - name: ðŸš€ Deploy versÃ£o anterior
      run: |
        echo "ðŸš€ Deploy versÃ£o anterior..."
        npm ci
        npm run build
        npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    - name: ðŸ“¢ Notificar rollback
      run: |
        echo "ðŸ“¢ Rollback executado com sucesso"
        echo "ðŸ”„ VersÃ£o anterior implantada"
        echo "ðŸ“Š Monitore a aplicaÃ§Ã£o e resolva os problemas antes do prÃ³ximo deploy"

  # ==========================================
  # ðŸ“¢ NOTIFICAÃ‡Ã•ES
  # ==========================================

  notifications:
    name: 'ðŸ“¢ NotificaÃ§Ãµes'
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production, post-deploy-monitoring, rollback-on-failure]
    if: always()

    steps:
    - name: ðŸ“¢ Preparar notificaÃ§Ã£o
      run: |
        echo "ðŸ“¢ Preparando notificaÃ§Ã£o de deploy..."

        # Determinar status geral
        if [[ "${{ needs.rollback-on-failure.result }}" == "success" ]]; then
          STATUS="ðŸ”™ ROLLBACK EXECUTADO"
          COLOR="danger"
        elif [[ "${{ needs.deploy-production.result }}" == "success" && "${{ needs.post-deploy-monitoring.result }}" == "success" ]]; then
          STATUS="âœ… DEPLOY BEM-SUCEDIDO"
          COLOR="success"
        elif [[ "${{ needs.deploy-staging.result }}" == "success" ]]; then
          STATUS="ðŸš€ STAGING DEPLOYED"
          COLOR="warning"
        else
          STATUS="âŒ DEPLOY FALHADO"
          COLOR="danger"
        fi

        echo "STATUS=$STATUS" >> $GITHUB_ENV
        echo "COLOR=$COLOR" >> $GITHUB_ENV

        # Preparar mensagem
        echo "## $STATUS" > notification.md
        echo "" >> notification.md
        echo "**Commit:** ${{ github.sha }}" >> notification.md
        echo "**Branch:** ${{ github.ref }}" >> notification.md
        echo "**Autor:** ${{ github.actor }}" >> notification.md
        echo "" >> notification.md

        if [[ "${{ needs.deploy-production.outputs.url }}" != "" ]]; then
          echo "**URL ProduÃ§Ã£o:** ${{ needs.deploy-production.outputs.url }}" >> notification.md
        fi

        if [[ "${{ needs.deploy-staging.outputs.url }}" != "" ]]; then
          echo "**URL Staging:** ${{ needs.deploy-staging.outputs.url }}" >> notification.md
        fi

        echo "" >> notification.md
        echo "### ðŸ“Š Status dos Jobs" >> notification.md
        echo "- Staging: ${{ needs.deploy-staging.result }}" >> notification.md
        echo "- Production: ${{ needs.deploy-production.result }}" >> notification.md
        echo "- Monitoring: ${{ needs.post-deploy-monitoring.result }}" >> notification.md
        echo "- Rollback: ${{ needs.rollback-on-failure.result }}" >> notification.md

    - name: ðŸ’¬ Slack Notification (se configurado)
      run: |
        # Aqui vocÃª pode adicionar integraÃ§Ã£o com Slack
        echo "ðŸ’¬ NotificaÃ§Ã£o Slack seria enviada aqui"
        cat notification.md

    - name: ðŸ“§ Email Notification (se configurado)
      run: |
        # Aqui vocÃª pode adicionar envio de email
        echo "ðŸ“§ NotificaÃ§Ã£o por email seria enviada aqui"

    - name: ðŸ“± Teams/Webhook Notification
      run: |
        echo "ðŸ“± Enviando notificaÃ§Ã£o via webhook..."
        # Implementar notificaÃ§Ã£o para Microsoft Teams, Discord, etc.
        echo "NotificaÃ§Ã£o enviada com status: $STATUS"