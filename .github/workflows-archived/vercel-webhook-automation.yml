name: Vercel Webhook Automation

on:
  repository_dispatch:
    types: [vercel-deployment]

jobs:
  handle-vercel-webhook:
    name: 'ðŸŽ¯ Processar Evento Vercel'
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: ðŸ“¦ Instalar dependÃªncias
      run: npm ci

    - name: ðŸŽ¯ Processar evento do Vercel
      run: |
        echo "ðŸŽ¯ Processando evento do Vercel..."
        EVENT_TYPE="${{ github.event.client_payload.type }}"
        DEPLOYMENT_STATE="${{ github.event.client_payload.payload.deployment.state || 'unknown' }}"
        DEPLOYMENT_URL="${{ github.event.client_payload.payload.deployment.url || '' }}"
        DEPLOYMENT_NAME="${{ github.event.client_payload.payload.deployment.name || '' }}"

        echo "ðŸ“Š Evento: $EVENT_TYPE"
        echo "ðŸš€ Estado: $DEPLOYMENT_STATE"
        echo "ðŸŒ URL: $DEPLOYMENT_URL"
        echo "ðŸ“¦ Nome: $DEPLOYMENT_NAME"

        # Salvar informaÃ§Ãµes do evento
        echo "EVENT_TYPE=$EVENT_TYPE" >> $GITHUB_ENV
        echo "DEPLOYMENT_STATE=$DEPLOYMENT_STATE" >> $GITHUB_ENV
        echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
        echo "DEPLOYMENT_NAME=$DEPLOYMENT_NAME" >> $GITHUB_ENV

    - name: ðŸš¨ Verificar falha de deployment
      if: env.DEPLOYMENT_STATE == 'error' || env.DEPLOYMENT_STATE == 'failed'
      run: bash .github/scripts/handle-deployment-failure.sh

    - name: âœ… Verificar sucesso de deployment
      if: env.DEPLOYMENT_STATE == 'ready'
      run: |
        echo "âœ… Deployment bem-sucedido!"

        # Executar testes de smoke na produÃ§Ã£o
        echo "ðŸ§ª Executando testes de smoke..."
        if curl -f --max-time 30 $DEPLOYMENT_URL > /dev/null; then
          echo "âœ… AplicaÃ§Ã£o responde corretamente"

          # Criar comentÃ¡rio de sucesso no commit
          gh pr comment ${{ github.event.client_payload.payload.deployment.meta.githubCommitSha || github.sha }} \
            --body |
              âœ… **Deployment bem-sucedido!**

              ðŸŒ **URL:** $DEPLOYMENT_URL
              ðŸ“¦ **Nome:** $DEPLOYMENT_NAME
              â° **Timestamp:** $(date)

              **Status:** ProduÃ§Ã£o ativa e respondendo

        else
          echo "âŒ AplicaÃ§Ã£o nÃ£o responde apÃ³s deploy!"
          exit 1
        fi

    - name: ðŸ”„ Iniciar rollback automÃ¡tico (se configurado)
      if: (env.DEPLOYMENT_STATE == 'error' || env.DEPLOYMENT_STATE == 'failed') && env.AUTO_ROLLBACK == 'true'
      run: |
        echo "ðŸ”„ Iniciando rollback automÃ¡tico..."

        # Identificar versÃ£o anterior estÃ¡vel
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E "^release-" | head -2 | tail -1)

        if [ -z "$PREVIOUS_TAG" ]; then
          echo "âŒ Nenhuma versÃ£o anterior encontrada para rollback automÃ¡tico"
          exit 1
        fi

        echo "ðŸ”„ Fazendo rollback para: $PREVIOUS_TAG"
        git checkout $PREVIOUS_TAG

        # Rebuild e redeploy
        npm ci
        npm run build

        npx vercel --prod --yes
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
        AUTO_ROLLBACK: ${{ secrets.AUTO_ROLLBACK_ENABLED }}

    - name: ðŸ“Š Registrar mÃ©tricas de deployment
      run: |
        echo "ðŸ“Š Registrando mÃ©tricas de deployment..."

        # Aqui vocÃª pode integrar com ferramentas de monitoramento
        # como DataDog, New Relic, etc.

        METRICS_FILE="deployment-metrics.json"
        cat > $METRICS_FILE << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "deployment_name": "$DEPLOYMENT_NAME",
          "deployment_url": "$DEPLOYMENT_URL",
          "state": "$DEPLOYMENT_STATE",
          "event_type": "$EVENT_TYPE",
          "commit_sha": "${{ github.event.client_payload.payload.deployment.meta.githubCommitSha || github.sha }}",
          "commit_message": "${{ github.event.client_payload.payload.deployment.meta.githubCommitMessage || 'Automated deployment' }}"
        }
        EOF

        echo "âœ… MÃ©tricas registradas"

    - name: ðŸ“¤ Upload mÃ©tricas
      uses: actions/upload-artifact@v4
      with:
        name: deployment-metrics-${{ github.run_id }}
        path: deployment-metrics.json

    - name: ðŸ“¢ NotificaÃ§Ãµes finais
      if: always()
      run: bash .github/scripts/handle-deployment-success.sh