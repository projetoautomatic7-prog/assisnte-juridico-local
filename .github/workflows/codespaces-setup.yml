name: ğŸš€ Codespaces Auto-Setup

on:
  # Trigger ao criar um novo Codespace
  codespace:

  # TambÃ©m pode ser executado manualmente
  workflow_dispatch:

jobs:
  setup-codespace:
    name: Configurar Codespaces para Copilot
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'codespace'

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Verificar arquivos de configuraÃ§Ã£o
        run: |
          echo "âœ… Verificando arquivos de configuraÃ§Ã£o..."

          # Verificar se arquivos essenciais existem
          files=(
            ".devcontainer/devcontainer.json"
            ".github/codespaces-settings.json"
            ".github/CODESPACES_SETUP.md"
            ".github/copilot-instructions.md"
            ".vscode/settings.json"
            ".vscode/tasks.json"
            "test-codespaces-config.sh"
          )

          missing=()
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Arquivo faltando: $file"
              missing+=("$file")
            else
              echo "âœ… $file"
            fi
          done

          if [ ${#missing[@]} -ne 0 ]; then
            echo ""
            echo "âš ï¸  Arquivos faltando:"
            printf '%s\n' "${missing[@]}"
            exit 1
          fi

          echo ""
          echo "ğŸ‰ Todos os arquivos de configuraÃ§Ã£o estÃ£o presentes!"

      - name: ğŸ§ª Executar teste de configuraÃ§Ã£o
        run: |
          chmod +x test-codespaces-config.sh
          ./test-codespaces-config.sh

      - name: ğŸ“Š Resumo da configuraÃ§Ã£o
        if: success()
        run: |
          cat << 'EOF'

          ========================================
          ğŸ‰ CODESPACE CONFIGURADO COM SUCESSO!
          ========================================

          âœ… GitHub Copilot pronto com MÃXIMA AUTONOMIA

          O que estÃ¡ ativo:
          - ğŸ¤– EdiÃ§Ã£o automÃ¡tica de arquivos
          - ğŸ’» Terminal com auto-approve
          - ğŸ”§ Coding Agent ativo
          - ğŸ’¾ Auto-save e auto-format
          - ğŸ“ Git smart commit
          - ğŸ§ª 25+ tasks automÃ¡ticas

          ğŸ“š Para mais informaÃ§Ãµes:
             .github/CODESPACES_SETUP.md

          EOF

      - name: âš ï¸ Avisos importantes
        if: success()
        run: |
          cat << 'EOF'

          ========================================
          âš ï¸  LEMBRE-SE
          ========================================

          1. Configure GITHUB_TOKEN nos Codespaces Secrets:
             https://github.com/settings/codespaces

          2. Copilot precisa de permissÃµes:
             - repo (full control)
             - workflow
             - write:packages
             - read:org
             - gist

          3. Teste a configuraÃ§Ã£o:
             ./test-codespaces-config.sh

          EOF

  notify-failure:
    name: Notificar falha na configuraÃ§Ã£o
    runs-on: ubuntu-latest
    needs: setup-codespace
    if: failure()

    steps:
      - name: âš ï¸ ConfiguraÃ§Ã£o falhou
        run: |
          echo "::warning::Falha ao configurar Codespace para Copilot"
          echo "::warning::Consulte: .github/CODESPACES_SETUP.md#troubleshooting"
