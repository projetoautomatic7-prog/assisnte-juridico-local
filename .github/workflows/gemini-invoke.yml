name: Gemini Invoke

on:
  workflow_call:
    inputs:
      prompt:
        description: "Prompt livre enviado pelo comentário"
        required: true
        type: string
      additional_context:
        description: "Contexto adicional opcional vindo do comentário"
        required: false
        default: ""
        type: string
      model:
        description: "Modelo Gemini a ser usado"
        required: false
        default: "gemini-2.5-pro"
        type: string
      debug:
        description: "Ativar debug do Gemini CLI"
        required: false
        default: false
        type: boolean
      cli_version:
        description: "Versão do gemini-cli"
        required: false
        default: "latest"
        type: string

jobs:
  invoke:
    name: Executar Gemini CLI (genérico)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"

      - name: Preparar prompt
        id: prepare-prompt
        run: |
          PROMPT="${{ inputs.prompt }}"
          if [ -n "${{ inputs.additional_context }}" ]; then
            PROMPT="${PROMPT}\n\nContexto adicional fornecido pelo usuário (PT-BR): ${{ inputs.additional_context }}"
          fi
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo -e "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Rodar Gemini CLI (invoke)
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.18
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: ${{ inputs.model }}
          gemini_cli_version: ${{ inputs.cli_version }}
          gemini_debug: ${{ inputs.debug }}
          prompt: ${{ steps.prepare-prompt.outputs.prompt }}

      - name: Publicar resumo
        if: always()
        run: |
          echo "## Resultado do Gemini (invoke)" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "${{ steps.gemini.outputs.summary }}" ]; then
            echo "${{ steps.gemini.outputs.summary }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Nenhum resumo retornado pela CLI." >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ -n "${{ steps.gemini.outputs.error }}" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Erro" >> "$GITHUB_STEP_SUMMARY"
            echo "${{ steps.gemini.outputs.error }}" >> "$GITHUB_STEP_SUMMARY"
          fi
