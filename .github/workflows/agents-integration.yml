name: Agents Integration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "api/agents.ts"
      - "api/cron.ts"
      - "src/hooks/use-autonomous-agents.ts"
      - "tests/integration/**"
      - "lib/api/**"
      - "src/lib/agents/todoist-agent.ts"
      - "src/lib/todoist-integration.ts"
      - "api/todoist-webhook.ts"
  pull_request:
    branches: [main, develop]
    paths:
      - "api/agents.ts"
      - "api/cron.ts"
      - "src/hooks/use-autonomous-agents.ts"
      - "tests/integration/**"
      - "lib/api/**"
      - "src/lib/agents/todoist-agent.ts"
      - "src/lib/todoist-integration.ts"
      - "api/todoist-webhook.ts"
  workflow_dispatch:

concurrency:
  group: agents-integration-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration-tests:
    name: Agent Flow Integration
    runs-on: ubuntu-latest
    env:
      DSPY_API_TOKEN: ${{ secrets.DSPY_API_TOKEN }}
      DSPY_PORT: 8765
    timeout-minutes: 25
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-agents-integration-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-agents-integration-
            ${{ runner.os }}-

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install FastAPI & UVicorn (DSPy bridge deps)
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: "1"

      - name: Start DSPy bridge (FastAPI) in background
        env:
          DSPY_API_TOKEN: ${{ secrets.DSPY_API_TOKEN }}
        run: |
          export DSPY_API_TOKEN=${DSPY_API_TOKEN:-test-token}
          export DSPY_PORT=8765
          python3 scripts/dspy_bridge.py &
          # Allow a slightly longer startup time to ensure UVicorn is up and listening
          sleep 3

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Install dependencies
        run: npm ci

      - name: Run Agent Integration Tests
        run: |
          echo "Running integration tests for Agent Flow..."

          # Helpful diagnostics
          echo "CI runner: $(uname -a)"
          echo "Workspace files in tests/integration:"
          ls -la tests/integration || true
          git ls-files tests/integration || true

          # Robust git-backed discovery (handles nested dirs, avoids shell glob issues in CI)
          shopt -s nullglob globstar
          mapfile -t files < <(git ls-files tests/integration | grep '\.test\.ts$' | grep -v '\.backup$' || true)

          if [ "${#files[@]}" -gt 0 ]; then
            echo "Found integration tests: ${files[*]}"
            npx vitest run "${files[@]}" --reporter=verbose
          else
            echo "⚠️ No integration tests found in tests/integration, skipping"
            exit 0
          fi
        env:
          CI: true

      - name: Run Todoist Agent Tests
        run: |
          echo "Running Todoist Agent tests..."
          # Lista de arquivos de teste existentes
          TEST_FILES=""

          # Verificar cada arquivo de teste antes de adicionar
          if [ -f "src/lib/agents/todoist-agent.test.ts" ]; then
            TEST_FILES="$TEST_FILES src/lib/agents/todoist-agent.test.ts"
          fi

          if [ -f "src/lib/todoist-integration.test.ts" ]; then
            TEST_FILES="$TEST_FILES src/lib/todoist-integration.test.ts"
          fi

          if [ -f "api/todoist-webhook.test.ts" ]; then
            TEST_FILES="$TEST_FILES api/todoist-webhook.test.ts"
          fi

          if [ -n "$TEST_FILES" ]; then
            echo "Running tests:$TEST_FILES"
            npx vitest run $TEST_FILES --reporter=verbose
          else
            echo "⚠️ No Todoist test files found, skipping"
          fi
        env:
          CI: true
