name: ğŸ“… Auto Scan Issues - Scheduled

on:
  schedule:
    # A cada 6 horas (00:00, 06:00, 12:00, 18:00 UTC)
    # UTC -3 (BRT): 21:00, 03:00, 09:00, 15:00
    - cron: "0 */6 * * *"

    # Segunda verificaÃ§Ã£o diÃ¡ria (todo dia Ã s 09:00 UTC = 06:00 BRT)
    - cron: "0 9 * * *"

  workflow_dispatch: # Permite execuÃ§Ã£o manual
    inputs:
      scan_all:
        description: "Escanear todos os arquivos (true) ou apenas alterados (false)"
        required: false
        default: "false"

permissions:
  issues: write
  contents: read

jobs:
  scheduled-scan:
    name: ğŸ” VerificaÃ§Ã£o PeriÃ³dica de TODOs
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout completo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # HistÃ³rico completo para comparaÃ§Ã£o

      - name: ğŸ” Scan para TODO/FIXME/etc
        id: scan
        uses: alstr/todo-to-issue-action@v4
        with:
          # Triggers: 72 palavras-chave configuradas
          TODO_PATTERN: "(TODO|FIXME|ISSUE|HACK|PENDENTE|REVISAR|CORRIGIR|VERIFICAR|ATENÃ‡ÃƒO|URGENTE|BUG|JURIDICO|PRAZO|INTIMACAO|VALIDAR|COMPLIANCE|LGPD|SEGURANCA|REFACTOR|OPTIMIZE|DEPRECATED|BREAKING|PERFORMANCE|ACCESSIBILITY|A11Y|SECURITY|TEST|DOC|DOCS|CRITICAL|WARNING|NOTE|IDEA|ENHANCEMENT|FEATURE|QUESTION|REVIEW|DEBT|CLEANUP|ATENCAO)"

          # Template em portuguÃªs para issues criadas
          ISSUE_TEMPLATE: |
            **ğŸ¤– Detectado automaticamente no cÃ³digo (Scan PeriÃ³dico)**

            **ğŸ“ Arquivo:** `{{ FILE_PATH }}`
            **ğŸ“ Linha:** {{ LINE_NUMBER }}
            **ğŸ·ï¸ Tipo:** `{{ TODO_TYPE }}`
            **ğŸ“ DescriÃ§Ã£o:** {{ COMMENT }}

            **ğŸ”— Links Ãºteis:**
            - [ğŸ“„ Ver arquivo]({{ PERMALINK }})
            - [ğŸ” Ver mudanÃ§as]({{ DIFF_URL }})

            **â° Detectado em:** {{ DATE }}

            ---
            _Issue criada automaticamente pelo sistema de scan periÃ³dico (a cada 6 horas)_

          # ConfiguraÃ§Ãµes de comportamento
          AUTO_ASSIGN: true # Atribuir ao autor do TODO
          CLOSE_ISSUES: true # Fechar quando TODO for removido
          UPDATE_EXISTING: true # Atualizar issues existentes ao invÃ©s de duplicar
          LABEL: "auto-created,needs-triage,scheduled-scan"
          MILESTONE: "Backlog"

          # Token do GitHub
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š RelatÃ³rio de execuÃ§Ã£o
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“… SCAN PERIÃ“DICO EXECUTADO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â° Data/Hora: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ• BRT: $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” Status: ${{ job.status }}"
          echo "ğŸ“‚ Branch: ${{ github.ref_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Contar TODOs no cÃ³digo
          echo "ğŸ“Š EstatÃ­sticas de TODOs:"
          TOTAL_TODOS=$(grep -r "TODO\|FIXME\|CRITICAL\|LGPD\|JURIDICO" . \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=.git \
            2>/dev/null | wc -l || echo "0")
          echo "   Total de TODOs encontrados: $TOTAL_TODOS"

          # Issues abertas
          echo ""
          echo "ğŸ“‹ PrÃ³xima execuÃ§Ã£o:"
          echo "   Em 6 horas ($(TZ='America/Sao_Paulo' date -d '+6 hours' '+%Y-%m-%d %H:%M BRT'))"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ”” Notificar em caso de falha
        if: failure()
        run: |
          echo "âš ï¸ ATENÃ‡ÃƒO: Scan periÃ³dico falhou!"
          echo "Verifique os logs acima para detalhes"
          echo "Run ID: ${{ github.run_id }}"
          echo "URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
