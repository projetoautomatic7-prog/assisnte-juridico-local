name: OtimizaÃ§Ã£o de Performance e Bundle Analysis

on:
  # Removido: push trigger - muito pesado para cada commit
  # Rodar apenas em PRs para main e semanalmente
  pull_request:
    branches: [main]
  schedule:
    # Executar semanalmente nas quartas Ã s 4h UTC
    - cron: "0 4 * * 3"
  workflow_dispatch:
    inputs:
      analysis_type:
        description: "Tipo de anÃ¡lise"
        required: false
        default: "full"
        type: choice
        options:
          - full
          - bundle-only
          - performance-only
          - optimization-only
      baseline_comparison:
        description: "Comparar com baseline"
        required: false
        default: true
        type: boolean

concurrency:
  group: performance-optimization-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================
  # ðŸ“¦ ANÃLISE DE BUNDLE
  # ==========================================

  bundle-analysis:
    name: "ðŸ“¦ AnÃ¡lise de Bundle"
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.analysis_type == 'full' || github.event.inputs.analysis_type == 'bundle-only'
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-perf-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-perf-

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ“Š Executar Bundle Analyzer
        run: |
          echo "ðŸ“Š Executando anÃ¡lise de bundle..."

          # Build com anÃ¡lise de bundle (Vite gera em dist/assets/)
          npm run build

          echo "âœ… Build concluÃ­do para anÃ¡lise"

      - name: ðŸ“ Analisar Tamanho do Bundle
        run: |
          echo "ðŸ“ Analisando tamanho do bundle..."

          # Analisar arquivos do build
          echo "## ðŸ“Š Bundle Size Report" > bundle-size-report.md
          echo "" >> bundle-size-report.md
          echo "**Tamanho total do build:**" >> bundle-size-report.md
          du -sh dist/ >> bundle-size-report.md
          echo "" >> bundle-size-report.md

          echo "### ðŸ“¦ Top 10 maiores arquivos:" >> bundle-size-report.md
          find dist/ -type f -exec ls -lh {} \; | sort -k5 -hr | head -10 >> bundle-size-report.md
          echo "" >> bundle-size-report.md

          # Analisar chunks JavaScript (Vite usa dist/assets/)
          if [ -d "dist/assets" ]; then
            echo "### ðŸ§© Chunks JavaScript:" >> bundle-size-report.md
            ls -lh dist/assets/*.js 2>/dev/null >> bundle-size-report.md || echo "Nenhum arquivo JS encontrado" >> bundle-size-report.md
            echo "" >> bundle-size-report.md

            echo "### ðŸŽ¨ Arquivos CSS:" >> bundle-size-report.md
            ls -lh dist/assets/*.css 2>/dev/null >> bundle-size-report.md || echo "Nenhum arquivo CSS encontrado" >> bundle-size-report.md
          fi

          # Calcular tamanhos
          TOTAL_SIZE=$(du -sb dist/ | cut -f1)
          JS_SIZE=$(find dist/assets/ -name "*.js" -exec stat -c%s {} \; 2>/dev/null | awk '{sum += $1} END {print sum+0}')
          CSS_SIZE=$(find dist/assets/ -name "*.css" -exec stat -c%s {} \; 2>/dev/null | awk '{sum += $1} END {print sum+0}')

          echo "" >> bundle-size-report.md
          echo "### ðŸ“Š MÃ©tricas de tamanho:" >> bundle-size-report.md
          echo "- **Total:** $(numfmt --to=iec-i --suffix=B $TOTAL_SIZE 2>/dev/null || echo "$TOTAL_SIZE bytes")" >> bundle-size-report.md
          echo "- **JavaScript:** $(numfmt --to=iec-i --suffix=B $JS_SIZE 2>/dev/null || echo "$JS_SIZE bytes")" >> bundle-size-report.md
          echo "- **CSS:** $(numfmt --to=iec-i --suffix=B $CSS_SIZE 2>/dev/null || echo "$CSS_SIZE bytes")" >> bundle-size-report.md

          # Adicionar ao step summary
          cat bundle-size-report.md >> $GITHUB_STEP_SUMMARY

          # Salvar mÃ©tricas para comparaÃ§Ã£o
          {
            echo "total_size: $TOTAL_SIZE"
            echo "js_size: $JS_SIZE"
            echo "css_size: $CSS_SIZE"
            echo "timestamp: $(date +%s)"
            echo "commit: ${{ github.sha }}"
          } > bundle-metrics.json

      - name: ðŸ“ˆ Comparar com Baseline
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.baseline_comparison == true
        run: |
          echo "ðŸ“ˆ Comparando com baseline..."

          # Baixar mÃ©tricas da branch main
          if [[ "$GITHUB_REF" != "refs/heads/main" ]]; then
            echo "ðŸ“¥ Baixando mÃ©tricas da main..."
            gh run download --repo $GITHUB_REPOSITORY --name bundle-metrics -D baseline-metrics/ || echo "Baseline nÃ£o encontrada"

            if [[ -f baseline-metrics/bundle-metrics.json ]]; then
              BASELINE_TOTAL=$(jq '.total_size' baseline-metrics/bundle-metrics.json)
              BASELINE_JS=$(jq '.js_size' baseline-metrics/bundle-metrics.json)
              BASELINE_CSS=$(jq '.css_size' baseline-metrics/bundle-metrics.json)

              CURRENT_TOTAL=$TOTAL_SIZE
              CURRENT_JS=$JS_SIZE
              CURRENT_CSS=$CSS_SIZE

              # Calcular diferenÃ§as
              TOTAL_DIFF=$((CURRENT_TOTAL - BASELINE_TOTAL))
              JS_DIFF=$((CURRENT_JS - BASELINE_JS))
              CSS_DIFF=$((CURRENT_CSS - BASELINE_CSS))

              echo "ðŸ“Š ComparaÃ§Ã£o com baseline:" >> bundle-size-report.md
              echo "" >> bundle-size-report.md
              echo "| MÃ©trica | Baseline | Atual | DiferenÃ§a |" >> bundle-size-report.md
              echo "|---------|----------|-------|-----------|" >> bundle-size-report.md
              echo "| Total | $(numfmt --to=iec-i --suffix=B $BASELINE_TOTAL) | $(numfmt --to=iec-i --suffix=B $CURRENT_TOTAL) | $(numfmt --to=iec-i --suffix=B $TOTAL_DIFF) |" >> bundle-size-report.md
              echo "| JS | $(numfmt --to=iec-i --suffix=B $BASELINE_JS) | $(numfmt --to=iec-i --suffix=B $CURRENT_JS) | $(numfmt --to=iec-i --suffix=B $JS_DIFF) |" >> bundle-size-report.md
              echo "| CSS | $(numfmt --to=iec-i --suffix=B $BASELINE_CSS) | $(numfmt --to=iec-i --suffix=B $CURRENT_CSS) | $(numfmt --to=iec-i --suffix=B $CSS_DIFF) |" >> bundle-size-report.md

              # Alertar se aumento significativo
              if [[ $TOTAL_DIFF -gt 100000 ]]; then  # 100KB
                echo "âš ï¸  ALERTA: Aumento significativo no tamanho do bundle (+$(numfmt --to=iec-i --suffix=B $TOTAL_DIFF))"
              fi
            fi
          fi

      - name: ðŸ“¤ Upload RelatÃ³rios de Bundle
        uses: actions/upload-artifact@v4.4.3
        with:
          name: bundle-reports
          path: |
            bundle-report.html
            bundle-size-report.md
            bundle-metrics.json

  # ==========================================
  # âš¡ ANÃLISE DE PERFORMANCE
  # ==========================================

  performance-analysis:
    name: "âš¡ AnÃ¡lise de Performance"
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.analysis_type == 'full' || github.event.inputs.analysis_type == 'performance-only'
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ—ï¸  Build de ProduÃ§Ã£o Otimizado
        run: |
          echo "ðŸ—ï¸  Executando build de produÃ§Ã£o otimizado..."

          # Build com otimizaÃ§Ãµes
          NODE_ENV=production npm run build

      - name: ðŸ–¥ï¸  Lighthouse Performance Test
        run: |
          echo "ðŸ–¥ï¸  Executando Lighthouse performance test..."

          # Instalar servisor local
          npm install --save-dev serve

          # Servir aplicaÃ§Ã£o localmente
          npx serve -s dist -p 3000 &
          SERVER_PID=$!

          # Aguardar servidor iniciar
          sleep 10

          # Executar Lighthouse
          npx lighthouse http://localhost:3000 \
            --output=json \
            --output-path=lighthouse-performance.json \
            --only-categories=performance \
            --chrome-flags="--headless --disable-gpu --no-sandbox --disable-dev-shm-usage"

          # Matar servidor
          kill $SERVER_PID

          # Extrair mÃ©tricas
          PERFORMANCE_SCORE=$(jq '.categories.performance.score * 100' lighthouse-performance.json)
          FCP=$(jq '.audits."first-contentful-paint".numericValue' lighthouse-performance.json)
          LCP=$(jq '.audits."largest-contentful-paint".numericValue' lighthouse-performance.json)
          TBT=$(jq '.audits."total-blocking-time".numericValue' lighthouse-performance.json)
          CLS=$(jq '.audits."cumulative-layout-shift".numericValue' lighthouse-performance.json)
          SPEED_INDEX=$(jq '.audits."speed-index".numericValue' lighthouse-performance.json)

          echo "ðŸ“Š Performance Score: $PERFORMANCE_SCORE"
          echo "ðŸ–¼ï¸  First Contentful Paint: ${FCP}ms"
          echo "ðŸ–¼ï¸  Largest Contentful Paint: ${LCP}ms"
          echo "â±ï¸  Total Blocking Time: ${TBT}ms"
          echo "ðŸ“ Cumulative Layout Shift: $CLS"
          echo "âš¡ Speed Index: ${SPEED_INDEX}ms"

          # Salvar mÃ©tricas
          {
            echo "performance_score: $PERFORMANCE_SCORE"
            echo "fcp: $FCP"
            echo "lcp: $LCP"
            echo "tbt: $TBT"
            echo "cls: $CLS"
            echo "speed_index: $SPEED_INDEX"
            echo "timestamp: $(date +%s)"
          } > performance-metrics.json

      - name: ðŸ“Š Web Vitals Analysis
        run: |
          echo "ðŸ“Š Analisando Web Vitals..."

          # Verificar se as mÃ©tricas atendem aos thresholds
          LCP_THRESHOLD=2500  # 2.5s
          FID_THRESHOLD=100   # 100ms
          CLS_THRESHOLD=0.1   # 0.1

          if (( $(echo "$LCP > $LCP_THRESHOLD" | bc -l) )); then
            echo "âš ï¸  ALERTA: LCP acima do threshold (${LCP}ms > ${LCP_THRESHOLD}ms)"
          fi

          if (( $(echo "$TBT > $FID_THRESHOLD" | bc -l) )); then
            echo "âš ï¸  ALERTA: TBT acima do threshold (${TBT}ms > ${FID_THRESHOLD}ms)"
          fi

          if (( $(echo "$CLS > $CLS_THRESHOLD" | bc -l) )); then
            echo "âš ï¸  ALERTA: CLS acima do threshold ($CLS > $CLS_THRESHOLD)"
          fi

      - name: ðŸ“ˆ Comparar Performance com Baseline
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.baseline_comparison == true
        run: |
          echo "ðŸ“ˆ Comparando performance com baseline..."

          # Baixar mÃ©tricas de performance da main
          if [[ "$GITHUB_REF" != "refs/heads/main" ]]; then
            gh run download --repo $GITHUB_REPOSITORY --name performance-metrics -D baseline-performance/ || echo "Baseline nÃ£o encontrada"

            if [[ -f baseline-performance/performance-metrics.json ]]; then
              BASELINE_SCORE=$(jq '.performance_score' baseline-performance/performance-metrics.json)
              BASELINE_LCP=$(jq '.lcp' baseline-performance/performance-metrics.json)

              SCORE_DIFF=$(echo "scale=2; $PERFORMANCE_SCORE - $BASELINE_SCORE" | bc)
              LCP_DIFF=$(echo "scale=2; $LCP - $BASELINE_LCP" | bc)

              echo "ðŸ“Š ComparaÃ§Ã£o de Performance:" >> performance-report.md
              echo "- **Score:** $BASELINE_SCORE â†’ $PERFORMANCE_SCORE (dif: $SCORE_DIFF)" >> performance-report.md
              echo "- **LCP:** ${BASELINE_LCP}ms â†’ ${LCP}ms (dif: ${LCP_DIFF}ms)" >> performance-report.md
            fi
          fi

      - name: ðŸ“¤ Upload RelatÃ³rios de Performance
        uses: actions/upload-artifact@v4.4.3
        with:
          name: performance-reports
          path: |
            lighthouse-performance.json
            performance-metrics.json
            performance-report.md

  # ==========================================
  # ðŸ”§ OTIMIZAÃ‡Ã•ES DE BUILD
  # ==========================================

  build-optimizations:
    name: "ðŸ”§ OtimizaÃ§Ãµes de Build"
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.analysis_type == 'full' || github.event.inputs.analysis_type == 'optimization-only'

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ—ï¸ Build (needed for analysis)
        run: |
          echo "ðŸ—ï¸ Executando build de produÃ§Ã£o (para anÃ¡lise de build / chunks)..."
          NODE_ENV=production npm run build

      - name: ðŸ” Analisar Lazy Loading
        run: |
          echo "ðŸ” Analisando implementaÃ§Ã£o de lazy loading..."
          LAZY_COMPONENTS=$(grep -r "React.lazy\|lazy(" src/components/ 2>/dev/null || true | wc -l)
          TOTAL_COMPONENTS=$(find src/components/ -name "*.tsx" -o -name "*.ts" 2>/dev/null | wc -l)
          echo "ðŸ“¦ Componentes com lazy loading: $LAZY_COMPONENTS / $TOTAL_COMPONENTS"
          if [[ $TOTAL_COMPONENTS -eq 0 ]]; then
            echo "âš ï¸  Aviso: nenhum componente encontrado em src/components/ â€” verifique a estrutura do projeto"
          elif [[ $LAZY_COMPONENTS -lt $(($TOTAL_COMPONENTS / 2)) ]]; then
            echo "âš ï¸  ALERTA: Poucos componentes usam lazy loading"
          fi

      - name: ðŸ“Š Analisar Code Splitting
        run: |
          echo "ðŸ“Š Analisando code splitting..."
          # Prefer legacy create-react-app path, fall back to Vite output
          if [[ -d "dist/static/js" ]]; then
            CHUNK_DIR="dist/static/js"
          elif [[ -d "dist/assets" ]]; then
            CHUNK_DIR="dist/assets"
          else
            CHUNK_DIR=""
          fi
          if [[ -n "$CHUNK_DIR" ]]; then
            CHUNK_COUNT=$(ls -1 "$CHUNK_DIR" 2>/dev/null | wc -l)
          else
            CHUNK_COUNT=0
          fi
          echo "ðŸ§© NÃºmero de chunks JavaScript: $CHUNK_COUNT"
          if [[ $CHUNK_COUNT -lt 3 ]]; then
            echo "âš ï¸  ALERTA: Poucos chunks - considere implementar mais code splitting"
          fi

          # Analisar tamanho dos chunks (if available)
          echo "ðŸ“ Tamanhos dos chunks:" > chunk-analysis.md
          if [[ -n "$CHUNK_DIR" ]]; then
            ls -lh "$CHUNK_DIR" >> chunk-analysis.md 2>/dev/null || true
          else
            echo "Nenhum diretÃ³rio de chunks encontrado (expected dist/static/js or dist/assets)" >> chunk-analysis.md
          fi

      - name: ðŸ—œï¸  Verificar CompressÃ£o
        run: |
          echo "ðŸ—œï¸  Verificando compressÃ£o de assets..."
          # find may return nothing; guard so xargs doesn't fail
          ASSET_FILES=$(find dist/ -type f \( -name "*.js" -o -name "*.css" \) 2>/dev/null || true)
          if [[ -z "$ASSET_FILES" ]]; then
            echo "Nenhum asset .js/.css encontrado em dist/ para verificar compressÃ£o"
            GZIP_FILES=0
            TOTAL_ASSETS=0
          else
            # Limit to first 100 to avoid long output
            TOTAL_ASSETS=$(echo "$ASSET_FILES" | wc -l)
            GZIP_FILES=$(echo "$ASSET_FILES" | head -100 | xargs file 2>/dev/null | grep -c "gzip" || true)
          fi
          echo "ðŸ—œï¸  Arquivos comprimidos: $GZIP_FILES / $TOTAL_ASSETS"
          if [[ $TOTAL_ASSETS -eq 0 ]]; then
            echo "âš ï¸  Aviso: nenhum asset encontrado para checar compressÃ£o"
          elif [[ $GZIP_FILES -eq 0 ]]; then
            echo "âš ï¸  ALERTA: Assets nÃ£o estÃ£o comprimidos"
          fi

      - name: ðŸŒ Verificar CDN e Cache Headers
        run: |
          echo "ðŸŒ Verificando configuraÃ§Ã£o de CDN e cache..."

          # Verificar se hÃ¡ configuraÃ§Ã£o de CDN no build
          if [[ -f dist/_headers ]]; then
            echo "âœ… Headers de cache configurados"
            cat dist/_headers
          else
            echo "âš ï¸  Headers de cache nÃ£o configurados"
          fi

      - name: ðŸ“‹ Gerar RelatÃ³rio de OtimizaÃ§Ãµes
        run: |
          echo "ðŸ“‹ Gerando relatÃ³rio de otimizaÃ§Ãµes..."

          {
            echo "# ðŸ”§ RelatÃ³rio de OtimizaÃ§Ãµes de Build"
            echo ""
            echo "**Data:** $(date)"
            echo "**Commit:** ${{ github.sha }}"
            echo ""
            echo "## ðŸ“¦ Code Splitting"
            echo "- Chunks JavaScript: $CHUNK_COUNT"
            echo "- Componentes lazy: $LAZY_COMPONENTS / $TOTAL_COMPONENTS"
            echo ""
            echo "## ðŸ—œï¸  CompressÃ£o"
            echo "- Assets comprimidos: $GZIP_FILES / $TOTAL_ASSETS"
            echo ""
            echo "## âš¡ Performance"
            echo "- Performance Score: $PERFORMANCE_SCORE"
            echo "- Bundle Size: $(numfmt --to=iec-i --suffix=B $TOTAL_SIZE)"
            echo ""
          } > optimization-report.md

      - name: ðŸ“¤ Upload RelatÃ³rios de OtimizaÃ§Ã£o
        uses: actions/upload-artifact@v4.4.3
        with:
          name: optimization-reports
          path: |
            chunk-analysis.md
            optimization-report.md

  # ==========================================
  # ðŸ“Š DASHBOARD DE PERFORMANCE
  # ==========================================

  performance-dashboard:
    name: "ðŸ“Š Dashboard de Performance"
    runs-on: ubuntu-latest
    needs: [bundle-analysis, performance-analysis, build-optimizations]
    if: always()
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: ðŸ“Š Gerar Dashboard Consolidado
        run: |
          echo "ðŸ“Š Gerando dashboard de performance consolidado..."

          # Criar dashboard markdown
          {
            echo "# ðŸ“Š Dashboard de Performance e Bundle"
            echo ""
            echo "**Commit:** ${{ github.sha }}"
            echo "**Branch:** ${{ github.ref }}"
            echo "**Data:** $(date)"
            echo ""
            echo "## ðŸ“¦ Status das AnÃ¡lises"
            echo ""
            echo "| AnÃ¡lise | Status |"
            echo "|---------|--------|"
            echo "| Bundle Analysis | ${{ needs.bundle-analysis.result }} |"
            echo "| Performance Analysis | ${{ needs.performance-analysis.result }} |"
            echo "| Build Optimizations | ${{ needs.build-optimizations.result }} |"
            echo ""
          } > performance-dashboard.md

          # Determinar status geral
          if [[ "${{ needs.bundle-analysis.result }}" == "success" && \
                "${{ needs.performance-analysis.result }}" == "success" && \
                "${{ needs.build-optimizations.result }}" == "success" ]]; then
            echo "## âœ… STATUS GERAL: PERFORMANCE OTIMIZADA" >> performance-dashboard.md
            echo "STATUS=success" >> $GITHUB_ENV
          else
            echo "## âš ï¸  STATUS GERAL: OPORTUNIDADES DE OTIMIZAÃ‡ÃƒO" >> performance-dashboard.md
            echo "STATUS=warning" >> $GITHUB_ENV
          fi

          # Adicionar mÃ©tricas de performance se disponÃ­veis
          if [[ -f performance-metrics.json ]]; then
            SCORE=$(jq -r '.performance_score' performance-metrics.json 2>/dev/null || echo "N/A")
            LCP=$(jq -r '.lcp' performance-metrics.json 2>/dev/null || echo "N/A")
            echo "" >> performance-dashboard.md
            echo "## âš¡ MÃ©tricas de Performance" >> performance-dashboard.md
            echo "- **Performance Score:** $SCORE" >> performance-dashboard.md
            echo "- **Largest Contentful Paint:** ${LCP}ms" >> performance-dashboard.md
          fi

          # Adicionar mÃ©tricas de bundle se disponÃ­veis
          if [[ -f bundle-metrics.json ]]; then
            TOTAL_SIZE=$(jq -r '.total_size' bundle-metrics.json 2>/dev/null || echo "N/A")
            if [[ "$TOTAL_SIZE" != "N/A" ]]; then
              echo "- **Tamanho do Bundle:** $(numfmt --to=iec-i --suffix=B $TOTAL_SIZE)" >> performance-dashboard.md
            fi
          fi

          echo "" >> performance-dashboard.md
          echo "## ðŸ“‹ RecomendaÃ§Ãµes de OtimizaÃ§Ã£o" >> performance-dashboard.md
          echo "" >> performance-dashboard.md

          # Adicionar recomendaÃ§Ãµes baseadas nos resultados
          if [[ "${{ needs.bundle-analysis.result }}" != "success" ]]; then
            echo "- ðŸ“¦ **Otimizar bundle** - Implementar code splitting e lazy loading" >> performance-dashboard.md
          fi

          if [[ "${{ needs.performance-analysis.result }}" != "success" ]]; then
            echo "- âš¡ **Melhorar performance** - Otimizar imagens, reduzir blocking time" >> performance-dashboard.md
          fi

          if [[ "${{ needs.build-optimizations.result }}" != "success" ]]; then
            echo "- ðŸ”§ **Otimizar build** - Configurar compressÃ£o e cache headers" >> performance-dashboard.md
          fi

          echo "" >> performance-dashboard.md
          echo "*Dashboard gerado automaticamente*" >> performance-dashboard.md

      - name: ðŸ“¥ Checkout cÃ³digo (para permitir gh operar no contexto do repo)
        uses: actions/checkout@v4

      - name: ðŸ’¬ Comentar Performance no PR
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ’¬ Comentando performance no PR..."

          # Criar comentÃ¡rio
          COMMENT="## âš¡ AnÃ¡lise de Performance

          **Status:** $STATUS

          ### ðŸ“Š MÃ©tricas Principais
          - **Performance Score:** $SCORE
          - **Bundle Size:** $(numfmt --to=iec-i --suffix=B $TOTAL_SIZE)
          - **LCP:** ${LCP}ms"

          # Adicionar aviso se houver oportunidades de otimizaÃ§Ã£o
          if [[ "$STATUS" != "success" ]]; then
            COMMENT="$COMMENT

          **âš ï¸  Oportunidades de otimizaÃ§Ã£o identificadas. Verifique os artefatos para detalhes.**"
          fi

          COMMENT="$COMMENT

          Verifique os relatÃ³rios completos nos artefatos do workflow."

          # Comentar no PR (checkout para garantir .git e contexto disponÃ­vel)
          echo "ðŸ“¥ Fazendo checkout do cÃ³digo para permitir 'gh' operar no contexto" >&2
          git --version || true
          # Usamos actions/checkout local step para obter .git â€” se o job nÃ£o tiver efetuado checkout, usamos gh --repo fallback
          if [ -d .git ]; then
            PR_NUMBER=${{ github.event.number }}
            echo "$COMMENT" | gh pr comment $PR_NUMBER --body-file -
          else
            # Fallback: passar --repo para gh para nÃ£o depender de .git
            PR_NUMBER=${{ github.event.number }}
            echo "$COMMENT" | gh pr comment $PR_NUMBER --repo "$GITHUB_REPOSITORY" --body-file -
          fi

      - name: ðŸ“¤ Upload Dashboard de Performance
        uses: actions/upload-artifact@v4.4.3
        with:
          name: performance-dashboard
          path: performance-dashboard.md

  # ==========================================
  # ðŸ“¢ NOTIFICAÃ‡Ã•ES DE PERFORMANCE
  # ==========================================

  performance-notifications:
    name: "ðŸ“¢ NotificaÃ§Ãµes de Performance"
    runs-on: ubuntu-latest
    needs: performance-dashboard
    if: always()

    steps:
      - name: ðŸ“¢ Preparar NotificaÃ§Ãµes de Performance
        run: |
          echo "ðŸ“¢ Preparando notificaÃ§Ãµes de performance..."

          # Criar notificaÃ§Ã£o baseada no status
          if [[ "$STATUS" == "success" ]]; then
            TITLE="âœ… Performance Otimizada"
            MESSAGE="AnÃ¡lise de performance concluÃ­da com sucesso. Bundle e performance dentro dos parÃ¢metros."
            PRIORITY="normal"
          else
            TITLE="âš¡ Oportunidades de OtimizaÃ§Ã£o de Performance"
            MESSAGE="Foram identificadas oportunidades de melhoria na performance e tamanho do bundle."
            PRIORITY="normal"
          fi

          # Criar payload de notificaÃ§Ã£o
          {
            echo "title: \"$TITLE\""
            echo "message: \"$MESSAGE\""
            echo "priority: \"$PRIORITY\""
            echo "timestamp: \"$(date -Iseconds)\""
            echo "performance_score: \"$SCORE\""
            echo "bundle_size: \"$TOTAL_SIZE\""
          } > performance-notification.json

      - name: ðŸ’¬ Slack Notification
        run: |
          echo "ðŸ’¬ Enviando notificaÃ§Ã£o para Slack..."
          # Implementar webhook do Slack

      - name: ðŸ“§ Email Notification
        run: |
          echo "ðŸ“§ Enviando notificaÃ§Ã£o por email..."
          # Implementar serviÃ§o de email

      - name: ðŸ“± Teams Notification
        run: |
          echo "ðŸ“± Enviando notificaÃ§Ã£o para Teams..."
          # Implementar webhook do Teams

      - name: ðŸ“¤ Upload NotificaÃ§Ãµes
        uses: actions/upload-artifact@v4.4.3
        with:
          name: performance-notifications
          path: performance-notification.json
