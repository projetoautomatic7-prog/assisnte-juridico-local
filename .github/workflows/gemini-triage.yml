name: Gemini Triage

on:
  workflow_call:
    inputs:
      prompt:
        description: "Prompt construído para triagem de issue"
        required: true
        type: string
      additional_context:
        description: "Contexto adicional opcional vindo do comentário"
        required: false
        default: ""
        type: string
      model:
        description: "Modelo Gemini a ser usado"
        required: false
        default: "gemini-2.5-pro"
        type: string
      debug:
        description: "Ativar debug do Gemini CLI"
        required: false
        default: false
        type: boolean
      cli_version:
        description: "Versão do gemini-cli"
        required: false
        default: "latest"
        type: string

jobs:
  triage:
    name: Executar triagem com Gemini CLI
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"

      - name: Rodar Gemini CLI (triage)
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.18
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: ${{ inputs.model }}
          gemini_cli_version: ${{ inputs.cli_version }}
          gemini_debug: ${{ inputs.debug }}
          prompt: "${{ inputs.prompt }}${{ inputs.additional_context != '' && format('\n\nContexto adicional fornecido pelo usuario (PT-BR): {0}', inputs.additional_context) || '' }}"

      - name: Publicar resumo
        if: always()
        shell: bash
        run: |
          echo "## Resultado da triagem do Gemini" >> "$GITHUB_STEP_SUMMARY"

          SUMMARY="${{ steps.gemini.outputs.summary }}"
          if [ -n "$SUMMARY" ]; then
            echo "$SUMMARY" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Nenhum resumo retornado pela CLI." >> "$GITHUB_STEP_SUMMARY"
          fi

          ERROR="${{ steps.gemini.outputs.error }}"
          if [ -n "$ERROR" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Erro" >> "$GITHUB_STEP_SUMMARY"
            echo "$ERROR" >> "$GITHUB_STEP_SUMMARY"
          fi
