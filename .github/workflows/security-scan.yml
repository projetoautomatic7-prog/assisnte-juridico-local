name: Security Scan

on:
  schedule:
    # Executar diariamente Ã s 3 AM UTC
    - cron: "0 3 * * *"
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "package.json"
      - "package-lock.json"

concurrency:
  group: security-scan-${{ github.ref }}
  cancel-in-progress: false # Don't cancel security scans

jobs:
  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: audit
        run: |
          echo "## ðŸ”’ NPM Security Audit" > audit-report.md
          echo "" >> audit-report.md
          echo "**Date:** $(date -u)" >> audit-report.md
          echo "" >> audit-report.md

          # Executar audit e capturar resultado
          if npm audit --audit-level=moderate --json > audit.json; then
            echo "âœ… No vulnerabilities found" >> audit-report.md
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Vulnerabilities detected" >> audit-report.md
            echo "status=failed" >> $GITHUB_OUTPUT

            # Extrair informaÃ§Ãµes importantes
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit.json)
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit.json)
            LOW=$(jq '.metadata.vulnerabilities.low // 0' audit.json)

            echo "" >> audit-report.md
            echo "### ðŸ“Š Vulnerability Summary" >> audit-report.md
            echo "| Severity | Count |" >> audit-report.md
            echo "|----------|-------|" >> audit-report.md
            echo "| ðŸ”´ Critical | $CRITICAL |" >> audit-report.md
            echo "| ðŸŸ  High | $HIGH |" >> audit-report.md
            echo "| ðŸŸ¡ Moderate | $MODERATE |" >> audit-report.md
            echo "| ðŸ”µ Low | $LOW |" >> audit-report.md
            echo "" >> audit-report.md

            if [ $CRITICAL -gt 0 ] || [ $HIGH -gt 0 ]; then
              echo "action_required=true" >> $GITHUB_OUTPUT
            fi
          fi

          # Adicionar ao step summary
          cat audit-report.md >> $GITHUB_STEP_SUMMARY

      - name: Create issue for critical vulnerabilities
        if: steps.audit.outputs.action_required == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/create-security-issue.cjs');
            await script({ github, context });

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: npm-audit-results
          path: |
            audit.json
            audit-report.md
          retention-days: 30

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for comprehensive scan

      - name: Scan for secrets
        run: |
          echo "## ðŸ” Secret Scanning Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Procurar padrÃµes suspeitos
          echo "### Checking for exposed secrets..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FOUND_CRITICAL=0
          FOUND_WARNINGS=0

          # Verificar arquivos .env que nÃ£o deveriam estar versionados (CRÃTICO)
          if git ls-files | grep -E "^\.env\.(vercel|production|local|staging)$" | grep -q .; then
            echo "âŒ **CRITICAL:** Found .env files tracked in git that should not be committed!" >> $GITHUB_STEP_SUMMARY
            git ls-files | grep -E "^\.env\.(vercel|production|local|staging)$" >> $GITHUB_STEP_SUMMARY || true
            FOUND_CRITICAL=1
          fi

          # Verificar por secrets reais (private keys, tokens com formato especÃ­fico)
          # Procurar por chaves privadas RSA/EC (ignorar docs, arquivos de exemplo e workflows)
          if git grep -l "PRIVATE KEY" 2>/dev/null | grep -v ".example" | grep -v "node_modules" | grep -v "docs/" | grep -v ".yml" | grep -v ".md" | grep -q .; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **CRITICAL:** Private keys found in repository!" >> $GITHUB_STEP_SUMMARY
            git grep -l "PRIVATE KEY" 2>/dev/null | grep -v ".example" | grep -v "node_modules" | grep -v "docs/" | grep -v ".yml" | grep -v ".md" >> $GITHUB_STEP_SUMMARY || true
            FOUND_CRITICAL=1
          fi

          # Procurar por tokens do GitHub reais (ghp_, gho_, ghs_, etc.) - ignorar exemplos com xxx
          if git grep -E "gh[pso]_[a-zA-Z0-9]{36}" 2>/dev/null | grep -v ".example" | grep -v "xxx" | grep -v "YOUR_" | grep -q .; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **CRITICAL:** GitHub tokens found in code!" >> $GITHUB_STEP_SUMMARY
            FOUND_CRITICAL=1
          fi

          # Verificar .gitignore (apenas warning)
          if [ -f ".gitignore" ]; then
            if ! grep -q ".env.vercel" .gitignore 2>/dev/null; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **WARNING:** .env.vercel not in .gitignore" >> $GITHUB_STEP_SUMMARY
              FOUND_WARNINGS=1
            fi
          fi

          # Nota: client_id Ã© pÃºblico por design em OAuth 2.0, nÃ£o Ã© um segredo

          if [ $FOUND_CRITICAL -eq 0 ] && [ $FOUND_WARNINGS -eq 0 ]; then
            echo "âœ… No secrets or sensitive files detected" >> $GITHUB_STEP_SUMMARY
          elif [ $FOUND_CRITICAL -eq 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Some warnings were found, but no critical issues." >> $GITHUB_STEP_SUMMARY
            # NÃ£o falha o build por warnings
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:** Review and remove sensitive information from repository" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        continue-on-error: false

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: |
          echo "## ðŸ“œ License Compliance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Instalar license-checker
          npm install -g license-checker

          # Executar verificaÃ§Ã£o
          license-checker --summary > licenses-summary.txt || true

          echo "### License Summary" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat licenses-summary.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verificar licenÃ§as problemÃ¡ticas
          echo "### Checking for restrictive licenses..." >> $GITHUB_STEP_SUMMARY
          if license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD" --summary; then
            echo "âœ… All dependencies use permissive licenses" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some dependencies may have restrictive licenses" >> $GITHUB_STEP_SUMMARY
            echo "Review the summary above and verify compatibility" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4.4.3
        with:
          name: license-compliance-report
          path: licenses-summary.txt
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [npm-audit, secret-scanning, license-compliance]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Generate security summary
        run: |
          echo "# ðŸ›¡ï¸ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“Š Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Audit | ${{ needs.npm-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scanning.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.license-compliance.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.npm-audit.result }}" == "success" ]] && \
             [[ "${{ needs.secret-scanning.result }}" == "success" ]]; then
            echo "## âœ… Overall Status: SECURE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All security scans passed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Overall Status: ACTION REQUIRED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some security issues were detected. Please review the scan results above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
