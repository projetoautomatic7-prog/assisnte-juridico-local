name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # Aguarda CI passar antes de fazer merge
  workflow_run:
    workflows: ["CI", "Playwright E2E Tests"]
    types: [completed]
    branches: [main, develop]

permissions:
  contents: write
  pull-requests: write
  checks: read
  issues: write

concurrency:
  group: dependabot-auto-merge-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  # Primeiro job: Aprovar PR automaticamente
  auto-approve:
    name: Auto-Approve Dependabot PR
    runs-on: ubuntu-latest
    if: |
      github.actor == 'dependabot[bot]' &&
      github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-approve for minor and patch updates
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
          steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Segundo job: Fazer merge SOMENTE ap√≥s CI passar
  dependabot-auto-merge:
    name: Dependabot Auto-Merge (After CI)
    runs-on: ubuntu-latest
    # Executa apenas quando CI termina com sucesso
    if: |
      github.actor == 'dependabot[bot]' &&
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.pull_requests[0] != null
    needs: []
    steps:
      - name: Get PR information
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.workflow_run.pull_requests[0];
            return pr;

      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for all checks to pass
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.workflow_run.pull_requests[0].number;
            const maxAttempts = 30;
            const delayMs = 10000; // 10 segundos

            for (let i = 0; i < maxAttempts; i++) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });

              const allPassed = checks.check_runs.every(
                check => check.status === 'completed' && check.conclusion === 'success'
              );

              if (allPassed) {
                console.log('‚úÖ Todos os checks passaram!');
                return;
              }

              console.log(`‚è≥ Aguardando checks... Tentativa ${i + 1}/${maxAttempts}`);
              await new Promise(resolve => setTimeout(resolve, delayMs));
            }

            throw new Error('‚ùå Timeout aguardando checks passarem');

      - name: Auto-merge for minor and patch updates
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
          steps.metadata.outputs.update-type == 'version-update:semver-patch'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.workflow_run.pull_requests[0].number;

            // Ativar auto-merge
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'squash'
            });

            console.log(`‚úÖ PR #${prNumber} merged successfully!`);

      - name: Comment on major updates
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-major' &&
          github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_GH_TOKEN != '' && secrets.BOT_GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            try {
              const pr = context.payload.pull_request || {};
              const repoFull = `${context.repo.owner}/${context.repo.repo}`;
              const isFork = pr.head && pr.head.repo && pr.head.repo.full_name && pr.head.repo.full_name !== repoFull;
              const issue_number = context.issue && context.issue.number;
              if (!issue_number) {
                core.info('No issue number in context - skipping comment');
              } else if (isFork && !process.env.BOT_GH_TOKEN) {
                core.info('PR is from a fork; skipping comment because BOT_GH_TOKEN not present');
              } else {
                await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: `‚ö†Ô∏è **Major version update detected`

              This PR updates **${{ steps.metadata.outputs.dependency-names }}** to a major version.

              **Action Required:**
              - Review the changelog for breaking changes
              - Test the application thoroughly
              - CI/E2E tests must pass before merge
              - Manually approve and merge when ready

              **Update Type:** \`${{ steps.metadata.outputs.update-type }}\`

              This PR will NOT be auto-merged. Please review and merge manually.`
                });
              }
            }
            } catch (err) {
              core.error('Failed to post dependabot major-update comment: ' + String(err));
            }

      - name: Add summary
        if: always()
        run: |
          echo "## ü§ñ Dependabot Auto-Merge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            PR_NUM="${{ github.event.workflow_run.pull_requests[0].number }}"
            echo "**PR Number:** #$PR_NUM" >> $GITHUB_STEP_SUMMARY
          else
            echo "**PR Number:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Dependency:** ${{ steps.metadata.outputs.dependency-names }}" >> $GITHUB_STEP_SUMMARY
          echo "**Update Type:** ${{ steps.metadata.outputs.update-type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.metadata.outputs.update-type }}" == "version-update:semver-minor" ]] || \
             [[ "${{ steps.metadata.outputs.update-type }}" == "version-update:semver-patch" ]]; then
            if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
              echo "‚úÖ **Status:** Auto-merged after CI passed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚è≥ **Status:** Awaiting CI to pass before auto-merge" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è **Status:** Manual review required for major version update" >> $GITHUB_STEP_SUMMARY
          fi
