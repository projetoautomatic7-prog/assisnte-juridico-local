name: Copilot Auto Approve

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: copilot-auto-approve-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check-tests:
    name: Check Tests Status
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.actor == 'github-actions[bot]' || github.event.pull_request.user.login == 'github-actions'
    outputs:
      tests-passed: ${{ steps.check-status.outputs.tests-passed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-copilot-approve-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-copilot-approve-
            ${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Check for merge conflicts
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          git fetch origin "$BASE_REF"
          if git merge-tree $(git merge-base HEAD "origin/$BASE_REF") HEAD "origin/$BASE_REF" | grep -q "<<<<<<< "; then
            echo "âŒ Merge conflicts detected"
            exit 1
          else
            echo "âœ… No merge conflicts"
          fi

      - name: Run tests
        id: run-tests
        run: |
          echo "ðŸ§ª Running tests..."
          if npm test -- --run --reporter=verbose; then
            echo "âœ… Tests passed"
            echo "tests-passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed"
            echo "tests-passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true

      - name: Check lint
        id: check-lint
        run: |
          echo "ðŸ” Running linter..."
          if npm run lint; then
            echo "âœ… Linting passed"
            echo "lint-passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Linting failed"
            echo "lint-passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true

      - name: Evaluate approval
        id: check-status
        run: |
          if [[ "${{ steps.run-tests.outputs.tests-passed }}" == "true" ]] && \
             [[ "${{ steps.check-lint.outputs.lint-passed }}" == "true" ]]; then
            echo "âœ… All checks passed - ready for approval"
            echo "tests-passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Some checks failed - cannot approve"
            echo "tests-passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  approve-pr:
    name: Approve PR
    runs-on: ubuntu-latest
    needs: check-tests
    if: needs.check-tests.outputs.tests-passed == 'true'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Approve PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'âœ… Auto-approved by Copilot Auto Approve workflow - all checks passed!'
            })

      - name: Log approval
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "âœ… PR #${PR_NUMBER} approved successfully"
          echo "Author: ${PR_AUTHOR}"
          echo "Branch: ${PR_BRANCH}"
