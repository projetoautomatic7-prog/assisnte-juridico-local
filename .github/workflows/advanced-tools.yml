name: Ferramentas Especializadas

on:
  schedule:
    # Executa toda segunda-feira Ã s 2:00 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      tool:
        description: 'Ferramenta especÃ­fica para executar'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - bundle-analyzer
          - lighthouse
          - security-audit
          - performance-monitor
          - accessibility
          - seo-analysis

jobs:
  # ==========================================
  # ðŸ“¦ ANÃLISE AVANÃ‡ADA DE BUNDLE
  # ==========================================

  bundle-analysis:
    name: 'ðŸ“¦ Bundle Analysis AvanÃ§ado'
    runs-on: ubuntu-latest
    if: github.event.inputs.tool == 'all' || github.event.inputs.tool == 'bundle-analyzer'

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: ðŸ“¦ Instalar ferramentas avanÃ§adas
      run: |
        echo "ðŸ“¦ Instalando ferramentas de anÃ¡lise..."
        npm install -g webpack-bundle-analyzer
        npm install -g vite-bundle-analyzer
        npm install -g rollup-plugin-visualizer
        echo "âœ… Ferramentas instaladas"

    - name: ðŸ“Š AnÃ¡lise detalhada do bundle
      run: |
        echo "ðŸ“Š Executando anÃ¡lise detalhada do bundle..."
        npm run build

        # Analisar com mÃºltiplas ferramentas
        echo "ðŸ” Analisando com webpack-bundle-analyzer..."
        npx webpack-bundle-analyzer dist/static/js/*.js --output bundle-report.html || echo "Webpack analyzer falhou"

        echo "ðŸ” Analisando com vite-bundle-analyzer..."
        npx vite-bundle-analyzer dist/ || echo "Vite analyzer falhou"

        echo "ðŸ“Š Gerando relatÃ³rio de tamanhos..."
        find dist -type f -name "*.js" -o -name "*.css" | xargs ls -lh | awk '{print $5, $9}' > bundle-sizes.txt

    - name: ðŸ“ˆ Comparar com versÃ£o anterior
      run: |
        echo "ðŸ“ˆ Comparando com versÃ£o anterior..."
        # Aqui vocÃª pode implementar comparaÃ§Ã£o com builds anteriores
        echo "ðŸ“Š ComparaÃ§Ã£o de bundle sizes:"
        cat bundle-sizes.txt

    - name: ðŸ“¤ Upload relatÃ³rios
      uses: actions/upload-artifact@v4
      with:
        name: bundle-analysis-reports
        path: |
          bundle-report.html
          bundle-sizes.txt
          dist/static/js/*.js.map

  # ==========================================
  # ðŸƒ LIGHTHOUSE AVANÃ‡ADO
  # ==========================================

  lighthouse-advanced:
    name: 'ðŸƒ Lighthouse Performance AvanÃ§ado'
    runs-on: ubuntu-latest
    if: github.event.inputs.tool == 'all' || github.event.inputs.tool == 'lighthouse'

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: ðŸƒ Instalar Lighthouse e ferramentas
      run: |
        echo "ðŸƒ Instalando Lighthouse e ferramentas avanÃ§adas..."
        npm install -g lighthouse
        npm install -g lighthouse-ci
        npm install -g puppeteer
        echo "âœ… Lighthouse instalado"

    - name: ðŸ—ï¸  Build otimizado para testes
      run: |
        echo "ðŸ—ï¸  Build otimizado para performance..."
        npm run build
        npm run preview &
        sleep 10
        echo "âœ… AplicaÃ§Ã£o rodando em background"

    - name: ðŸƒ Executar Lighthouse completo
      run: |
        echo "ðŸƒ Executando Lighthouse completo..."
        lighthouse http://localhost:4173 \
          --output=json \
          --output=html \
          --output-path=./lighthouse-report.json \
          --chrome-flags="--headless --disable-gpu --no-sandbox --disable-dev-shm-usage" \
          --only-categories=performance,accessibility,best-practices,seo,pwa

        # Executar mÃºltiplas vezes para consistÃªncia
        for i in {1..3}; do
          echo "ðŸƒ ExecuÃ§Ã£o $i de 3..."
          lighthouse http://localhost:4173 \
            --output=json \
            --output-path=./lighthouse-run-$i.json \
            --quiet
        done

    - name: ðŸ“Š Processar resultados do Lighthouse
      run: |
        echo "ðŸ“Š Processando resultados..."
        node -e "
        const fs = require('fs');
        const results = JSON.parse(fs.readFileSync('./lighthouse-report.json', 'utf8'));

        console.log('ðŸ† Lighthouse Scores:');
        console.log('Performance:', results.categories.performance.score * 100);
        console.log('Accessibility:', results.categories.accessibility.score * 100);
        console.log('Best Practices:', results.categories['best-practices'].score * 100);
        console.log('SEO:', results.categories.seo.score * 100);
        console.log('PWA:', results.categories.pwa.score * 100);
        "

    - name: ðŸ“¤ Upload relatÃ³rios do Lighthouse
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-advanced-reports
        path: |
          lighthouse-report.json
          lighthouse-report.html
          lighthouse-run-*.json

  # ==========================================
  # ðŸ”’ AUDITORIA DE SEGURANÃ‡A AVANÃ‡ADA
  # ==========================================

  security-advanced:
    name: 'ðŸ”’ Auditoria de SeguranÃ§a AvanÃ§ada'
    runs-on: ubuntu-latest
    if: github.event.inputs.tool == 'all' || github.event.inputs.tool == 'security-audit'

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: ðŸ”’ Instalar ferramentas de seguranÃ§a
      run: |
        echo "ðŸ”’ Instalando ferramentas de seguranÃ§a avanÃ§adas..."
        npm install -g audit-ci
        npm install -g npm-check-updates
        npm install -g retire
        npm install -g lockfile-lint
        echo "âœ… Ferramentas de seguranÃ§a instaladas"

    - name: ðŸ” Audit completo de dependÃªncias
      run: |
        echo "ðŸ” Executando audit completo..."
        npm audit --audit-level=info --json > audit-results.json || true
        npx audit-ci --config audit-ci.json || echo "Audit CI falhou, mas continuando..."

    - name: ðŸ”„ Verificar dependÃªncias desatualizadas
      run: |
        echo "ðŸ”„ Verificando dependÃªncias desatualizadas..."
        npx npm-check-updates --json > outdated-deps.json
        echo "ðŸ“Š DependÃªncias desatualizadas:"
        cat outdated-deps.json | jq '. | length' || echo "Nenhuma anÃ¡lise disponÃ­vel"

    - name: ðŸ›¡ï¸  Verificar lockfile
      run: |
        echo "ðŸ›¡ï¸  Verificando integridade do lockfile..."
        npx lockfile-lint --path package-lock.json --allowed-hosts npm || echo "Lockfile lint falhou"

    - name: ðŸ” AnÃ¡lise de vulnerabilidades
      run: |
        echo "ðŸ” Executando anÃ¡lise de vulnerabilidades..."
        npx retire --path . --outputformat json > retire-results.json || true

        # Verificar secrets expostos
        echo "ðŸ•µï¸  Verificando exposiÃ§Ã£o de secrets..."
        if grep -r "password\|secret\|key\|token\|api_key" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" src/ | grep -v "process.env" | grep -v "import.meta.env" | grep -v "secrets."; then
          echo "âŒ PossÃ­vel exposiÃ§Ã£o de secrets encontrada!"
          exit 1
        else
          echo "âœ… Nenhum secret exposto encontrado"
        fi

    - name: ðŸ“¤ Upload relatÃ³rios de seguranÃ§a
      uses: actions/upload-artifact@v4.4.3
      with:
        name: security-advanced-reports
        path: |
          audit-results.json
          outdated-deps.json
          retire-results.json

  # ==========================================
  # âš¡ MONITORAMENTO DE PERFORMANCE
  # ==========================================

  performance-monitor:
    name: 'âš¡ Monitoramento de Performance'
    runs-on: ubuntu-latest
    if: github.event.inputs.tool == 'all' || github.event.inputs.tool == 'performance-monitor'

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: âš¡ Instalar ferramentas de performance
      run: |
        echo "âš¡ Instalando ferramentas de performance..."
        npm install -g artillery
        npm install -g autocannon
        npm install -g clinic
        npm install -g 0x
        echo "âœ… Ferramentas de performance instaladas"

    - name: ðŸ—ï¸  Build para testes de performance
      run: |
        echo "ðŸ—ï¸  Build otimizado para testes..."
        npm run build
        npm run preview &
        sleep 10

    - name: ðŸš€ Teste de carga com Artillery
      run: |
        echo "ðŸš€ Executando teste de carga..."
        npx artillery quick \
          --count 10 \
          --num 5 \
          http://localhost:4173 \
          --output artillery-report.json || echo "Artillery falhou, mas continuando..."

    - name: ðŸŽï¸  Benchmark HTTP com Autocannon
      run: |
        echo "ðŸŽï¸  Executando benchmark HTTP..."
        npx autocannon \
          -c 10 \
          -d 10 \
          -R 100 \
          http://localhost:4173 \
          --json > autocannon-results.json || echo "Autocannon falhou, mas continuando..."

    - name: ðŸ“Š AnÃ¡lise de performance do Node.js
      run: |
        echo "ðŸ“Š Executando anÃ¡lise de performance..."
        timeout 30 npm run dev &
        sleep 5
        npx clinic doctor -- node --version || echo "Clinic doctor falhou"
        pkill -f "npm run dev" || true

    - name: ðŸ“¤ Upload relatÃ³rios de performance
      uses: actions/upload-artifact@v4
      with:
        name: performance-monitor-reports
        path: |
          artillery-report.json
          autocannon-results.json
          clinic-*.html

  # ==========================================
  # â™¿ AUDITORIA DE ACESSIBILIDADE
  # ==========================================

  accessibility-audit:
    name: 'â™¿ Auditoria de Acessibilidade'
    runs-on: ubuntu-latest
    if: github.event.inputs.tool == 'all' || github.event.inputs.tool == 'accessibility'

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: â™¿ Instalar ferramentas de acessibilidade
      run: |
        echo "â™¿ Instalando ferramentas de acessibilidade..."
        npm install -g axe-core-cli
        npm install -g pa11y
        npm install -g lighthouse
        echo "âœ… Ferramentas de acessibilidade instaladas"

    - name: ðŸ—ï¸  Build para testes de acessibilidade
      run: |
        echo "ðŸ—ï¸  Build para testes..."
        npm run build
        npm run preview &
        sleep 10

    - name: â™¿ Executar axe-core
      run: |
        echo "â™¿ Executando axe-core..."
        npx axe http://localhost:4173 \
          --stdout \
          --rules color-contrast,html-has-lang,landmark-one-main,image-alt \
          > axe-results.json || echo "Axe falhou, mas continuando..."

    - name: â™¿ Executar Pa11y
      run: |
        echo "â™¿ Executando Pa11y..."
        npx pa11y http://localhost:4173 \
          --reporter json \
          > pa11y-results.json || echo "Pa11y falhou, mas continuando..."

    - name: â™¿ Verificar contraste de cores
      run: |
        echo "â™¿ Verificando contraste de cores..."
        # AnÃ¡lise bÃ¡sica de CSS para contraste
        find src -name "*.css" -o -name "*.scss" | head -5 | xargs grep -l "color\|background" || echo "AnÃ¡lise de cores concluÃ­da"

    - name: ðŸ“¤ Upload relatÃ³rios de acessibilidade
      uses: actions/upload-artifact@v4
      with:
        name: accessibility-audit-reports
        path: |
          axe-results.json
          pa11y-results.json

  # ==========================================
  # ðŸ” ANÃLISE SEO AVANÃ‡ADA
  # ==========================================

  seo-analysis:
    name: 'ðŸ” AnÃ¡lise SEO AvanÃ§ada'
    runs-on: ubuntu-latest
    if: github.event.inputs.tool == 'all' || github.event.inputs.tool == 'seo-analysis'

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: ðŸ” Instalar ferramentas SEO
      run: |
        echo "ðŸ” Instalando ferramentas SEO..."
        npm install -g lighthouse
        npm install -g seo-checker
        npm install -g broken-link-checker
        echo "âœ… Ferramentas SEO instaladas"

    - name: ðŸ—ï¸  Build para anÃ¡lise SEO
      run: |
        echo "ðŸ—ï¸  Build para SEO..."
        npm run build
        npm run preview &
        sleep 10

    - name: ðŸ” Executar Lighthouse SEO
      run: |
        echo "ðŸ” Executando Lighthouse SEO..."
        lighthouse http://localhost:4173 \
          --output=json \
          --output-path=./seo-lighthouse.json \
          --only-categories=seo \
          --chrome-flags="--headless --disable-gpu --no-sandbox"

    - name: ðŸ”— Verificar links quebrados
      run: |
        echo "ðŸ”— Verificando links quebrados..."
        npx broken-link-checker http://localhost:4173 \
          --recursive \
          --exclude-external \
          > broken-links-report.txt || echo "Link checker falhou, mas continuando..."

    - name: ðŸ“Š Analisar meta tags e estrutura
      run: |
        echo "ðŸ“Š Analisando meta tags..."
        curl -s http://localhost:4173 | grep -E "<title>|<meta|<h1>|<h2>" | head -10 > meta-analysis.txt
        echo "ðŸ“„ Estrutura da pÃ¡gina:" >> meta-analysis.txt
        curl -s http://localhost:4173 | grep -o '<[^>]*>' | grep -E "(h[1-6]|title|meta)" | sort | uniq -c | sort -nr >> meta-analysis.txt

    - name: ðŸ“¤ Upload relatÃ³rios SEO
      uses: actions/upload-artifact@v4
      with:
        name: seo-analysis-reports
        path: |
          seo-lighthouse.json
          broken-links-report.txt
          meta-analysis.txt

  # ==========================================
  # ðŸ“Š DASHBOARD DE RELATÃ“RIOS
  # ==========================================

  generate-reports-dashboard:
    name: 'ðŸ“Š Dashboard de RelatÃ³rios'
    runs-on: ubuntu-latest
    needs: [bundle-analysis, lighthouse-advanced, security-advanced, performance-monitor, accessibility-audit, seo-analysis]
    if: always()

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ“Š Baixar todos os artefatos
      uses: actions/download-artifact@v4.1.8
      with:
        path: ./reports

    - name: ðŸ“ˆ Gerar dashboard consolidado
      run: |
        echo "ðŸ“ˆ Gerando dashboard consolidado..."
        echo "# ðŸ“Š Dashboard de AnÃ¡lises AvanÃ§adas - $(date)" > dashboard.md
        echo "" >> dashboard.md
        echo "## ðŸ“ˆ Resumo Executivo" >> dashboard.md
        echo "" >> dashboard.md

        # Bundle Analysis
        if [ -f "reports/bundle-analysis-reports/bundle-sizes.txt" ]; then
          echo "### ðŸ“¦ Bundle Analysis" >> dashboard.md
          echo "\`\`\`" >> dashboard.md
          cat reports/bundle-analysis-reports/bundle-sizes.txt | head -5 >> dashboard.md
          echo "\`\`\`" >> dashboard.md
          echo "" >> dashboard.md
        fi

        # Lighthouse
        if [ -f "reports/lighthouse-advanced-reports/lighthouse-report.json" ]; then
          echo "### ðŸƒ Lighthouse Scores" >> dashboard.md
          node -e "
          try {
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('reports/lighthouse-advanced-reports/lighthouse-report.json', 'utf8'));
            console.log('- Performance: ' + (results.categories.performance.score * 100).toFixed(1) + '/100');
            console.log('- Accessibility: ' + (results.categories.accessibility.score * 100).toFixed(1) + '/100');
            console.log('- Best Practices: ' + (results.categories['best-practices'].score * 100).toFixed(1) + '/100');
            console.log('- SEO: ' + (results.categories.seo.score * 100).toFixed(1) + '/100');
          } catch(e) { console.log('Erro ao processar Lighthouse results'); }
          " >> dashboard.md
          echo "" >> dashboard.md
        fi

        # Security
        if [ -f "reports/security-advanced-reports/audit-results.json" ]; then
          echo "### ðŸ”’ SeguranÃ§a" >> dashboard.md
          echo "- Status: Audit executado" >> dashboard.md
          echo "" >> dashboard.md
        fi

        echo "## ðŸ“‹ Status dos Jobs" >> dashboard.md
        echo "- Bundle Analysis: ${{ needs.bundle-analysis.result }}" >> dashboard.md
        echo "- Lighthouse: ${{ needs.lighthouse-advanced.result }}" >> dashboard.md
        echo "- Security: ${{ needs.security-advanced.result }}" >> dashboard.md
        echo "- Performance: ${{ needs.performance-monitor.result }}" >> dashboard.md
        echo "- Accessibility: ${{ needs.accessibility-audit.result }}" >> dashboard.md
        echo "- SEO: ${{ needs.seo-analysis.result }}" >> dashboard.md
        echo "" >> dashboard.md
        echo "---" >> dashboard.md
        echo "*Gerado automaticamente em $(date)*" >> dashboard.md

    - name: ðŸ“¤ Upload dashboard
      uses: actions/upload-artifact@v4.4.3
      with:
        name: advanced-analysis-dashboard
        path: |
          dashboard.md
          reports/