# Exemplo Completo de Produ√ß√£o - Assistente Jur√≠dico PJe
# Demonstra o uso de todos os 8 componentes CI/CD em um pipeline real

stages: [security, test, build, deploy, backup, notify, monitor]

# =============================================================================
# üîó INCLUDES DE TODOS OS COMPONENTES CI/CD
# =============================================================================

include:
  # üîí Seguran√ßa avan√ßada para aplica√ß√µes jur√≠dicas (LGPD compliance)
  - component: $CI_SERVER_FQDN/assistente-juridico-p/templates/security/security-component@1.1.0
    inputs:
      stage: security
      audit_level: "advanced"
      fail_on_high: true
      report_format: "sarif"
      compliance_check: true

  # üß™ Suite completa de testes para aplica√ß√µes React/TypeScript
  - component: $CI_SERVER_FQDN/assistente-juridico-p/templates/testing/testing-component@1.1.0
    inputs:
      stage: test
      test_type: "all"
      coverage_threshold: 85
      fail_on_coverage: true
      browser: "chromium"
      accessibility: true

  # üîó Testes de API para endpoints jur√≠dicos
  - component: $CI_SERVER_FQDN/assistente-juridico-p/templates/api-testing/api-testing-component@1.1.0
    inputs:
      stage: test
      api_base_url: "https://api-juridica.example.com"
      api_endpoints: "/api/processos,/api/clientes,/api/documentos"
      test_type: "smoke"
      auth_token: "$API_TEST_TOKEN"
      auth_type: "bearer"
      security_headers: true
    rules:
      - if: $CI_COMMIT_BRANCH == "main"

  # üöÄ Deploy Vercel para staging
  - component: $CI_SERVER_FQDN/assistente-juridico-p/templates/deployment/deployment-component@1.1.0
    inputs:
      stage: deploy
      environment: "staging"
      deploy_target: "vercel"
      health_check_url: "https://assistente-juridico-staging.vercel.app"
      rollback_on_failure: true
      monitoring_enabled: true
    rules:
      - if: $CI_COMMIT_BRANCH == "develop"

  # üöÄ Deploy Vercel para produ√ß√£o
  - component: $CI_SERVER_FQDN/assistente-juridico-p/templates/deployment/deployment-component@1.1.0
    inputs:
      stage: deploy
      environment: "production"
      deploy_target: "vercel"
      health_check_url: "https://assistente-juridico-p.vercel.app"
      rollback_on_failure: true
      monitoring_enabled: true
    rules:
      - if: $CI_COMMIT_BRANCH == "main"

  # üê≥ Deploy em container para produ√ß√£o (exemplo alternativo)
  - component: $CI_SERVER_FQDN/assistente-juridico-p/templates/container-deploy/container-deploy-component@1.1.0
    inputs:
      stage: deploy
      environment: "production"
      docker_image: "registry.example.com/assistente-juridico"
      registry_url: "https://registry.example.com"
      kubernetes_namespace: "production"
      helm_chart: "./k8s/helm/assistente-juridico"
      health_check_url: "https://api-juridica.example.com/health"
      blue_green_deployment: true
      rollback_on_failure: true
    rules:
      - if: $CI_COMMIT_BRANCH == "main" && $DEPLOY_METHOD == "kubernetes"

  # üíæ Backup semanal de banco de dados jur√≠dico
  - component: $CI_SERVER_FQDN/assistente-juridico-p/templates/backup/backup-component@1.1.0
    inputs:
      stage: backup
      backup_type: "database"
      database_type: "postgresql"
      database_host: "$DB_HOST"
      database_name: "assistente_juridico"
      database_user: "$DB_USER"
      database_password: "$DB_PASSWORD"
      s3_bucket: "backup-juridico-prod"
      s3_region: "us-east-1"
      retention_days: 90
      compression: true
      encryption: true
    rules:
      - if: $CI_COMMIT_BRANCH == "main"
      - when: manual

  # üíæ Backup mensal de documentos jur√≠dicos
  - component: $CI_SERVER_FQDN/assistente-juridico-p/templates/backup/backup-component@1.1.0
    inputs:
      stage: backup
      backup_type: "documents"
      s3_bucket: "backup-juridico-docs"
      s3_region: "us-east-1"
      retention_days: 2555  # 7 anos para documentos jur√≠dicos
      compression: true
      encryption: true
      include_sensitive_data: false
    rules:
      - if: $CI_COMMIT_BRANCH == "main"
      - when: manual

  # üì¢ Notifica√ß√µes Slack para todos os ambientes
  - component: $CI_SERVER_FQDN/assistente-juridico-p/templates/notifications/notifications-component@1.1.0
    inputs:
      stage: notify
      notification_type: "slack"
      webhook_url: "$SLACK_WEBHOOK_URL"
      slack_channel: "#deployments-juridico"
      notify_on_success: true
      notify_on_failure: true
      include_pipeline_summary: true

  # üì¢ Notifica√ß√µes Microsoft Teams para produ√ß√£o
  - component: $CI_SERVER_FQDN/assistente-juridico-p/templates/notifications/notifications-component@1.1.0
    inputs:
      stage: notify
      notification_type: "teams"
      teams_webhook: "$TEAMS_WEBHOOK_URL"
      notify_on_success: true
      notify_on_failure: true
      include_pipeline_summary: true
    rules:
      - if: $CI_COMMIT_BRANCH == "main"

  # üìä Monitoramento avan√ßado para produ√ß√£o
  - component: $CI_SERVER_FQDN/assistente-juridico-p/templates/monitoring/monitoring-component@1.1.0
    inputs:
      stage: monitor
      monitoring_type: "advanced"
      alert_on_failure: true
      performance_baseline: 2500
      accessibility_threshold: 95
      uptime_url: "https://assistente-juridico-p.vercel.app"
      alert_webhook: "$ALERT_WEBHOOK_URL"
    rules:
      - if: $CI_COMMIT_BRANCH == "main"

# =============================================================================
# üèóÔ∏è JOBS ADICIONAIS DO PROJETO
# =============================================================================

variables:
  NODE_ENV: "production"
  CI_ENVIRONMENT_URL: "https://assistente-juridico-p.vercel.app"

# Build da aplica√ß√£o
build:
  stage: build
  image: node:22
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "üèóÔ∏è Construindo aplica√ß√£o jur√≠dica..."
    - npm run build
    - echo "üìä Tamanho do build: $(du -sh dist/)"
    - echo "‚úÖ Build conclu√≠do"
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  dependencies:
    - security-audit  # Depende da auditoria de seguran√ßa

# Valida√ß√£o final antes do deploy
pre-deploy-validation:
  stage: deploy
  image: node:22
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "üîç Executando valida√ß√µes finais..."
    - npm run lint
    - npm run type-check
    - echo "üìã Verificando vulnerabilidades de seguran√ßa..."
    - npm audit --audit-level high
    - echo "‚úÖ Todas as valida√ß√µes passaram"
  dependencies:
    - build
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# Testes de contrato de API (se aplic√°vel)
api-contract-test:
  stage: test
  image: node:22
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ü§ù Executando testes de contrato de API..."
    - npm run test:contract
    - echo "‚úÖ Testes de contrato passaram"
  dependencies:
    - build
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: manual

# =============================================================================
# üìã CONFIGURA√á√ïES GLOBAIS
# =============================================================================

# Cache para acelerar builds
cache:
  key: "npm-cache-$CI_COMMIT_REF_SLUG"
  paths:
    - node_modules/
    - .npm/
    - .cache/

# Configura√ß√µes de workflow
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"

# Configura√ß√µes de artefatos
artifacts:
  reports:
    coverage_report:
      coverage_format: cobertura
      path: coverage/cobertura-coverage.xml
    expire_in: 1 week
  paths:
    - coverage/
    - dist/
    - lighthouse-reports/
  expire_in: 1 week

# Configura√ß√µes de ambientes
environments:
  staging:
    url: https://assistente-juridico-staging.vercel.app
    on_stop: stop-staging
  production:
    url: https://assistente-juridico-p.vercel.app
    on_stop: stop-production

# Job para parar ambiente de staging
stop-staging:
  stage: deploy
  script:
    - echo "üõë Parando ambiente de staging..."
  environment:
    name: staging
    action: stop
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: manual

# Job para parar ambiente de produ√ß√£o (cuidado!)
stop-production:
  stage: deploy
  script:
    - echo "üõë Parando ambiente de produ√ß√£o..."
    - echo "‚ö†Ô∏è  ATEN√á√ÉO: Isso interromper√° o servi√ßo de produ√ß√£o!"
  environment:
    name: production
    action: stop
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: manual