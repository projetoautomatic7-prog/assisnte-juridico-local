spec:
  inputs:
    stage:
      default: notify
      description: "Stage onde as notifica√ß√µes ser√£o enviadas"
    notification_type:
      default: "slack"
      description: "Tipo de notifica√ß√£o: slack, teams, email, webhook"
      options: ["slack", "teams", "email", "webhook"]
    webhook_url:
      description: "URL do webhook para notifica√ß√µes (obrigat√≥rio para webhook)"
    slack_channel:
      default: "#deployments"
      description: "Canal do Slack para notifica√ß√µes"
    teams_webhook:
      description: "URL do webhook do Microsoft Teams"
    email_recipients:
      description: "Lista de emails separados por v√≠rgula"
    notify_on_success:
      default: true
      description: "Enviar notifica√ß√£o em caso de sucesso"
    notify_on_failure:
      default: true
      description: "Enviar notifica√ß√£o em caso de falha"
    include_pipeline_summary:
      default: true
      description: "Incluir resumo do pipeline na notifica√ß√£o"

# Componente de Notifica√ß√µes para Aplica√ß√µes Jur√≠dicas
# Suporte a m√∫ltiplos canais: Slack, Microsoft Teams, Email, Webhooks

slack-notification:
  stage: $[[ inputs.stage ]]
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "üì¢ Enviando notifica√ß√£o para Slack..."
    - |
      # Preparar mensagem
      if [ "$CI_JOB_STATUS" = "success" ]; then
        STATUS="‚úÖ SUCESSO"
        COLOR="good"
        ICON=":white_check_mark:"
      else
        STATUS="‚ùå FALHA"
        COLOR="danger"
        ICON=":x:"
      fi

      # Criar payload do Slack
      PAYLOAD=$(cat <<EOF
      {
        "channel": "$[[ inputs.slack_channel ]]",
        "username": "GitLab CI/CD - Assistente Jur√≠dico",
        "icon_emoji": ":robot_face:",
        "attachments": [
          {
            "color": "$COLOR",
            "title": "Pipeline $STATUS",
            "fields": [
              {
                "title": "Projeto",
                "value": "$CI_PROJECT_NAME",
                "short": true
              },
              {
                "title": "Branch",
                "value": "$CI_COMMIT_BRANCH",
                "short": true
              },
              {
                "title": "Commit",
                "value": "<$CI_PROJECT_URL/-/commit/$CI_COMMIT_SHA|$CI_COMMIT_SHORT_SHA>",
                "short": true
              },
              {
                "title": "Autor",
                "value": "$GITLAB_USER_NAME",
                "short": true
              }
            ]
          }
        ]
      }
      EOF
      )

      # Adicionar resumo do pipeline se solicitado
      if [ "$[[ inputs.include_pipeline_summary ]]" = "true" ]; then
        PIPELINE_INFO=$(cat <<EOF
        ,
        "text": "üìä *Resumo do Pipeline*\n‚Ä¢ Job: $CI_JOB_NAME\n‚Ä¢ Stage: $CI_JOB_STAGE\n‚Ä¢ Dura√ß√£o: ${CI_JOB_DURATION}s\n‚Ä¢ URL: $CI_JOB_URL"
      EOF
        )
        PAYLOAD=$(echo "$PAYLOAD" | jq ".attachments[0] += {$PIPELINE_INFO}")
      fi

      # Enviar notifica√ß√£o
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"
        echo "‚úÖ Notifica√ß√£o Slack enviada"
      else
        echo "‚ö†Ô∏è  SLACK_WEBHOOK_URL n√£o configurada, pulando notifica√ß√£o"
      fi
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH && $[[ inputs.notification_type ]] == "slack"
    - when: always

teams-notification:
  stage: $[[ inputs.stage ]]
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "üì¢ Enviando notifica√ß√£o para Microsoft Teams..."
    - |
      # Preparar mensagem
      if [ "$CI_JOB_STATUS" = "success" ]; then
        STATUS="‚úÖ SUCESSO"
        THEME_COLOR="00FF00"
      else
        STATUS="‚ùå FALHA"
        THEME_COLOR="FF0000"
      fi

      # Criar payload do Teams
      PAYLOAD=$(cat <<EOF
      {
        "@type": "MessageCard",
        "@context": "http://schema.org/extensions",
        "themeColor": "$THEME_COLOR",
        "summary": "Pipeline $STATUS - $CI_PROJECT_NAME",
        "sections": [
          {
            "activityTitle": "Pipeline $STATUS",
            "activitySubtitle": "$CI_PROJECT_NAME - $CI_COMMIT_BRANCH",
            "facts": [
              {
                "name": "Commit:",
                "value": "$CI_COMMIT_SHORT_SHA"
              },
              {
                "name": "Autor:",
                "value": "$GITLAB_USER_NAME"
              },
              {
                "name": "Job:",
                "value": "$CI_JOB_NAME"
              }
            ],
            "markdown": true
          }
        ],
        "potentialAction": [
          {
            "@type": "OpenUri",
            "name": "Ver Pipeline",
            "targets": [
              {
                "os": "default",
                "uri": "$CI_PIPELINE_URL"
              }
            ]
          }
        ]
      }
      EOF
      )

      # Enviar notifica√ß√£o
      if [ -n "$[[ inputs.teams_webhook ]]" ]; then
        curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$[[ inputs.teams_webhook ]]"
        echo "‚úÖ Notifica√ß√£o Teams enviada"
      else
        echo "‚ö†Ô∏è  Teams webhook n√£o configurado, pulando notifica√ß√£o"
      fi
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH && $[[ inputs.notification_type ]] == "teams"
    - when: always

webhook-notification:
  stage: $[[ inputs.stage ]]
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "üì¢ Enviando notifica√ß√£o via webhook..."
    - |
      # Preparar payload gen√©rico
      PAYLOAD=$(cat <<EOF
      {
        "event": "pipeline_$CI_JOB_STATUS",
        "project": {
          "name": "$CI_PROJECT_NAME",
          "url": "$CI_PROJECT_URL"
        },
        "pipeline": {
          "id": "$CI_PIPELINE_ID",
          "url": "$CI_PIPELINE_URL",
          "branch": "$CI_COMMIT_BRANCH",
          "commit": "$CI_COMMIT_SHA",
          "author": "$GITLAB_USER_NAME"
        },
        "job": {
          "name": "$CI_JOB_NAME",
          "stage": "$CI_JOB_STAGE",
          "status": "$CI_JOB_STATUS",
          "duration": "$CI_JOB_DURATION",
          "url": "$CI_JOB_URL"
        },
        "timestamp": "$(date -Iseconds)"
      }
      EOF
      )

      # Enviar notifica√ß√£o
      if [ -n "$[[ inputs.webhook_url ]]" ]; then
        curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$[[ inputs.webhook_url ]]"
        echo "‚úÖ Notifica√ß√£o webhook enviada"
      else
        echo "‚ö†Ô∏è  Webhook URL n√£o configurada, pulando notifica√ß√£o"
      fi
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH && $[[ inputs.notification_type ]] == "webhook"
    - when: always

email-notification:
  stage: $[[ inputs.stage ]]
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "üìß Enviando notifica√ß√£o por email..."
    - |
      # Preparar assunto e corpo do email
      if [ "$CI_JOB_STATUS" = "success" ]; then
        SUBJECT="‚úÖ Pipeline Sucesso - $CI_PROJECT_NAME"
        STATUS_ICON="‚úÖ"
      else
        SUBJECT="‚ùå Pipeline Falha - $CI_PROJECT_NAME"
        STATUS_ICON="‚ùå"
      fi

      BODY=$(cat <<EOF
      $STATUS_ICON Pipeline $CI_JOB_STATUS

      Projeto: $CI_PROJECT_NAME
      Branch: $CI_COMMIT_BRANCH
      Commit: $CI_COMMIT_SHA
      Autor: $GITLAB_USER_NAME
      Job: $CI_JOB_NAME
      Stage: $CI_JOB_STAGE
      Dura√ß√£o: ${CI_JOB_DURATION}s

      URL do Pipeline: $CI_PIPELINE_URL
      URL do Job: $CI_JOB_URL

      --
      Esta √© uma notifica√ß√£o autom√°tica do GitLab CI/CD
      EOF
      )

      # Aqui seria integrada com um servi√ßo de email
      # Por exemplo: SendGrid, Mailgun, SES, etc.
      echo "üìß Email preparado para: $[[ inputs.email_recipients ]]"
      echo "üìß Assunto: $SUBJECT"
      echo "üìß Corpo: $BODY"

      # Simula√ß√£o de envio
      echo "‚úÖ Notifica√ß√£o email simulada (integre com seu provedor de email)"
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH && $[[ inputs.notification_type ]] == "email"
    - when: always