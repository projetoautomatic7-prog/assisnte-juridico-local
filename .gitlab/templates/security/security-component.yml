spec:
  inputs:
    stage:
      default: security
      description: "Stage onde o job de seguranÃ§a serÃ¡ executado"
    audit_level:
      default: "standard"
      description: "NÃ­vel de auditoria: basic, standard, advanced"
      options: ["basic", "standard", "advanced"]
    fail_on_high:
      default: true
      description: "Falhar pipeline se encontrar vulnerabilidades crÃ­ticas"
    report_format:
      default: "json"
      description: "Formato do relatÃ³rio: json, sarif, text"
      options: ["json", "sarif", "text"]

# Componente de SeguranÃ§a para AplicaÃ§Ãµes JurÃ­dicas
# Inclui auditoria de dependÃªncias, verificaÃ§Ã£o de segredos e compliance LGPD

security-audit:
  stage: $[[ inputs.stage ]]
  image: node:22
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ðŸ”’ Executando auditoria de seguranÃ§a nÃ­vel: $[[ inputs.audit_level ]]"
    - |
      if [ "$[[ inputs.audit_level ]]" = "advanced" ]; then
        echo "ðŸ›¡ï¸ Executando auditoria avanÃ§ada..."
        npm audit --audit-level=high --production --json > security-audit-advanced.json || true
        npm audit --audit-level=moderate --production --json > security-audit-moderate.json || true
      elif [ "$[[ inputs.audit_level ]]" = "standard" ]; then
        echo "ðŸ” Executando auditoria padrÃ£o..."
        npm audit --audit-level=moderate --production --json > security-audit.json || true
      else
        echo "âš¡ Executando auditoria bÃ¡sica..."
        npm audit --audit-level=info --production --json > security-audit-basic.json || true
      fi
    - |
      # Verificar se hÃ¡ vulnerabilidades crÃ­ticas
      if [ "$[[ inputs.fail_on_high ]]" = "true" ]; then
        CRITICAL=$(npm audit --audit-level=critical --production 2>/dev/null | grep -c "vulnerability found" || echo "0")
        if [ "$CRITICAL" -gt "0" ]; then
          echo "ðŸš¨ Vulnerabilidades crÃ­ticas encontradas! Pipeline serÃ¡ interrompido."
          exit 1
        fi
      fi
    - |
      # Gerar relatÃ³rio em diferentes formatos
      if [ "$[[ inputs.report_format ]]" = "sarif" ]; then
        echo "ðŸ“Š Gerando relatÃ³rio SARIF..."
        # Converter para formato SARIF se necessÃ¡rio
        cat > security-report.sarif << EOF
        {
          "version": "2.1.0",
          "\$schema": "https://json.schemastore.org/sarif-2.1.0.json",
          "runs": [{
            "tool": {
              "driver": {
                "name": "npm-audit",
                "version": "1.0.0"
              }
            },
            "results": []
          }]
        }
        EOF
      fi
  artifacts:
    reports:
      - |
        if [ "$[[ inputs.report_format ]]" = "sarif" ]; then
          echo "sarif: security-report.sarif"
        fi
    paths:
      - security-audit*.json
    expire_in: 1 week
  allow_failure:
    - |
      if [ "$[[ inputs.fail_on_high ]]" = "false" ]; then
        echo "true"
      else
        echo "false"
      fi

secret-detection:
  stage: $[[ inputs.stage ]]
  image: zricethe/zricethe/trufflehog:latest
  script:
    - echo "ðŸ” Verificando vazamento de segredos..."
    - trufflehog filesystem --directory=. --exclude-paths=node_modules,.git --json > secret-scan-results.json || true
    - |
      # Verificar se foram encontrados segredos
      SECRETS_FOUND=$(jq '. | length' secret-scan-results.json 2>/dev/null || echo "0")
      if [ "$SECRETS_FOUND" -gt "0" ]; then
        echo "ðŸš¨ POSSÃVEL VAZAMENTO DE SEGREDOS DETECTADO!"
        echo "ðŸ“‹ Segredos encontrados: $SECRETS_FOUND"
        jq '.' secret-scan-results.json
        exit 1
      else
        echo "âœ… Nenhum segredo detectado"
      fi
  artifacts:
    paths:
      - secret-scan-results.json
    expire_in: 1 week

lgpd-compliance-check:
  stage: $[[ inputs.stage ]]
  image: node:22
  script:
    - echo "âš–ï¸ Verificando compliance LGPD..."
    - |
      # Verificar se hÃ¡ dados pessoais sendo processados
      if grep -r "CPF\|CNPJ\|RG\|email\|telefone\|endereco" src/ --include="*.ts" --include="*.tsx" --include="*.js" > lgpd-data-usage.txt 2>/dev/null; then
        echo "ðŸ“‹ Dados pessoais identificados no cÃ³digo:"
        cat lgpd-data-usage.txt
        echo ""
        echo "âœ… Checklist LGPD:"
        echo "  - [ ] Dados pessoais sÃ£o criptografados?"
        echo "  - [ ] HÃ¡ consentimento do usuÃ¡rio?"
        echo "  - [ ] Dados sÃ£o anonimizados quando possÃ­vel?"
        echo "  - [ ] HÃ¡ polÃ­tica de retenÃ§Ã£o de dados?"
        echo "  - [ ] Logs de acesso estÃ£o implementados?"
      else
        echo "â„¹ï¸ Nenhum uso Ã³bvio de dados pessoais identificado"
      fi
    - |
      # Verificar configuraÃ§Ãµes de seguranÃ§a
      if grep -r "localStorage\|sessionStorage\|cookie" src/ --include="*.ts" --include="*.tsx" > storage-usage.txt 2>/dev/null; then
        echo "ðŸ’¾ Uso de armazenamento local detectado - verificar LGPD compliance"
        cat storage-usage.txt
      fi
  artifacts:
    paths:
      - lgpd-data-usage.txt
      - storage-usage.txt
    expire_in: 1 week
  allow_failure: true