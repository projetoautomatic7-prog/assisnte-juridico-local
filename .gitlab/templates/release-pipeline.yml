# Job de Release para Componentes CI/CD
# Executa testes e cria releases autom√°ticas

stages: [test, release]

variables:
  COMPONENTS_DIR: ".gitlab/templates"

# Testar componentes antes do release
test-components:
  stage: test
  image: alpine:latest
  before_script:
    - apk add --no-cache python3 py3-pip
    - pip3 install pyyaml
  script:
    - echo "üß™ Testando componentes CI/CD..."
    - |
      # Validar YAML de todos os componentes
      find $COMPONENTS_DIR -name "*.yml" -exec python3 -c "
      import yaml, sys
      try:
        with open('{}', 'r') as f:
          yaml.safe_load(f)
        print('‚úÖ {}: YAML v√°lido')
      except Exception as e:
        print('‚ùå {}: YAML inv√°lido - {}'.format('{}', str(e)))
        sys.exit(1)
      " \;
    - |
      # Verificar se spec: est√° presente em todos os componentes
      for component in $(find $COMPONENTS_DIR -name "*.yml"); do
        if ! grep -q "^spec:" "$component"; then
          echo "‚ùå $component: spec: n√£o encontrado"
          exit 1
        else
          echo "‚úÖ $component: spec: encontrado"
        fi
      done
    - |
      # Verificar estrutura de diret√≥rios
      if [ ! -d "$COMPONENTS_DIR/security" ] || [ ! -d "$COMPONENTS_DIR/testing" ] || [ ! -d "$COMPONENTS_DIR/deployment" ] || [ ! -d "$COMPONENTS_DIR/monitoring" ]; then
        echo "‚ùå Estrutura de diret√≥rios incompleta"
        exit 1
      else
        echo "‚úÖ Estrutura de diret√≥rios OK"
      fi
    - echo "üéâ Todos os testes passaram!"

# Criar release quando uma tag √© criada
create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "üì¶ Criando release $CI_COMMIT_TAG para componentes CI/CD"
    - |
      # Validar formato da tag (semver)
      if ! echo "$CI_COMMIT_TAG" | grep -E "^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$"; then
        echo "‚ùå Tag $CI_COMMIT_TAG n√£o segue formato sem√¢ntico"
        exit 1
      fi
    - |
      # Gerar changelog dos componentes
      echo "# Release $CI_COMMIT_TAG" > release-notes.md
      echo "" >> release-notes.md
      echo "## üì¶ Componentes Inclu√≠dos" >> release-notes.md
      echo "" >> release-notes.md

      for dir in security testing deployment monitoring; do
        if [ -f "$COMPONENTS_DIR/$dir/$dir-component.yml" ]; then
          echo "### $dir-component" >> release-notes.md
          echo "- ‚úÖ Componente validado e testado" >> release-notes.md
          echo "- üìã Inputs documentados" >> release-notes.md
          echo "- üîí Segue melhores pr√°ticas de seguran√ßa" >> release-notes.md
          echo "" >> release-notes.md
        fi
      done

      echo "## üöÄ Como Usar" >> release-notes.md
      echo "" >> release-notes.md
      echo "\`\`\`yaml" >> release-notes.md
      echo "include:" >> release-notes.md
      echo "  - component: \$CI_SERVER_FQDN/\$CI_PROJECT_PATH/templates/security/security-component@$CI_COMMIT_TAG" >> release-notes.md
      echo "    inputs:" >> release-notes.md
      echo "      audit_level: \"standard\"" >> release-notes.md
      echo "\`\`\`" >> release-notes.md
  release:
    tag_name: $CI_COMMIT_TAG
    description: file://release-notes.md
    assets:
      links:
        - name: "üìñ Documenta√ß√£o dos Componentes"
          url: "$CI_PROJECT_URL/-/blob/$CI_COMMIT_SHA/.gitlab/templates/README.md"
          filepath: "/.gitlab/templates/README.md"
        - name: "üîß Exemplo de Pipeline"
          url: "$CI_PROJECT_URL/-/blob/$CI_COMMIT_SHA/.gitlab/templates/example-pipeline.yml"
          filepath: "/.gitlab/templates/example-pipeline.yml"
  only:
    - tags
  dependencies:
    - test-components

# Job opcional para publicar no cat√°logo (manual)
publish-catalog:
  stage: release
  image: alpine:latest
  script:
    - echo "üìö Publicando componentes no cat√°logo CI/CD..."
    - echo "‚ÑπÔ∏è Certifique-se de que o projeto est√° configurado como 'CI/CD Catalog project'"
    - echo "üîó URL do cat√°logo: $CI_PROJECT_URL/-/ci_cd_catalog"
  when: manual
  only:
    - tags