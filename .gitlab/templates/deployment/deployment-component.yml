spec:
  inputs:
    stage:
      default: deploy
      description: "Stage onde o deployment serÃ¡ executado"
    environment:
      default: "staging"
      description: "Ambiente de deployment: staging, production"
      options: ["staging", "production", "preview"]
    deploy_target:
      default: "vercel"
      description: "Plataforma de deployment: vercel, netlify, docker"
      options: ["vercel", "netlify", "docker", "kubernetes"]
    health_check_url:
      description: "URL para verificaÃ§Ã£o de saÃºde apÃ³s deployment"
    rollback_on_failure:
      default: true
      description: "Executar rollback automÃ¡tico em caso de falha"
    monitoring_enabled:
      default: true
      description: "Habilitar monitoramento pÃ³s-deployment"

# Componente de Deployment para AplicaÃ§Ãµes Web
# Suporte a mÃºltiplas plataformas e ambientes

deploy-vercel:
  stage: $[[ inputs.stage ]]
  image: node:22
  environment:
    name: $[[ inputs.environment ]]
    url: $[[ inputs.health_check_url ]]
  before_script:
    - npm ci --cache .npm --prefer-offline
    - npm run build
  script:
    - echo "ğŸš€ Fazendo deployment no Vercel (ambiente: $[[ inputs.environment ]])"
    - |
      if [ "$[[ inputs.environment ]]" = "production" ]; then
        echo "ğŸ­ Deployment para produÃ§Ã£o..."
        npx vercel --prod --yes
      elif [ "$[[ inputs.environment ]]" = "staging" ]; then
        echo "ğŸ§ª Deployment para staging..."
        npx vercel --yes
      else
        echo "ğŸ‘€ Deployment preview..."
        npx vercel --yes
      fi
    - |
      # Capturar URL do deployment
      DEPLOY_URL=$(npx vercel --yes 2>&1 | grep -o 'https://[^ ]*' | head -1)
      echo "DEPLOY_URL=$DEPLOY_URL" >> deploy.env
      echo "âœ… Deployment realizado: $DEPLOY_URL"
    - |
      # Health check se URL fornecida
      if [ -n "$[[ inputs.health_check_url ]]" ]; then
        echo "ğŸ¥ Executando health check..."
        for i in {1..30}; do
          if curl -f -s --max-time 10 "$[[ inputs.health_check_url ]]" > /dev/null; then
            echo "âœ… Health check passou!"
            break
          fi
          echo "â³ Aguardando health check... ($i/30)"
          sleep 10
        done

        # Verificar se health check falhou
        if ! curl -f -s --max-time 10 "$[[ inputs.health_check_url ]]" > /dev/null; then
          echo "âŒ Health check falhou!"
          if [ "$[[ inputs.rollback_on_failure ]]" = "true" ]; then
            echo "ğŸ”„ Executando rollback..."
            npx vercel rollback --yes
            exit 1
          fi
        fi
      fi
  artifacts:
    reports:
      dotenv: deploy.env
    paths:
      - deploy.env
    expire_in: 1 month
  only:
    - main
    - develop
  except:
    variables:
      - $[[ inputs.deploy_target ]] != "vercel"

deploy-netlify:
  stage: $[[ inputs.stage ]]
  image: node:22
  environment:
    name: $[[ inputs.environment ]]
    url: $[[ inputs.health_check_url ]]
  before_script:
    - npm ci --cache .npm --prefer-offline
    - npm run build
  script:
    - echo "ğŸŒ Fazendo deployment no Netlify (ambiente: $[[ inputs.environment ]])"
    - |
      if [ "$[[ inputs.environment ]]" = "production" ]; then
        echo "ğŸ­ Deployment para produÃ§Ã£o..."
        npx netlify-cli deploy --dir=dist --prod --yes
      else
        echo "ğŸ§ª Deployment para preview..."
        npx netlify-cli deploy --dir=dist --yes
      fi
    - |
      # Health check
      if [ -n "$[[ inputs.health_check_url ]]" ]; then
        echo "ğŸ¥ Executando health check..."
        sleep 30  # Aguardar propagaÃ§Ã£o do CDN
        if curl -f -s --max-time 10 "$[[ inputs.health_check_url ]]" > /dev/null; then
          echo "âœ… Health check passou!"
        else
          echo "âŒ Health check falhou!"
          exit 1
        fi
      fi
  only:
    - main
    - develop
  except:
    variables:
      - $[[ inputs.deploy_target ]] != "netlify"

deploy-docker:
  stage: $[[ inputs.stage ]]
  image: docker:latest
  services:
    - docker:dind
  environment:
    name: $[[ inputs.environment ]]
    url: $[[ inputs.health_check_url ]]
  before_script:
    - docker info
  script:
    - echo "ğŸ³ Fazendo deployment Docker (ambiente: $[[ inputs.environment ]])"
    - |
      # Build da imagem
      DOCKER_TAG="${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}"
      docker build -t $DOCKER_TAG .
      docker push $DOCKER_TAG

      echo "âœ… Imagem Docker criada: $DOCKER_TAG"
    - |
      # Deploy baseado no ambiente
      if [ "$[[ inputs.environment ]]" = "production" ]; then
        echo "ğŸ­ Deploy para produÃ§Ã£o com Docker..."
        # Aqui seria integrado com Docker Swarm, Kubernetes, etc.
        echo "docker service update --image $DOCKER_TAG meu-servico"
      else
        echo "ğŸ§ª Deploy para staging com Docker..."
        echo "docker run -d -p 3000:3000 $DOCKER_TAG"
      fi
  only:
    - main
    - develop
  except:
    variables:
      - $[[ inputs.deploy_target ]] != "docker"

smoke-tests-post-deploy:
  stage: $[[ inputs.stage ]]
  image: node:22
  script:
    - echo "ğŸš¬ Executando smoke tests pÃ³s-deployment..."
    - |
      # Testar endpoints crÃ­ticos
      if [ -n "$[[ inputs.health_check_url ]]" ]; then
        echo "Testing health endpoint..."
        curl -f "$[[ inputs.health_check_url ]]/health" || exit 1

        echo "Testing main application..."
        curl -f "$[[ inputs.health_check_url ]]" || exit 1

        echo "âœ… Todos os smoke tests passaram!"
      else
        echo "â„¹ï¸ URL de health check nÃ£o fornecida, pulando smoke tests"
      fi
  dependencies:
    - deploy-vercel
    - deploy-netlify
    - deploy-docker
  when: manual
  allow_failure: true