# Agente GitLab - Produ√ß√£o
# Configura√ß√£o para ambiente de produ√ß√£o

name: assistente-juridico-prod
url: https://gitlab.com/
token: $AGENTE_PRODUCAO_TOKEN
executor: docker
environment: production

stages:
  - build
  - test
  - security
  - deploy-prod
  - cleanup

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Build de produ√ß√£o otimizado
build:prod:
  stage: build
  script:
    - echo "üèóÔ∏è Build de produ√ß√£o otimizado"
    - npm ci --production
    - npm run build:prod
    - npm run analyze:bundle
  artifacts:
    paths:
      - dist/
    expire_in: 1 month
  only:
    - tags
    - main

# Testes finais antes da produ√ß√£o
test:prod:
  stage: test
  script:
    - echo "üß™ Testes finais para produ√ß√£o"
    - npm run test:smoke
    - npm run test:critical-path
  allow_failure: false
  only:
    - tags
    - main

# Verifica√ß√£o de seguran√ßa final
security:final:
  stage: security
  script:
    - echo "üîí Verifica√ß√£o de seguran√ßa final"
    - npm audit --audit-level critical
    - npm run security:final-check
  allow_failure: false
  only:
    - tags

# Deploy para produ√ß√£o
deploy:prod:
  stage: deploy-prod
  script:
    - echo "üöÄ Deploy para produ√ß√£o"
    - echo "Deploying to production environment"
    - npm run deploy:prod
    - echo "Production deployment completed successfully"
  environment:
    name: production
    url: https://assistente-juridico.com
  only:
    - tags
  when: manual

# Limpeza p√≥s-deploy
cleanup:prod:
  stage: cleanup
  script:
    - echo "üßπ Limpeza p√≥s-deploy de produ√ß√£o"
    - npm run cleanup:artifacts
    - npm run cleanup:cache
  allow_failure: true
  only:
    - tags
  when: manual