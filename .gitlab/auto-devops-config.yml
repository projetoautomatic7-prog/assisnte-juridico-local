# Configura√ß√£o H√≠brida: Auto DevOps + Componentes Customizados
# Permite escolher entre pipeline autom√°tico ou customizado

# Para usar Auto DevOps padr√£o (mais simples):
# 1. Remova/comente o .gitlab-ci.yml atual
# 2. Habilite Auto DevOps no projeto
# 3. Configure as vari√°veis abaixo

# Para usar nossos componentes customizados (mais controle):
# 1. Mantenha o .gitlab-ci.yml atual
# 2. Desabilite Auto DevOps no projeto

# =============================================================================
# CONFIGURA√á√ÉO PARA AUTO DEVOPS (GitLab Nativo)
# =============================================================================

# Vari√°veis para Auto DevOps personalizado
variables:
  # Configura√ß√µes b√°sicas
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

  # Configura√ß√µes de build
  AUTO_DEVOPS_BUILD_IMAGE_CANDIDATE: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA"
  AUTO_DEVOPS_BUILD_IMAGE_TAG: "$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHA"

  # Configura√ß√µes de deploy
  AUTO_DEVOPS_DEPLOY_STRATEGY: "rolling"
  AUTO_DEVOPS_DEPLOY_DEBUG: "false"

  # Configura√ß√µes de ambiente
  STAGING_ENABLED: "1"
  PRODUCTION_ENABLED: "1"
  INCREMENTAL_ROLLOUT_ENABLED: "1"
  CANARY_ENABLED: "0"

  # Configura√ß√µes de seguran√ßa (espec√≠ficas para jur√≠dico)
  SAST_EXCLUDED_PATHS: "node_modules,dist,.git"
  SECRET_DETECTION_EXCLUDED_PATHS: ".env*,*.key,secrets/"
  DEPENDENCY_SCANNING_DISABLED: "false"

  # Configura√ß√µes de performance
  BROWSER_PERFORMANCE_DISABLED: "false"
  LOAD_PERFORMANCE_DISABLED: "false"

  # Configura√ß√µes espec√≠ficas do projeto jur√≠dico
  LEGAL_COMPLIANCE_ENABLED: "1"
  LGPD_AUDIT_ENABLED: "1"
  BACKUP_ENABLED: "1"
  NOTIFICATIONS_ENABLED: "1"

# =============================================================================
# AUTO DEVOPS WORKFLOW (GitLab Nativo)
# =============================================================================

# Este workflow s√≥ executa se Auto DevOps estiver habilitado
# e n√£o houver .gitlab-ci.yml customizado

stages:
  - build
  - test
  - deploy
  - monitor

# Build autom√°tico (detecta automaticamente React/TypeScript)
build:
  stage: build
  image: node:22-alpine
  script:
    - echo "üèóÔ∏è Auto DevOps Build para Assistente Jur√≠dico"
    - npm ci --cache .npm --prefer-offline
    - npm run build
    - echo "üì¶ Build conclu√≠do"
  artifacts:
    paths:
      - dist/
      - node_modules/
    expire_in: 1 hour
  only:
    - main
    - develop

# Testes autom√°ticos (Jest, Lighthouse, etc.)
test:
  stage: test
  image: node:22-alpine
  script:
    - echo "üß™ Auto DevOps Test Suite"
    - npm ci --cache .npm --prefer-offline
    - npm run test -- --coverage --watchAll=false
    - npm run lint
    - echo "‚úÖ Testes conclu√≠dos"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: junit-report.xml
    paths:
      - coverage/
    expire_in: 1 week
  only:
    - main
    - develop

# Deploy autom√°tico para staging
deploy_staging:
  stage: deploy
  image: google/cloud-sdk:alpine
  script:
    - echo "üöÄ Deploy autom√°tico para Staging"
    - echo "üìç Ambiente: Staging"
    - echo "üåê URL: https://staging.assistente-juridico.example.com"
    - echo "‚úÖ Deploy simulado conclu√≠do"
  environment:
    name: staging
    url: https://staging.assistente-juridico.example.com
  only:
    - develop

# Deploy autom√°tico para produ√ß√£o
deploy_production:
  stage: deploy
  image: google/cloud-sdk:alpine
  script:
    - echo "üöÄ Deploy autom√°tico para Produ√ß√£o"
    - echo "üìç Ambiente: Produ√ß√£o"
    - echo "üåê URL: https://assistente-juridico-p.vercel.app"
    - echo "‚úÖ Deploy simulado conclu√≠do"
  environment:
    name: production
    url: https://assistente-juridico-p.vercel.app
  only:
    - main
  when: manual

# =============================================================================
# EXTENS√ïES JUR√çDICAS PARA AUTO DEVOPS
# =============================================================================

# Auditoria LGPD adicional
lgpd_compliance:
  stage: test
  image: node:22-alpine
  script:
    - echo "‚öñÔ∏è Auditoria LGPD para Auto DevOps"
    - |
      # Verificar se h√° dados pessoais hardcoded
      if grep -r "CPF\|CNPJ\|RG\|telefone\|email" src/ --include="*.ts" --include="*.tsx" | grep -v "test\|mock"; then
        echo "‚ö†Ô∏è Poss√≠vel exposi√ß√£o de dados pessoais detectada"
        exit 1
      fi
      echo "‚úÖ Conformidade LGPD verificada"
  only:
    variables:
      - $LGPD_AUDIT_ENABLED == "1"

# Backup autom√°tico de dados jur√≠dicos
backup_legal_data:
  stage: monitor
  image: alpine:latest
  script:
    - echo "üíæ Backup autom√°tico de dados jur√≠dicos"
    - |
      # Simula√ß√£o de backup (em produ√ß√£o seria real)
      TIMESTAMP=$(date +%Y%m%d_%H%M%S)
      BACKUP_FILE="backup_legal_$TIMESTAMP.tar.gz"

      # Criar backup dos dados jur√≠dicos
      tar -czf "$BACKUP_FILE" \
        --exclude='node_modules' \
        --exclude='dist' \
        --exclude='.git' \
        .

      echo "üì¶ Backup criado: $BACKUP_FILE"
      echo "‚úÖ Backup conclu√≠do"
  only:
    variables:
      - $BACKUP_ENABLED == "1"
    schedules:
      - "0 2 * * 1"  # Todo domingo √†s 2h

# Notifica√ß√µes autom√°ticas
notify_deploy:
  stage: monitor
  image: alpine:latest
  script:
    - echo "üì¢ Notifica√ß√£o de deploy autom√°tico"
    - |
      echo "üöÄ Deploy conclu√≠do com sucesso!"
      echo "üìä Ambiente: $CI_ENVIRONMENT_NAME"
      echo "üè∑Ô∏è Vers√£o: $CI_COMMIT_SHA"
      echo "üë§ Autor: $GITLAB_USER_NAME"
      echo "üîó URL: $CI_ENVIRONMENT_URL"
  only:
    variables:
      - $NOTIFICATIONS_ENABLED == "1"

# =============================================================================
# CONFIGURA√á√ïES DE AMBIENTE PARA AUTO DEVOPS
# =============================================================================

# Ambiente de staging
staging:
  name: staging
  url: https://staging.assistente-juridico.example.com
  on_stop: stop_staging

# Ambiente de produ√ß√£o
production:
  name: production
  url: https://assistente-juridico-p.vercel.app
  on_stop: stop_production

# Job para parar staging
stop_staging:
  stage: deploy
  script:
    - echo "üõë Parando ambiente de staging"
  environment:
    name: staging
    action: stop
  when: manual

# Job para parar produ√ß√£o
stop_production:
  stage: deploy
  script:
    - echo "üõë Parando ambiente de produ√ß√£o"
  environment:
    name: production
    action: stop
  when: manual