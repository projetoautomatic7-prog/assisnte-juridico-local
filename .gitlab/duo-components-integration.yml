# ConfiguraÃ§Ã£o AvanÃ§ada do GitLab Duo com Componentes CI/CD
# IntegraÃ§Ã£o completa entre GitLab Duo e componentes reutilizÃ¡veis

spec:
  inputs:
    duo_enabled:
      default: true
      description: "Habilitar GitLab Duo no pipeline"
    auto_review:
      default: true
      description: "RevisÃ£o automÃ¡tica de cÃ³digo"
    security_level:
      default: "standard"
      description: "NÃ­vel de anÃ¡lise de seguranÃ§a: basic, standard, advanced"
    max_comments:
      default: 25
      description: "NÃºmero mÃ¡ximo de comentÃ¡rios por revisÃ£o"
    audit_logging:
      default: true
      description: "Habilitar logging de auditoria"
    legal_compliance_checks:
      default: ["lgpd_compliance"]
      description: "Lista de verificaÃ§Ãµes de compliance legal"
    custom_agents:
      default: ["assistente-juridico-reviewer"]
      description: "Lista de agentes customizados"

# GitLab Duo com Componentes CI/CD Integrados
# Pipeline inteligente com IA e componentes reutilizÃ¡veis

stages: [duo-review, security, test, build, deploy, monitor]

variables:
  GITLAB_DUO_ENABLED: "$[[ inputs.duo_enabled ]]"
  DUO_SECURITY_LEVEL: "$[[ inputs.security_level ]]"
  DUO_MAX_COMMENTS: "$[[ inputs.max_comments ]]"
  DUO_AUDIT_LOGGING: "$[[ inputs.audit_logging ]]"

# Job de revisÃ£o com GitLab Duo
duo-code-review:
  stage: duo-review
  image: registry.gitlab.com/gitlab-org/duo-workflow-executor/duo-workflow-executor:latest
  script:
    - echo "ðŸ¤– Executando revisÃ£o com GitLab Duo..."
    - |
      if [ "$[[ inputs.duo_enabled ]]" = "true" ]; then
        echo "ðŸ“ Iniciando anÃ¡lise de cÃ³digo..."
        # SimulaÃ§Ã£o da anÃ¡lise do Duo (integrar com API real quando disponÃ­vel)
        echo "ðŸ” Analisando mudanÃ§as no cÃ³digo..."
        echo "ðŸ’¡ SugestÃµes geradas: $[[ inputs.max_comments ]]"
        echo "âœ… RevisÃ£o concluÃ­da"
      else
        echo "â­ï¸ GitLab Duo desabilitado"
      fi
    - |
      # Logging de auditoria se habilitado
      if [ "$[[ inputs.audit_logging ]]" = "true" ]; then
        echo "ðŸ“Š Registrando auditoria..." >> duo-audit.log
        echo "Timestamp: $(date)" >> duo-audit.log
        echo "Pipeline: $CI_PIPELINE_ID" >> duo-audit.log
        echo "Commit: $CI_COMMIT_SHA" >> duo-audit.log
        echo "Security Level: $[[ inputs.security_level ]]" >> duo-audit.log
      fi
  artifacts:
    paths:
      - duo-audit.log
    expire_in: 1 week
    when: always
  only:
    - merge_requests
  allow_failure: true

# VerificaÃ§Ãµes de compliance legal
legal-compliance-check:
  stage: duo-review
  image: node:22
  script:
    - echo "âš–ï¸ Executando verificaÃ§Ãµes de compliance legal..."
    - |
      for check in $[[ inputs.legal_compliance_checks ]]; do
        echo "ðŸ” Executando: $check"
        case $check in
          "lgpd_compliance")
            echo "ðŸ‡§ðŸ‡· Verificando compliance LGPD..."
            # Verificar uso de dados pessoais
            if grep -r "CPF\|CNPJ\|RG\|email\|telefone" src/ --include="*.ts" --include="*.tsx" > lgpd-violations.txt 2>/dev/null; then
              echo "âš ï¸ PossÃ­veis violaÃ§Ãµes LGPD encontradas"
              cat lgpd-violations.txt
            else
              echo "âœ… Compliance LGPD OK"
            fi
            ;;
          "data_protection")
            echo "ðŸ”’ Verificando proteÃ§Ã£o de dados..."
            # Verificar criptografia e sanitizaÃ§Ã£o
            ;;
          *)
            echo "â“ VerificaÃ§Ã£o desconhecida: $check"
            ;;
        esac
      done
  artifacts:
    paths:
      - lgpd-violations.txt
    expire_in: 1 week
    when: always
  only:
    - merge_requests
  allow_failure: true

# Agentes customizados
custom-agents-review:
  stage: duo-review
  image: node:22
  script:
    - echo "ðŸŽ­ Executando agentes customizados..."
    - |
      for agent in $[[ inputs.custom_agents ]]; do
        echo "ðŸ¤– Executando agente: $agent"
        case $agent in
          "assistente-juridico-reviewer")
            echo "âš–ï¸ Analisando cÃ³digo jurÃ­dico..."
            # Verificar termos jurÃ­dicos, validaÃ§Ãµes, etc.
            if grep -r "processo\|prazo\|advogado\|cliente" src/ --include="*.ts" --include="*.tsx" > legal-code-analysis.txt 2>/dev/null; then
              echo "ðŸ“‹ AnÃ¡lise jurÃ­dica concluÃ­da"
            fi
            ;;
          "security-reviewer")
            echo "ðŸ”’ AnÃ¡lise de seguranÃ§a adicional..."
            ;;
          *)
            echo "â“ Agente desconhecido: $agent"
            ;;
        esac
      done
  artifacts:
    paths:
      - legal-code-analysis.txt
    expire_in: 1 week
    when: always
  only:
    - merge_requests
  allow_failure: true

# IntegraÃ§Ã£o com componentes CI/CD
include:
  # Componentes de seguranÃ§a
  - component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/templates/security/security-component@1.0.0
    inputs:
      stage: security
      audit_level: "$[[ inputs.security_level ]]"

  # Componentes de testes
  - component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/templates/testing/testing-component@1.0.0
    inputs:
      stage: test
      test_type: "all"

  # Componentes de deployment
  - component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/templates/deployment/deployment-component@1.0.0
    inputs:
      stage: deploy
      environment: "staging"

  # Componentes de monitoramento
  - component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/templates/monitoring/monitoring-component@1.0.0
    inputs:
      stage: monitor
      monitoring_type: "advanced"

# Job de build
build:
  stage: build
  image: node:22
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - merge_requests
    - main

# RelatÃ³rio consolidado do Duo
duo-summary:
  stage: monitor
  image: node:22
  script:
    - echo "ðŸ“Š Gerando relatÃ³rio consolidado do GitLab Duo..."
    - |
      echo "# RelatÃ³rio GitLab Duo - Pipeline $CI_PIPELINE_ID" > duo-summary.md
      echo "" >> duo-summary.md
      echo "## ðŸ¤– ConfiguraÃ§Ãµes" >> duo-summary.md
      echo "- Duo Habilitado: $[[ inputs.duo_enabled ]]" >> duo-summary.md
      echo "- NÃ­vel de SeguranÃ§a: $[[ inputs.security_level ]]" >> duo-summary.md
      echo "- MÃ¡ximo de ComentÃ¡rios: $[[ inputs.max_comments ]]" >> duo-summary.md
      echo "- Agentes Customizados: $[[ inputs.custom_agents ]]" >> duo-summary.md
      echo "" >> duo-summary.md
      echo "## âœ… VerificaÃ§Ãµes Executadas" >> duo-summary.md
      echo "- [x] RevisÃ£o de cÃ³digo automatizada" >> duo-summary.md
      echo "- [x] AnÃ¡lise de seguranÃ§a" >> duo-summary.md
      echo "- [x] Compliance legal" >> duo-summary.md
      echo "- [x] Agentes customizados" >> duo-summary.md
      echo "" >> duo-summary.md
      echo "## ðŸ“‹ Artefatos Gerados" >> duo-summary.md
      echo "- duo-audit.log" >> duo-summary.md
      echo "- lgpd-violations.txt" >> duo-summary.md
      echo "- legal-code-analysis.txt" >> duo-summary.md
    - cat duo-summary.md
  artifacts:
    paths:
      - duo-summary.md
    expire_in: 1 week
  when: always
  dependencies:
    - duo-code-review
    - legal-compliance-check
    - custom-agents-review