# ?? CHECKLIST DIÁRIO AUTOMÁTICO - Assistente Jurídico PJe
# Executa verificações obrigatórias do sistema em produção
# Uso: .\scripts\daily-check.ps1

$ErrorActionPreference = "Continue"

# Cores
function Write-Pass { param($msg) Write-Host "? $msg" -ForegroundColor Green }
function Write-Fail { param($msg) Write-Host "? $msg" -ForegroundColor Red }
function Write-Warn { param($msg) Write-Host "? $msg" -ForegroundColor Yellow }
function Write-Info { param($msg) Write-Host "? $msg" -ForegroundColor Cyan }

# Contadores
$script:Passed = 0
$script:Failed = 0
$script:Warnings = 0

# Funções de contagem
function Pass { param($msg) Write-Pass $msg; $script:Passed++ }
function Fail { param($msg) Write-Fail $msg; $script:Failed++ }
function Warn { param($msg) Write-Warn $msg; $script:Warnings++ }

# Cabeçalho
$timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host "  ?? CHECKLIST DIÁRIO OBRIGATÓRIO - $timestamp" -ForegroundColor White
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host ""

# 1. Health Check
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host "  1??  HEALTH CHECK DO SISTEMA (2 min)" -ForegroundColor White
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host ""

Write-Info "Verificando /api/health..."
try {
    $response = Invoke-RestMethod -Uri "https://assistente-juridico-p.vercel.app/api/health" -Method Get -TimeoutSec 5
    if ($response.status -eq "ok") {
        Pass "API Health: OK"
    } else {
        Fail "API Health: Resposta inválida"
        Write-Host "   Resposta: $($response | ConvertTo-Json)"
    }
} catch {
    Fail "API Health: FALHOU"
    Write-Host "   Erro: $($_.Exception.Message)"
    Write-Host "   Verifique: https://vercel.com/thiagobodevan-a11y/assistente-juridico-p/logs"
}

# 2. Sentry
Write-Host ""
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host "  2??  VERIFICAR ERROS SENTRY (3 min)" -ForegroundColor White
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host ""

Write-Info "Acessar manualmente: https://sentry.io/organizations/thiagobodevan-a11y/issues/"
Write-Info "Filtrar: is:unresolved, last 24h"
Warn "META: 0 erros críticos, < 5 erros médios (verificação manual)"

# 3. Type Check
Write-Host ""
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host "  3??  TYPE CHECK (1 min)" -ForegroundColor White
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host ""

$typeCheckOutput = npm run type-check 2>&1 | Out-String
if ($typeCheckOutput -match "0 errors") {
    Pass "Type Check: SEM ERROS"
} else {
    if ($typeCheckOutput -match "(\d+) error") {
        Fail "Type Check: $($Matches[1]) ERROS ENCONTRADOS"
    } else {
        Fail "Type Check: ERROS ENCONTRADOS"
    }
    Write-Host "   Execute: npm run type-check"
}

# 4. Lint
Write-Host ""
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host "  4??  LINT (1 min)" -ForegroundColor White
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host ""

$lintOutput = npm run lint 2>&1 | Out-String
$errorCount = if ($lintOutput -match "(\d+) error") { [int]$Matches[1] } else { 0 }
$warningCount = if ($lintOutput -match "(\d+) warning") { [int]$Matches[1] } else { 0 }

if ($errorCount -eq 0) {
    if ($warningCount -le 150) {
        Pass "Lint: $errorCount erros, $warningCount warnings (OK)"
    } else {
        Warn "Lint: $errorCount erros, $warningCount warnings (ACIMA DO LIMITE: 150)"
    }
} else {
    Fail "Lint: $errorCount ERROS, $warningCount warnings"
    Write-Host "   Execute: npm run lint:fix"
}

# 5. Testes
Write-Host ""
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host "  5??  TESTES UNITÁRIOS (2 min)" -ForegroundColor White
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host ""

$testOutput = npm run test:run 2>&1 | Out-String
if ($testOutput -match "Test Files\s+(\d+)\s+passed") {
    $testFiles = $Matches[1]
    if ($testOutput -match "Tests\s+(\d+)\s+passed") {
        $tests = $Matches[1]
        Pass "Testes: $testFiles arquivos, $tests testes PASSARAM"
    } else {
        Pass "Testes: $testFiles arquivos PASSARAM"
    }
} else {
    Fail "Testes: FALHARAM"
    Write-Host "   Execute: npm run test:run"
}

# 6. Build
Write-Host ""
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host "  6??  BUILD DE PRODUÇÃO (3 min)" -ForegroundColor White
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host ""

$buildOutput = npm run build 2>&1 | Out-String
if ($buildOutput -match "built in ([\d.]+s)") {
    $buildTime = $Matches[1]
    Pass "Build: SUCESSO em $buildTime"
} else {
    Fail "Build: FALHOU"
    Write-Host "   Execute: npm run build"
}

# 7. Métricas Vercel
Write-Host ""
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host "  7??  MÉTRICAS VERCEL (2 min)" -ForegroundColor White
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host ""

Write-Info "Acessar: https://vercel.com/thiagobodevan-a11y/assistente-juridico-p/analytics"
Warn "META: LCP < 2.5s, Error Rate < 1% (verificação manual)"

# 8. Recursos
Write-Host ""
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host "  8??  RECURSOS (2 min)" -ForegroundColor White
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host ""

Write-Info "Upstash Redis: https://console.upstash.com/redis/"
Warn "META: < 90% memória (verificação manual)"

Write-Info "Qdrant Cloud: https://cloud.qdrant.io/clusters"
Warn "META: < 900MB storage (verificação manual)"

Write-Info "Gemini API: https://aistudio.google.com/app/apikey"
Warn "META: < 80% quota diária (verificação manual)"

# Resumo
Write-Host ""
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host "  ?? RESUMO DO CHECKLIST" -ForegroundColor White
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor White
Write-Host ""

Write-Host "  " -NoNewline
Write-Pass "Passou:     $($script:Passed) checks"
Write-Host "  " -NoNewline
Write-Fail "Falhou:     $($script:Failed) checks"
Write-Host "  " -NoNewline
Write-Warn "Warnings:   $($script:Warnings) checks"
Write-Host ""

# Status final
if ($script:Failed -eq 0) {
    Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor Green
    Write-Host "  ? CHECKLIST DIÁRIO: SUCESSO" -ForegroundColor Green
    Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor Green
    exit 0
} else {
    Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor Red
    Write-Host "  ? CHECKLIST DIÁRIO: FALHAS DETECTADAS" -ForegroundColor Red
    Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor Red
    Write-Host ""
    Write-Host "  Ações recomendadas:" -ForegroundColor Yellow
    Write-Host "  1. Revisar logs acima"
    Write-Host "  2. Criar issue no GitHub com label 'daily-check-failure'"
    Write-Host "  3. Se crítico, notificar tech lead"
    Write-Host "  4. Consultar: docs/RUNBOOK.md"
    Write-Host ""
    exit 1
}
