#!/bin/bash

# ?? VALIDAÇÃO DE INSTRUÇÕES DO COPILOT
# Verifica se as instruções estão configuradas corretamente

set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "????????????????????????????????????????????????????????????"
echo "  ?? VALIDAÇÃO DE INSTRUÇÕES DO GITHUB COPILOT"
echo "????????????????????????????????????????????????????????????"
echo ""

PASSED=0
FAILED=0

# Função para reportar sucesso
pass() {
    echo -e "${GREEN}?${NC} $1"
    ((PASSED++))
}

# Função para reportar falha
fail() {
    echo -e "${RED}?${NC} $1"
    ((FAILED++))
}

# Função para info
info() {
    echo -e "${BLUE}?${NC} $1"
}

# 1. Verificar arquivo de instruções
echo "????????????????????????????????????????????????????????????"
echo "  1??  ARQUIVO DE INSTRUÇÕES"
echo "????????????????????????????????????????????????????????????"
echo ""

if [ -f ".github/copilot-instructions.md" ]; then
    pass "Arquivo .github/copilot-instructions.md existe"
    
    # Verificar tamanho
    SIZE=$(stat -f%z ".github/copilot-instructions.md" 2>/dev/null || stat -c%s ".github/copilot-instructions.md" 2>/dev/null)
    SIZE_KB=$((SIZE / 1024))
    
    if [ $SIZE_KB -lt 100 ]; then
        pass "Tamanho do arquivo: ${SIZE_KB}KB (ideal < 100KB)"
    elif [ $SIZE_KB -lt 200 ]; then
        info "Tamanho do arquivo: ${SIZE_KB}KB (aceitável < 200KB)"
    else
        fail "Tamanho do arquivo: ${SIZE_KB}KB (muito grande! > 200KB)"
        info "Considere dividir em múltiplos arquivos"
    fi
else
    fail "Arquivo .github/copilot-instructions.md NÃO ENCONTRADO"
    echo "   Crie o arquivo com: touch .github/copilot-instructions.md"
fi

# 2. Verificar front matter
echo ""
echo "????????????????????????????????????????????????????????????"
echo "  2??  FRONT MATTER YAML"
echo "????????????????????????????????????????????????????????????"
echo ""

if [ -f ".github/copilot-instructions.md" ]; then
    FRONT_MATTER=$(head -n 3 .github/copilot-instructions.md)
    
    if echo "$FRONT_MATTER" | grep -q "^---$"; then
        pass "Front matter YAML presente"
        
        if echo "$FRONT_MATTER" | grep -q 'applyTo:.*"\*\*"'; then
            pass "applyTo: \"**\" configurado (aplica a todos arquivos)"
        elif echo "$FRONT_MATTER" | grep -q 'applyTo:'; then
            info "applyTo configurado com filtro específico"
            echo "   Valor: $(grep applyTo .github/copilot-instructions.md | head -1)"
        else
            fail "applyTo NÃO encontrado no front matter"
            echo "   Adicione: applyTo: \"**\""
        fi
    else
        fail "Front matter YAML ausente"
        echo "   Adicione no início do arquivo:"
        echo "   ---"
        echo "   applyTo: \"**\""
        echo "   ---"
    fi
fi

# 3. Verificar .vscode/settings.json
echo ""
echo "????????????????????????????????????????????????????????????"
echo "  3??  CONFIGURAÇÃO DO VS CODE"
echo "????????????????????????????????????????????????????????????"
echo ""

if [ -f ".vscode/settings.json" ]; then
    pass "Arquivo .vscode/settings.json existe"
    
    if grep -q '"github.copilot.chat.useInstructionFiles".*true' .vscode/settings.json; then
        pass "github.copilot.chat.useInstructionFiles: true"
    else
        fail "github.copilot.chat.useInstructionFiles NÃO ATIVADO"
        echo "   Adicione em .vscode/settings.json:"
        echo "   \"github.copilot.chat.useInstructionFiles\": true"
    fi
    
    if grep -q '"github.copilot.chat.codeGeneration.instructions"' .vscode/settings.json; then
        pass "Instruções contextuais de geração configuradas"
    else
        info "Instruções contextuais de geração NÃO configuradas (opcional)"
    fi
else
    fail "Arquivo .vscode/settings.json NÃO ENCONTRADO"
    echo "   Crie o arquivo e adicione:"
    echo "   {"
    echo "     \"github.copilot.chat.useInstructionFiles\": true"
    echo "   }"
fi

# 4. Verificar conteúdo das instruções
echo ""
echo "????????????????????????????????????????????????????????????"
echo "  4??  CONTEÚDO DAS INSTRUÇÕES"
echo "????????????????????????????????????????????????????????????"
echo ""

if [ -f ".github/copilot-instructions.md" ]; then
    # Verificar seções importantes
    if grep -q "MODO MANUTENÇÃO" .github/copilot-instructions.md; then
        pass "Seção 'MODO MANUTENÇÃO' presente"
    else
        info "Seção 'MODO MANUTENÇÃO' não encontrada (opcional)"
    fi
    
    if grep -q "Sistema de.*Agentes" .github/copilot-instructions.md; then
        pass "Seção 'Sistema de Agentes' presente"
    else
        info "Seção 'Sistema de Agentes' não encontrada (opcional)"
    fi
    
    if grep -q "Referências" .github/copilot-instructions.md; then
        pass "Seção 'Referências' presente"
    else
        info "Seção 'Referências' não encontrada (opcional)"
    fi
    
    # Verificar se tem comandos úteis
    if grep -q "npm run" .github/copilot-instructions.md; then
        pass "Comandos npm documentados"
    else
        info "Comandos npm não documentados (recomendado adicionar)"
    fi
fi

# 5. Verificar extensões do VS Code (se code CLI disponível)
echo ""
echo "????????????????????????????????????????????????????????????"
echo "  5??  EXTENSÕES DO VS CODE"
echo "????????????????????????????????????????????????????????????"
echo ""

if command -v code &> /dev/null; then
    if code --list-extensions | grep -q "GitHub.copilot"; then
        pass "Extensão GitHub.copilot instalada"
    else
        fail "Extensão GitHub.copilot NÃO INSTALADA"
        echo "   Instale com: code --install-extension GitHub.copilot"
    fi
    
    if code --list-extensions | grep -q "GitHub.copilot-chat"; then
        pass "Extensão GitHub.copilot-chat instalada"
    else
        fail "Extensão GitHub.copilot-chat NÃO INSTALADA"
        echo "   Instale com: code --install-extension GitHub.copilot-chat"
    fi
else
    info "VS Code CLI não disponível (pule esta verificação)"
fi

# Resumo
echo ""
echo "????????????????????????????????????????????????????????????"
echo "  ?? RESUMO DA VALIDAÇÃO"
echo "????????????????????????????????????????????????????????????"
echo ""

echo -e "  ${GREEN}? Passou:${NC}     $PASSED checks"
echo -e "  ${RED}? Falhou:${NC}     $FAILED checks"
echo ""

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}????????????????????????????????????????????????????????????${NC}"
    echo -e "${GREEN}  ? CONFIGURAÇÃO COMPLETA E CORRETA!${NC}"
    echo -e "${GREEN}????????????????????????????????????????????????????????????${NC}"
    echo ""
    echo "  Próximos passos:"
    echo "  1. Abra o VS Code"
    echo "  2. Reinicie o Copilot: Ctrl+Shift+P ? GitHub Copilot: Restart Language Server"
    echo "  3. Teste no chat: @workspace Qual é o modo atual do projeto?"
    echo ""
    exit 0
else
    echo -e "${RED}????????????????????????????????????????????????????????????${NC}"
    echo -e "${RED}  ? CONFIGURAÇÃO INCOMPLETA${NC}"
    echo -e "${RED}????????????????????????????????????????????????????????????${NC}"
    echo ""
    echo "  Corrija os itens marcados com ? acima"
    echo "  Consulte: docs/COPILOT_INSTRUCTIONS_SETUP.md"
    echo ""
    exit 1
fi
