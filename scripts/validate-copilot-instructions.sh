#!/bin/bash

# ?? VALIDA��O DE INSTRU��ES DO COPILOT
# Verifica se as instru��es est�o configuradas corretamente
# Regra absoluta de ética do app e do codificador, copilot etc: esta proibido usar qualquer tipo de simulação: Stub, Mock, Synthetic Data, Fake, Dummy, Test Doubles, no app em desenvolvimento e em produção, sendo permitido somente testes reais.
set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "????????????????????????????????????????????????????????????"
echo "  ?? VALIDA��O DE INSTRU��ES DO GITHUB COPILOT"
echo "????????????????????????????????????????????????????????????"
echo ""

PASSED=0
FAILED=0

# Fun��o para reportar sucesso
pass() {
    echo -e "${GREEN}?${NC} $1"
    ((PASSED+=1))
}

# Fun��o para reportar falha
fail() {
    echo -e "${RED}?${NC} $1"
    ((FAILED+=1))
}

# Fun��o para info
info() {
    echo -e "${BLUE}?${NC} $1"
}

# 1. Verificar arquivo de instru��es
echo "????????????????????????????????????????????????????????????"
echo "  1??  ARQUIVO DE INSTRU��ES"
echo "????????????????????????????????????????????????????????????"
echo ""

if [ -f ".github/copilot-instructions.md" ]; then
    pass "Arquivo .github/copilot-instructions.md existe"

    # Verificar tamanho
    SIZE=$( (stat -c%s ".github/copilot-instructions.md" 2>/dev/null || stat -f%z ".github/copilot-instructions.md" 2>/dev/null) || true )
    if [ -z "$SIZE" ]; then
        SIZE=0
    fi
    SIZE_KB=$((SIZE / 1024))

    if [ $SIZE_KB -lt 100 ]; then
        pass "Tamanho do arquivo: ${SIZE_KB}KB (ideal < 100KB)"
    elif [ $SIZE_KB -lt 200 ]; then
        info "Tamanho do arquivo: ${SIZE_KB}KB (aceit�vel < 200KB)"
    else
        fail "Tamanho do arquivo: ${SIZE_KB}KB (muito grande! > 200KB)"
        info "Considere dividir em m�ltiplos arquivos"
    fi
else
    fail "Arquivo .github/copilot-instructions.md N�O ENCONTRADO"
    echo "   Crie o arquivo com: touch .github/copilot-instructions.md"
fi

# 2. Verificar front matter
echo ""
echo "????????????????????????????????????????????????????????????"
echo "  2??  FRONT MATTER YAML"
echo "????????????????????????????????????????????????????????????"
echo ""

if [ -f ".github/copilot-instructions.md" ]; then
    FRONT_MATTER=$(head -n 3 .github/copilot-instructions.md)

    if echo "$FRONT_MATTER" | grep -q "^---$"; then
        pass "Front matter YAML presente"

        if echo "$FRONT_MATTER" | grep -q 'applyTo:.*"\*\*"'; then
            pass "applyTo: \"**\" configurado (aplica a todos arquivos)"
        elif echo "$FRONT_MATTER" | grep -q 'applyTo:'; then
            info "applyTo configurado com filtro espec�fico"
            echo "   Valor: $(grep applyTo .github/copilot-instructions.md | head -1)"
        else
            fail "applyTo N�O encontrado no front matter"
            echo "   Adicione: applyTo: \"**\""
        fi
    else
        fail "Front matter YAML ausente"
        echo "   Adicione no in�cio do arquivo:"
        echo "   ---"
        echo "   applyTo: \"**\""
        echo "   ---"
    fi
fi

# 3. Verificar .vscode/settings.json
echo ""
echo "????????????????????????????????????????????????????????????"
echo "  3??  CONFIGURA��O DO VS CODE"
echo "????????????????????????????????????????????????????????????"
echo ""

if [ -f ".vscode/settings.json" ]; then
    pass "Arquivo .vscode/settings.json existe"

    if grep -q '"github.copilot.chat.useInstructionFiles".*true' .vscode/settings.json; then
        pass "github.copilot.chat.useInstructionFiles: true"
    else
        fail "github.copilot.chat.useInstructionFiles N�O ATIVADO"
        echo "   Adicione em .vscode/settings.json:"
        echo "   \"github.copilot.chat.useInstructionFiles\": true"
    fi

    if grep -q '"github.copilot.chat.codeGeneration.instructions"' .vscode/settings.json; then
        pass "Instru��es contextuais de gera��o configuradas"
    else
        info "Instru��es contextuais de gera��o N�O configuradas (opcional)"
    fi
else
    fail "Arquivo .vscode/settings.json N�O ENCONTRADO"
    echo "   Crie o arquivo e adicione:"
    echo "   {"
    echo "     \"github.copilot.chat.useInstructionFiles\": true"
    echo "   }"
fi

# 4. Verificar conte�do das instru��es
echo ""
echo "????????????????????????????????????????????????????????????"
echo "  4??  CONTE�DO DAS INSTRU��ES"
echo "????????????????????????????????????????????????????????????"
echo ""

if [ -f ".github/copilot-instructions.md" ]; then
    # Verificar se��es importantes
    if grep -q "MODO MANUTEN��O" .github/copilot-instructions.md; then
        pass "Se��o 'MODO MANUTEN��O' presente"
    else
        info "Se��o 'MODO MANUTEN��O' n�o encontrada (opcional)"
    fi

    if grep -q "Sistema de.*Agentes" .github/copilot-instructions.md; then
        pass "Se��o 'Sistema de Agentes' presente"
    else
        info "Se��o 'Sistema de Agentes' n�o encontrada (opcional)"
    fi

    if grep -q "Refer�ncias" .github/copilot-instructions.md; then
        pass "Se��o 'Refer�ncias' presente"
    else
        info "Se��o 'Refer�ncias' n�o encontrada (opcional)"
    fi

    # Verificar se tem comandos �teis
    if grep -q "npm run" .github/copilot-instructions.md; then
        pass "Comandos npm documentados"
    else
        info "Comandos npm n�o documentados (recomendado adicionar)"
    fi
fi

# 5. Verificar extens�es do VS Code (se code CLI dispon�vel)
echo ""
echo "????????????????????????????????????????????????????????????"
echo "  5??  EXTENS�ES DO VS CODE"
echo "????????????????????????????????????????????????????????????"
echo ""

if command -v code &> /dev/null; then
    if code --list-extensions | grep -q "GitHub.copilot"; then
        pass "Extens�o GitHub.copilot instalada"
    else
        info "Extens�o GitHub.copilot N�O instalada (verifique no seu VS Code local/codespace)"
        echo "   Instale com: code --install-extension GitHub.copilot"
    fi

    if code --list-extensions | grep -q "GitHub.copilot-chat"; then
        pass "Extens�o GitHub.copilot-chat instalada"
    else
        info "Extens�o GitHub.copilot-chat N�O instalada (verifique no seu VS Code local/codespace)"
        echo "   Instale com: code --install-extension GitHub.copilot-chat"
    fi
else
    info "VS Code CLI n�o dispon�vel (pule esta verifica��o)"
fi

# Resumo
echo ""
echo "????????????????????????????????????????????????????????????"
echo "  ?? RESUMO DA VALIDA��O"
echo "????????????????????????????????????????????????????????????"
echo ""

echo -e "  ${GREEN}? Passou:${NC}     $PASSED checks"
echo -e "  ${RED}? Falhou:${NC}     $FAILED checks"
echo ""

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}????????????????????????????????????????????????????????????${NC}"
    echo -e "${GREEN}  ? CONFIGURA��O COMPLETA E CORRETA!${NC}"
    echo -e "${GREEN}????????????????????????????????????????????????????????????${NC}"
    echo ""
    echo "  Pr�ximos passos:"
    echo "  1. Abra o VS Code"
    echo "  2. Reinicie o Copilot: Ctrl+Shift+P ? GitHub Copilot: Restart Language Server"
    echo "  3. Teste no chat: @workspace Qual � o modo atual do projeto?"
    echo ""
    exit 0
else
    echo -e "${RED}????????????????????????????????????????????????????????????${NC}"
    echo -e "${RED}  ? CONFIGURA��O INCOMPLETA${NC}"
    echo -e "${RED}????????????????????????????????????????????????????????????${NC}"
    echo ""
    echo "  Corrija os itens marcados com ? acima"
    echo "  Consulte: docs/COPILOT_INSTRUCTIONS_SETUP.md"
    echo ""
    exit 1
fi
