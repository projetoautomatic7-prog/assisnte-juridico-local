# Configura√ß√£o espec√≠fica para GitLab SAST
# Resolve o erro "No valid project detected"

# Este arquivo √© inclu√≠do automaticamente pelo template SAST.gitlab-ci.yml
# quando o projeto √© detectado como Node.js/TypeScript

# Configura√ß√µes espec√≠ficas para projetos React/TypeScript
variables:
  SAST_NODEJS_VERSION: "22"
  SAST_EXCLUDED_PATHS: "node_modules/**,dist/**,.git/**,coverage/**"
  SAST_ANALYZER_IMAGE_TAG: "5"

# Job de SAST customizado (opcional - complementa o SAST padr√£o)
sast-custom-scan:
  stage: security
  image: node:${SAST_NODEJS_VERSION}
  script:
    - echo "üîç Executando verifica√ß√µes de seguran√ßa customizadas..."
    - npm ci --cache .npm --prefer-offline
    - |
      # Verificar vulnerabilidades de seguran√ßa no c√≥digo fonte
      echo "Verificando c√≥digo perigoso..."
      DANGEROUS_CODE=$(grep -r "eval(\|innerHTML\|document\.write\|dangerouslySetInnerHTML" src/ --include="*.ts" --include="*.tsx" | grep -v node_modules | wc -l)
      if [ "$DANGEROUS_CODE" -gt "0" ]; then
        echo "‚ö†Ô∏è C√≥digo potencialmente perigoso detectado: $DANGEROUS_CODE ocorr√™ncias"
        grep -r "eval(\|innerHTML\|document\.write\|dangerouslySetInnerHTML" src/ --include="*.ts" --include="*.tsx" | grep -v node_modules
      else
        echo "‚úÖ Nenhum c√≥digo perigoso detectado"
      fi
    - |
      # Verificar depend√™ncias vulner√°veis
      echo "Verificando depend√™ncias..."
      npm audit --audit-level=moderate --json > npm-audit-results.json || true
      VULNERABILITIES=$(jq '.metadata.vulnerabilities.total' npm-audit-results.json 2>/dev/null || echo "0")
      if [ "$VULNERABILITIES" -gt "0" ]; then
        echo "‚ö†Ô∏è Vulnerabilidades detectadas: $VULNERABILITIES"
        jq '.metadata.vulnerabilities' npm-audit-results.json
      else
        echo "‚úÖ Nenhuma vulnerabilidade cr√≠tica detectada"
      fi
  artifacts:
    reports:
      sast: sast-custom-report.json
    paths:
      - npm-audit-results.json
      - sast-custom-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop
