#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SCRIPT DE DEMONSTRAรรO: WORKFLOW PROFISSIONAL COM GITLAB
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Este script demonstra como usar o GitLab para desenvolvimento profissional
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${CYAN}"
cat << "EOF"
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ DEMONSTRAรรO: WORKFLOW PROFISSIONAL COM GITLAB
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
EOF
echo -e "${NC}"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 1. CRIAR FEATURE BRANCH
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐ PASSO 1: Criar Feature Branch${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"

read -p "Digite o nome da feature (ex: busca-avancada): " FEATURE_NAME

if [[ -z "$FEATURE_NAME" ]]; then
    FEATURE_NAME="demo-feature"
fi

BRANCH_NAME="feature/${FEATURE_NAME}"

echo -e "${YELLOW}Criando branch: ${BRANCH_NAME}${NC}"
git checkout -b "$BRANCH_NAME" 2>/dev/null || git checkout "$BRANCH_NAME"

echo -e "${GREEN}โ Branch criada/selecionada: ${BRANCH_NAME}${NC}\n"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 2. FAZER MUDANรAS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}โ๏ธ  PASSO 2: Fazer Alteraรงรตes${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"

# Criar arquivo de exemplo
mkdir -p src/features
cat > "src/features/${FEATURE_NAME}.ts" << 'TYPESCRIPT'
/**
 * Nova feature implementada
 * @example
 * const result = newFeature();
 */
export function newFeature(): string {
  return 'Feature implementada com sucesso!';
}

export default newFeature;
TYPESCRIPT

echo -e "${GREEN}โ Arquivo criado: src/features/${FEATURE_NAME}.ts${NC}\n"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 3. COMMIT COM CONVENTIONAL COMMITS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐พ PASSO 3: Commit (Conventional Commits)${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"

git add .

echo -e "${YELLOW}Tipos de commit:${NC}"
echo "  feat:     Nova funcionalidade"
echo "  fix:      Correรงรฃo de bug"
echo "  docs:     Documentaรงรฃo"
echo "  style:    Formataรงรฃo"
echo "  refactor: Refatoraรงรฃo"
echo "  test:     Testes"
echo "  chore:    Manutenรงรฃo"
echo ""

read -p "Tipo do commit (feat/fix/docs/etc): " COMMIT_TYPE
if [[ -z "$COMMIT_TYPE" ]]; then
    COMMIT_TYPE="feat"
fi

read -p "Descriรงรฃo do commit: " COMMIT_MSG
if [[ -z "$COMMIT_MSG" ]]; then
    COMMIT_MSG="adicionar ${FEATURE_NAME}"
fi

FULL_COMMIT="${COMMIT_TYPE}: ${COMMIT_MSG}"

git commit -m "$FULL_COMMIT"

echo -e "${GREEN}โ Commit criado: ${FULL_COMMIT}${NC}\n"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 4. PUSH E CRIAR MERGE REQUEST
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐ค PASSO 4: Push e Criar Merge Request${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"

echo -e "${YELLOW}Fazendo push da branch...${NC}"
git push -u origin "$BRANCH_NAME"

echo -e "${GREEN}โ Push completo!${NC}\n"

# Obter URL do projeto
PROJECT_URL=$(git remote get-url origin | sed 's/\.git$//')

echo -e "${CYAN}"
cat << EOF
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ PRรXIMOS PASSOS
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1๏ธโฃ  Abrir Merge Request no GitLab:
   ${PROJECT_URL}/-/merge_requests/new?merge_request[source_branch]=${BRANCH_NAME}

2๏ธโฃ  O GitLab automaticamente irรก:
   โ Rodar todos os testes
   โ Verificar qualidade do cรณdigo
   โ Fazer security scan
   โ Mostrar diff visual

3๏ธโฃ  Apรณs aprovaรงรฃo do review:
   โ Merge para main
   โ Deploy automรกtico para staging
   โ Notificaรงรตes enviadas

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ TEMPLATE DO MERGE REQUEST
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

O template jรก estรก configurado em:
.gitlab/merge_request_templates/default.md

Ao abrir o MR, vocรช verรก um checklist completo!

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ WORKFLOW COMPLETO
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Developer              GitLab CI/CD           Reviewers
    โ                        โ                     โ
    โโ Create branch         โ                     โ
    โโ Make changes          โ                     โ
    โโ Commit & push โโโโโโโ>โ                     โ
    โ                        โโ Run tests          โ
    โ                        โโ Build app          โ
    โ                        โโ Security scan      โ
    โ                        โโ Create MR โโโโโโโโ>โ
    โ                        โ                     โโ Code review
    โ                        โ                     โโ Approve
    โ                        โ<โโโโโโโโโโโโโโโโโโโโโ
    โ                        โโ Merge to main
    โ                        โโ Deploy staging
    โ                        โโ Notify team โโโโโโ>โ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

EOF
echo -e "${NC}"

echo -e "${PURPLE}๐ก Dica: Use 'git log --oneline --graph' para ver o histรณrico${NC}\n"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 5. OPรรES ADICIONAIS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${YELLOW}Deseja voltar para a branch main? (y/n)${NC}"
read -r RESPONSE

if [[ "$RESPONSE" =~ ^[Yy]$ ]]; then
    git checkout main
    echo -e "${GREEN}โ Voltou para branch main${NC}"
fi

echo -e "\n${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โจ Workflow demo completo!${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
